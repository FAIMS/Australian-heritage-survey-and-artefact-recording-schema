/*
 * GENERATED WITH FAIMS-TOOLS, SHA1: 0464ffa4896c3c209cd6552656235739c87ceee7
 */
import android.util.Log;
import android.os.Build.MODEL;
import java.util.concurrent.atomic.AtomicInteger;
import android.database.DatabaseUtils;
import java.util.concurrent.Callable;

// Beanshell won't let me write "\0".
final String SEP = Character.toString ((char) 0);

final String MSG_LOADING = "Loading...";

final String USER_MENU_PATH = "User_List/User_List/User_List";
userMenuPath = USER_MENU_PATH; // Depricated. Use `USER_MENU_PATH` instead

final long SESS_START_TIME = System.currentTimeMillis();

Object dialog;          // Used to help coordinate the display of a "busy..." dialog
String parentTabgroup;  // Used to allow entities to be saved as children
String parentTabgroup__;// The tab group which was previously displayed
String redirectTab;     // makes newTab work as expected
String username = "";
String userId   = "";
List   autoSaveGeo = null;
List   autoSaveAttrs = null;

setFileSyncEnabled(true);
setSyncDelay(5.0f);
setSyncEnabled(true);
setSyncMaxInterval(600.0f);
setSyncMinInterval(5.0f);

if (isNull(USER_MENU_PATH)) {
  Log.w("", "`USER_MENU_PATH` is empty or null");
}

boolean isInUnitTestTime() {
  return android.os.Build.MODEL.equals("faims-mock-device");
}

void assert(boolean condition) {
  if (condition)
    return;

  String msg =
    "Test failed: " +
    "Line: " + this.namespace.getInvocationLine() +
    ": "     + this.namespace.getInvocationText() +
    ". "     + this.callstack;

  throw new Exception(msg);
}

// Like `any` in Python
boolean any(List booleans) {
  for (b : booleans)
    if (b) return true;
  return false;
}

String listToSqlString(List l){
  String sqlString = "(";
  for (int i = 0; i < l.size() - 1; i++) {
    element = l.get(i);
    sqlString += "'" + element + "', ";
  }
  if (l.size() > 0) {
    int lastIndex = l.size() - 1;
    element = l.get(lastIndex);
    sqlString += "'" + element + "'";
  }
  sqlString += ")";

  return sqlString;
}

// Run a list of queries one-after-the-other. The next query starts executing
// once the previous finishes.
//
// `callbacks` is a list of `FetchCallback` objects corresponding to each query
// in `queries`. Although `callbacks` cannot be null, any of it elements can.
void sequentialFetchAll(List queries, List callbacks) {
  if (queries == null || callbacks == null)
    throw IllegalArgumentException("Arguments cannot be null");
  if (queries.size() != callbacks.size())
    throw IllegalArgumentException("Argument lists must have the same length");

  if (queries.size() == 0)
    return;

  String        queriesHead   = queries  .get(0);
  FetchCallback callbacksHead = callbacks.get(0);

  List queriesTail   = queries  .subList(1, queries  .size());
  List callbacksTail = callbacks.subList(1, callbacks.size());

  FetchCallback executeTail = new FetchCallback() {
    onFetch(result) {
      if (callbacksHead != null)
        callbacksHead.onFetch(result);

      sequentialFetchAll(queriesTail, callbacksTail);
    }

    onError(String message) {
      if (callbacksHead != null)
        callbacksHead.onError(message);
    }
  };

  fetchAll(queriesHead, executeTail);
}

/******************************************************************************/
/*                                STRING UTILS                                */
/******************************************************************************/

/* Works similarly to Java's String.replaceFirst, except the `needle` is a
 * string instead of a regex.
 */
String replaceFirst(String haystack, String needle, String replacement) {
  i = haystack.indexOf(needle);
  if (i == -1)           return haystack;
  if (needle.equals("")) return haystack;
  pre  = haystack.substring(0, i                                   );
  post = haystack.substring(   i+needle.length(), haystack.length());
  return pre + replacement + post;
}

String replaceFirst(String haystack, String replacement) {
  return replaceFirst(haystack, "%s", replacement);
}

/* Replaces `placeholder` in an SQL `query` with `replacement`. The following
 * example returns the string
 * "SELECT * FROM table WHERE col1 = 'my replacement'":
 *
 * dbReplaceFirst(
 *     "SELECT * FROM table WHERE col1 = {my_placeholder}",
 *     "{my_placeholder}",
 *     "my replacement"
 * );
 */
String dbReplaceFirst(String query, String placeholder, String replacement) {
  String escapedReplacement = DatabaseUtils.sqlEscapeString(replacement);
  return replaceFirst(query, placeholder, escapedReplacement);
}

String dbReplaceFirst(String query, String replacement) {
  return dbReplaceFirst(query, "%s", replacement);
}

String translate(String s, Map m) {
  String out = "";

  for (char c : s) {
    String translation = m.get(c);

    if (isNull(translation)) out += c;
    else                     out += translation;
  }

  return out;
}

String escape(String s) {
  Map dict = new HashMap();
  dict.put('\"', "\\\"");
  dict.put('\\', "\\\\");
  dict.put('\b', "\\b" );
  dict.put('\f', "\\f" );
  dict.put('\n', "\\n" );
  dict.put('\r', "\\r" );

  return translate(s, dict);
}

Map MEMOISED_FILTERED_BY_REGEX = new LinkedHashMap();

List filterListByRegex(List unfiltered, String regex, boolean forceUpdate) {
  // Return a copy of the memoised result if possible. It's important to return
  // a copy because if the contents of the list are modified, memoisation will
  // break.
  List key = new ArrayList();
  key.add(unfiltered);
  key.add(regex);

  List memoised = MEMOISED_FILTERED_BY_REGEX.get(key);
  if (memoised != null && !forceUpdate)
    return new ArrayList(memoised);

  // Compute the filtered list
  List filteredList;
  Set  filteredSet = new LinkedHashSet();
  for (element : unfiltered)
    if (element.matches(regex))
      filteredSet.add(element);
  filteredList = new ArrayList(filteredSet);

  // Memoise and return
  MEMOISED_FILTERED_BY_REGEX.put(key, filteredList);
  return new ArrayList(filteredList);
}

List filterListByRegex(List unfiltered, String regex) {
  return filterListByRegex(unfiltered, regex, false);
}

String getRandomString(int len) {
  char[] chars  = (
      "abcdefghijklmnopqrstuvwxyz" +
      "ABCDEFGHIJKLMNOPQRSTUVWXYZ" +
      "1234567890"
  ).toCharArray();
  Random random = new Random();

  StringBuilder sb = new StringBuilder();
  for (int i = 0; i < len; i++) {
      char c = chars[random.nextInt(chars.length)];
      sb.append(c);
  }

  return sb.toString();
}

String args2str(Object[] args) {
  String str = "";
  String sep = ", ";

  for (Object o : args) {
    if (o instanceof String) str += "\"" + escape(o) + "\"" + sep;
    else                     str +=               o         + sep;
  }

  // The loop adds a superfluous trailing separator. This removes it.
  str = str.substring(0, str.length() - sep.length());

  return str;
}

// "Function to string". Makes it very slightly less painful to write callback
// functions as strings.
String fun2str(String funName, Object[] args) {
  String argsStr = args2str(args);

  String str = "{funName}({argsStr})";
  str = replaceFirst(str, "{funName}", funName);
  str = replaceFirst(str, "{argsStr}", argsStr);

  return str;
}

String fun2str(String funName, Object args) {
  return fun2str(funName, new Object[]{args});
}

/************************** FUNCTION-STRING MAPPING ***************************/
/* Allows reflected functions to be associated with a key and called later    */
/* on. This is mostly useful for de-spagehettifying calls to `addOnEvent`,    */
/* which would otherwise effectively use eval.                                */
/******************************************************************************/
Map KEY_TO_FUN_NAME = new HashMap();
Map KEY_TO_FUN_ARGS = new HashMap();

String function2key(String function, Object[] args) {
  if (args == null)
    args = new Object[0];

  String key = getRandomString(64); // 64 ==> Odds of collision ~= 1e-115

  KEY_TO_FUN_NAME.put(key, function);
  KEY_TO_FUN_ARGS.put(key, args);

  return key;
}

key2call(String key) {
  String   funName = KEY_TO_FUN_NAME.get(key);
  Object[] funArgs = KEY_TO_FUN_ARGS.get(key);

  if (funName == null) return;
  if (funArgs == null) return;

  this.invokeMethod(funName, funArgs);
}

String function2callableString(String function, Object[] args) {
  return fun2str("key2call", function2key(function, args));
}

/******************************************************************************/
/*                           DOCUMENT OBJECT MODEL                            */
/******************************************************************************/
String  PREVIOUSLY_DISPLAYED_TAB_GROUP    = "";
String  CURRENTLY_DISPLAYED_TAB_GROUP     = "";
String  PREVIOUSLY_DISPLAYED_TAB          = "";
String  CURRENTLY_DISPLAYED_TAB           = "";
Map     REF_TO_TYPE                       = new LinkedHashMap();
HashSet DATA_REFS                         = new HashSet();
HashSet NO_UI_REFS                        = new HashSet();
HashSet HIER_REFS                         = new HashSet();
Map     VP_REF_TO_REF                     = new HashMap();
HashSet REFS_AS_HASH_SET                  = null;
List    REFS_AS_LIST                      = null;
List    TAB_GROUPS_AS_LIST                = new ArrayList();
HashSet TAB_GROUPS_AS_HASH_SET            = null;
List    TABS_AS_LIST                      = new ArrayList();
HashSet TABS_AS_HASH_SET                  = null;
HashMap ATTRIB_NAMES_NON_STANDARD         = new HashMap();
List    NODATA_TAB_GROUPS                 = new ArrayList();
List    NOAUTOSAVE_TAB_GROUPS             = new ArrayList();
HashSet NOAUTOSAVE_TAB_GROUPS_AS_HASH_SET = null;
HashMap REF_TO_FLAG_STRING                = new HashMap();

NODATA_TAB_GROUPS.add("User_List");
NODATA_TAB_GROUPS.add("Control");

REF_TO_TYPE.put("User_List/User_List/User_List", "list");
REF_TO_TYPE.put("Control/Control/Flaked_Stone_Artefact", "button");
REF_TO_TYPE.put("Control/Control/Other_Stone_Artefact", "button");
REF_TO_TYPE.put("Control/Control/Knapped_Glass_Artefact", "button");
REF_TO_TYPE.put("Control/Control/Discrete_Hearth_Feature", "button");
REF_TO_TYPE.put("Control/Control/Glass_Artefact", "button");
REF_TO_TYPE.put("Control/Control/Ceramic_Artefact", "button");
REF_TO_TYPE.put("Control/Control/Buttons", "button");
REF_TO_TYPE.put("Control/Control/Metal_Artefact", "button");
REF_TO_TYPE.put("Control/Control/Weapons_and_Ammunition", "button");
REF_TO_TYPE.put("Control/Control/Misc_Artefact", "button");
REF_TO_TYPE.put("Control/Control/GPS_diagnostics", "gpsdiag");
REF_TO_TYPE.put("Control/Map/Map", "map");
REF_TO_TYPE.put("Control/Map/Center_Me_1", "button");
REF_TO_TYPE.put("Control/Map/Save_Map_Settings_1", "button");
REF_TO_TYPE.put("Control/Recent/Recent_records", "list");
REF_TO_TYPE.put("Control/Search/Search_Term", "input");
REF_TO_TYPE.put("Control/Search/Search_Button", "button");
REF_TO_TYPE.put("Control/Search/Entity_Types", "dropdown");
REF_TO_TYPE.put("Control/Search/Entity_List", "list");
REF_TO_TYPE.put("Control/Autonumbering/Next_Flaked_Stone_Artefact_ID", "input");
REF_TO_TYPE.put("Control/Autonumbering/Next_Other_Stone_Artefact_ID", "input");
REF_TO_TYPE.put("Control/Autonumbering/Next_Glass_Artefact_ID", "input");
REF_TO_TYPE.put("Control/Autonumbering/Next_Ceramic_Artefact_ID", "input");
REF_TO_TYPE.put("Control/Autonumbering/Next_Misc_Artefact_ID", "input");
REF_TO_TYPE.put("Control/Autonumbering/Next_Discrete_Hearth_Artefact_ID", "input");
REF_TO_TYPE.put("Control/Autonumbering/Next_Buttons_ID", "input");
REF_TO_TYPE.put("Control/Autonumbering/Next_Knapped_Glass_Artefact_ID", "input");
REF_TO_TYPE.put("Control/Autonumbering/Next_Metal_Artefact_ID", "input");
REF_TO_TYPE.put("Control/Autonumbering/Next_Weapons_and_Ammunition_ID", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/General/Flaked_Stone_Artefact_ID", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/General/Flaked_Stone_Artefact_author", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/General/Flaked_Stone_Artefact_timestamp", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/General/Latitude", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/General/Longitude", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/General/Northing", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/General/Easting", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/General/Accuracy", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/General/Take_From_GPS_1", "button");
REF_TO_TYPE.put("Flaked_Stone_Artefact/General/Find_This_in_The_Map", "button");
REF_TO_TYPE.put("Flaked_Stone_Artefact/General/Device_photos", "camera");
REF_TO_TYPE.put("Flaked_Stone_Artefact/General/Device_photos_Button_1", "button");
REF_TO_TYPE.put("Flaked_Stone_Artefact/General/Landform_element", "dropdown");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details/Raw_material_type", "dropdown");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details/Raw_material_colour", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details/Weight_g", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details/Flake_completeness", "dropdown");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details/Platform_surface", "dropdown");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details/Platform_angle", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details/Platform_width_mm", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details/Platform_thickness_mm", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details/Maximum_length_mm", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details/Maximum_width_mm", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details/Maximum_thickness_mm", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details/Termination_type", "dropdown");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details/Overhang_removal", "dropdown");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details/Dorsal_cortex_type", "dropdown");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details/Dorsal_cortex_amount", "dropdown");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details/Dorsal_scar_count", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details/Dorsal_scar_direction", "checkbox");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details/Dorsal_flake_scar_maximum_length", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details/Retouched_quadrants", "checkbox");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details/Retouch_initiation", "dropdown");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details/Retouch_shape", "dropdown");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details/Additional_notes", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Supplementary/External_camera_ID", "dropdown");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Supplementary/External_camera_file_names_and_attachment", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Supplementary/External_camera_image_attachment", "file");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Supplementary/External_camera_image_attachment_Button_1", "button");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Supplementary/Survey_job_name", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Supplementary/Survey_instrument_name", "dropdown");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Supplementary/Survey_instrument_point_codes", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Supplementary/Related_site_name", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Supplementary/Sample_context", "input");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Supplementary/Other_contextual_details", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/General/Other_Stone_Artefact_ID", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/General/Other_Stone_Artefact_author", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/General/Other_Stone_Artefact_timestamp", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/General/Latitude", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/General/Longitude", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/General/Northing", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/General/Easting", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/General/Accuracy", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/General/Take_From_GPS_1", "button");
REF_TO_TYPE.put("Other_Stone_Artefact/General/Find_This_in_The_Map", "button");
REF_TO_TYPE.put("Other_Stone_Artefact/General/Device_photos", "camera");
REF_TO_TYPE.put("Other_Stone_Artefact/General/Device_photos_Button_1", "button");
REF_TO_TYPE.put("Other_Stone_Artefact/General/Landform_element", "dropdown");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Raw_material_type", "dropdown");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Raw_material_colour", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Completeness", "dropdown");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Weight_g", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Type", "dropdown");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Length_mm", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Width_mm", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Thickness_mm", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Largest_scar_length_mm", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Core_largest_scar_shape", "dropdown");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Core_platform_count", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Core_platform_1_surface", "dropdown");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Core_platform_1_length_mm", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Core_platform_1_width_mm", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Core_platform_1_angle_mm", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Core_platform_2_surface", "dropdown");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Core_platform_2_length_mm", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Core_platform_2_width_mm", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Core_platform_2_angle", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Core_classification", "dropdown");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Remaining_cortical_surface", "dropdown");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Usewear", "dropdown");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details/Additional_notes", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/Supplementary/External_camera_ID", "dropdown");
REF_TO_TYPE.put("Other_Stone_Artefact/Supplementary/External_camera_file_names_and_attachment", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/Supplementary/External_camera_image_attachment", "file");
REF_TO_TYPE.put("Other_Stone_Artefact/Supplementary/External_camera_image_attachment_Button_1", "button");
REF_TO_TYPE.put("Other_Stone_Artefact/Supplementary/Survey_job_name", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/Supplementary/Survey_instrument_name", "dropdown");
REF_TO_TYPE.put("Other_Stone_Artefact/Supplementary/Survey_instrument_point_codes", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/Supplementary/Related_site_name", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/Supplementary/Sample_context", "input");
REF_TO_TYPE.put("Other_Stone_Artefact/Supplementary/Other_contextual_details", "input");
REF_TO_TYPE.put("Glass_Artefact/General/Glass_Artefact_ID", "input");
REF_TO_TYPE.put("Glass_Artefact/General/Glass_Artefact_author", "input");
REF_TO_TYPE.put("Glass_Artefact/General/Glass_Artefact_timestamp", "input");
REF_TO_TYPE.put("Glass_Artefact/General/Latitude", "input");
REF_TO_TYPE.put("Glass_Artefact/General/Longitude", "input");
REF_TO_TYPE.put("Glass_Artefact/General/Northing", "input");
REF_TO_TYPE.put("Glass_Artefact/General/Easting", "input");
REF_TO_TYPE.put("Glass_Artefact/General/Accuracy", "input");
REF_TO_TYPE.put("Glass_Artefact/General/Take_From_GPS_1", "button");
REF_TO_TYPE.put("Glass_Artefact/General/Find_This_in_The_Map", "button");
REF_TO_TYPE.put("Glass_Artefact/General/Device_photos", "camera");
REF_TO_TYPE.put("Glass_Artefact/General/Device_photos_Button_1", "button");
REF_TO_TYPE.put("Glass_Artefact/General/Landform_element", "dropdown");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Diagnostic", "dropdown");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Colour", "dropdown");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Completeness", "dropdown");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Grouped_fragments", "dropdown");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Group_notes", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Portion_or_component", "dropdown");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Object_type", "dropdown");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Tableware_type", "checkbox");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Length_mm", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Width_mm", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Thickness_mm", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Horizontal_shape", "dropdown");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Probable_contents", "checkbox");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Shoulder_width_mm", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Complete_height_mm", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Number_of_mould_seams", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Mould_type", "dropdown");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Patination_present", "dropdown");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Base_diameter_mm", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Base_thickness_mm", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Pontil_mark_present", "dropdown");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Kickup_depth_mm", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Finish_inner_bore_diameter_mm", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Finish_type", "dropdown");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Closure_type", "dropdown");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Applied_finish", "dropdown");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Trademark", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Marks_motifs_and_decoration", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Start_date", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/End_date", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Conjoin_information", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/References", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Grouped_fragments_only", "webview");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Grouped_fragment_count", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Grouped_fragment_weight_g", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Group_max_fragment_length_mm", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Group_max_fragment_width_mm", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Group_max_fragment_thickness_mm", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Group_min_fragment_length_mm", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Group_min_fragment_width_mm", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Group_min_fragment_thickness_mm", "input");
REF_TO_TYPE.put("Glass_Artefact/Feature_details/Grouped_fragments_additional_comments", "input");
REF_TO_TYPE.put("Glass_Artefact/Supplementary/External_camera_ID", "dropdown");
REF_TO_TYPE.put("Glass_Artefact/Supplementary/External_camera_file_names_and_attachment", "input");
REF_TO_TYPE.put("Glass_Artefact/Supplementary/External_camera_image_attachment", "file");
REF_TO_TYPE.put("Glass_Artefact/Supplementary/External_camera_image_attachment_Button_1", "button");
REF_TO_TYPE.put("Glass_Artefact/Supplementary/Survey_job_name", "input");
REF_TO_TYPE.put("Glass_Artefact/Supplementary/Survey_instrument_name", "dropdown");
REF_TO_TYPE.put("Glass_Artefact/Supplementary/Survey_instrument_point_codes", "input");
REF_TO_TYPE.put("Glass_Artefact/Supplementary/Related_site_name", "input");
REF_TO_TYPE.put("Glass_Artefact/Supplementary/Sample_context", "input");
REF_TO_TYPE.put("Glass_Artefact/Supplementary/Other_contextual_details", "input");
REF_TO_TYPE.put("Ceramic_Artefact/General/Ceramic_Artefact_ID", "input");
REF_TO_TYPE.put("Ceramic_Artefact/General/Ceramic_Artefact_author", "input");
REF_TO_TYPE.put("Ceramic_Artefact/General/Ceramic_Artefact_timestamp", "input");
REF_TO_TYPE.put("Ceramic_Artefact/General/Latitude", "input");
REF_TO_TYPE.put("Ceramic_Artefact/General/Longitude", "input");
REF_TO_TYPE.put("Ceramic_Artefact/General/Northing", "input");
REF_TO_TYPE.put("Ceramic_Artefact/General/Easting", "input");
REF_TO_TYPE.put("Ceramic_Artefact/General/Accuracy", "input");
REF_TO_TYPE.put("Ceramic_Artefact/General/Take_From_GPS_1", "button");
REF_TO_TYPE.put("Ceramic_Artefact/General/Find_This_in_The_Map", "button");
REF_TO_TYPE.put("Ceramic_Artefact/General/Device_photos", "camera");
REF_TO_TYPE.put("Ceramic_Artefact/General/Device_photos_Button_1", "button");
REF_TO_TYPE.put("Ceramic_Artefact/General/Landform_element", "dropdown");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Diagnostic", "dropdown");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Technological_ware_type", "dropdown");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Element", "dropdown");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Form", "dropdown");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Completeness", "dropdown");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Function", "dropdown");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Length_mm", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Width_mm", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Thickness_mm", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Base_diameter_mm", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Rim_diameter_mm", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Paste_colour", "dropdown");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Glaze_type", "dropdown");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Decorative_methods", "checkbox");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Decorative_colours", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Visible_motifs", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Flaws", "dropdown");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Decorative_pattern_name", "dropdown");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Maker_s_marks_or_trademarks", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Start_date", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/End_date", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Conjoin_information", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/References", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Grouped_fragments_only", "webview");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Grouped_fragment_count", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Grouped_fragment_weight_g", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Group_max_fragment_length_mm", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Group_max_fragment_width_mm", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Group_max_fragment_thickness_mm", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Group_min_fragment_length_mm", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Group_min_fragment_width_mm", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Group_min_fragment_thickness_mm", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details/Grouped_fragments_additional_comments", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Supplementary/External_camera_ID", "dropdown");
REF_TO_TYPE.put("Ceramic_Artefact/Supplementary/External_camera_file_names_and_attachment", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Supplementary/External_camera_image_attachment", "file");
REF_TO_TYPE.put("Ceramic_Artefact/Supplementary/External_camera_image_attachment_Button_1", "button");
REF_TO_TYPE.put("Ceramic_Artefact/Supplementary/Survey_job_name", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Supplementary/Survey_instrument_name", "dropdown");
REF_TO_TYPE.put("Ceramic_Artefact/Supplementary/Survey_instrument_point_codes", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Supplementary/Related_site_name", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Supplementary/Sample_context", "input");
REF_TO_TYPE.put("Ceramic_Artefact/Supplementary/Other_contextual_details", "input");
REF_TO_TYPE.put("Misc_Artefact/General/Misc_Artefact_ID", "input");
REF_TO_TYPE.put("Misc_Artefact/General/Misc_Artefact_author", "input");
REF_TO_TYPE.put("Misc_Artefact/General/Misc_Artefact_timestamp", "input");
REF_TO_TYPE.put("Misc_Artefact/General/Latitude", "input");
REF_TO_TYPE.put("Misc_Artefact/General/Longitude", "input");
REF_TO_TYPE.put("Misc_Artefact/General/Northing", "input");
REF_TO_TYPE.put("Misc_Artefact/General/Easting", "input");
REF_TO_TYPE.put("Misc_Artefact/General/Accuracy", "input");
REF_TO_TYPE.put("Misc_Artefact/General/Take_From_GPS_1", "button");
REF_TO_TYPE.put("Misc_Artefact/General/Find_This_in_The_Map", "button");
REF_TO_TYPE.put("Misc_Artefact/General/Device_photos", "camera");
REF_TO_TYPE.put("Misc_Artefact/General/Device_photos_Button_1", "button");
REF_TO_TYPE.put("Misc_Artefact/General/Landform_element", "dropdown");
REF_TO_TYPE.put("Misc_Artefact/Feature_details/Material", "dropdown");
REF_TO_TYPE.put("Misc_Artefact/Feature_details/Type", "input");
REF_TO_TYPE.put("Misc_Artefact/Feature_details/Length_mm", "input");
REF_TO_TYPE.put("Misc_Artefact/Feature_details/Width_mm", "input");
REF_TO_TYPE.put("Misc_Artefact/Feature_details/Thickness_mm", "input");
REF_TO_TYPE.put("Misc_Artefact/Feature_details/Height_mm", "input");
REF_TO_TYPE.put("Misc_Artefact/Feature_details/Maker_s_marks_or_trademarks", "input");
REF_TO_TYPE.put("Misc_Artefact/Feature_details/Start_date", "input");
REF_TO_TYPE.put("Misc_Artefact/Feature_details/End_date", "input");
REF_TO_TYPE.put("Misc_Artefact/Feature_details/Additional_notes", "input");
REF_TO_TYPE.put("Misc_Artefact/Supplementary/External_camera_ID", "dropdown");
REF_TO_TYPE.put("Misc_Artefact/Supplementary/External_camera_file_names_and_attachment", "input");
REF_TO_TYPE.put("Misc_Artefact/Supplementary/External_camera_image_attachment", "file");
REF_TO_TYPE.put("Misc_Artefact/Supplementary/External_camera_image_attachment_Button_1", "button");
REF_TO_TYPE.put("Misc_Artefact/Supplementary/Survey_job_name", "input");
REF_TO_TYPE.put("Misc_Artefact/Supplementary/Survey_instrument_name", "dropdown");
REF_TO_TYPE.put("Misc_Artefact/Supplementary/Survey_instrument_point_codes", "input");
REF_TO_TYPE.put("Misc_Artefact/Supplementary/Related_site_name", "input");
REF_TO_TYPE.put("Misc_Artefact/Supplementary/Sample_context", "input");
REF_TO_TYPE.put("Misc_Artefact/Supplementary/Other_contextual_details", "input");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/General/Discrete_Hearth_Artefact_ID", "input");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/General/Discrete_Hearth_Artefact_author", "input");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/General/Discrete_Hearth_Artefact_timestamp", "input");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/General/Latitude", "input");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/General/Longitude", "input");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/General/Northing", "input");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/General/Easting", "input");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/General/Accuracy", "input");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/General/Take_From_GPS_1", "button");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/General/Find_This_in_The_Map", "button");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/General/Device_photos", "camera");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/General/Device_photos_Button_1", "button");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/General/Landform_element", "dropdown");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/Feature_details/Hearth_type", "dropdown");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/Feature_details/Heating_element_types", "dropdown");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/Feature_details/Heating_element_frequency", "dropdown");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/Feature_details/Materials_present", "checkbox");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/Feature_details/Diameter_mm", "input");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/Feature_details/Additional_notes", "input");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/Supplementary/External_camera_ID", "dropdown");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/Supplementary/External_camera_file_names_and_attachment", "input");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/Supplementary/External_camera_image_attachment", "file");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/Supplementary/External_camera_image_attachment_Button_1", "button");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/Supplementary/Survey_job_name", "input");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/Supplementary/Survey_instrument_name", "dropdown");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/Supplementary/Survey_instrument_point_codes", "input");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/Supplementary/Related_site_name", "input");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/Supplementary/Sample_context", "input");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/Supplementary/Other_contextual_details", "input");
REF_TO_TYPE.put("Buttons/General/Buttons_ID", "input");
REF_TO_TYPE.put("Buttons/General/Buttons_author", "input");
REF_TO_TYPE.put("Buttons/General/Buttons_timestamp", "input");
REF_TO_TYPE.put("Buttons/General/Latitude", "input");
REF_TO_TYPE.put("Buttons/General/Longitude", "input");
REF_TO_TYPE.put("Buttons/General/Northing", "input");
REF_TO_TYPE.put("Buttons/General/Easting", "input");
REF_TO_TYPE.put("Buttons/General/Accuracy", "input");
REF_TO_TYPE.put("Buttons/General/Take_From_GPS_1", "button");
REF_TO_TYPE.put("Buttons/General/Find_This_in_The_Map", "button");
REF_TO_TYPE.put("Buttons/General/Device_photos", "camera");
REF_TO_TYPE.put("Buttons/General/Device_photos_Button_1", "button");
REF_TO_TYPE.put("Buttons/General/Landform_element", "dropdown");
REF_TO_TYPE.put("Buttons/Feature_details/Material_type", "checkbox");
REF_TO_TYPE.put("Buttons/Feature_details/Attachment_method", "dropdown");
REF_TO_TYPE.put("Buttons/Feature_details/Ligne_size_mm", "input");
REF_TO_TYPE.put("Buttons/Feature_details/Manufacture_method", "checkbox");
REF_TO_TYPE.put("Buttons/Feature_details/Construction", "dropdown");
REF_TO_TYPE.put("Buttons/Feature_details/Shank_type", "checkbox");
REF_TO_TYPE.put("Buttons/Feature_details/Sew_through_type", "checkbox");
REF_TO_TYPE.put("Buttons/Feature_details/Number_of_eyes", "input");
REF_TO_TYPE.put("Buttons/Feature_details/Motifs", "input");
REF_TO_TYPE.put("Buttons/Feature_details/Maker_s_marks_or_trademarks", "input");
REF_TO_TYPE.put("Buttons/Feature_details/Start_date", "input");
REF_TO_TYPE.put("Buttons/Feature_details/End_date", "input");
REF_TO_TYPE.put("Buttons/Feature_details/Additional_notes", "input");
REF_TO_TYPE.put("Buttons/Feature_details/References", "input");
REF_TO_TYPE.put("Buttons/Supplementary/External_camera_ID", "dropdown");
REF_TO_TYPE.put("Buttons/Supplementary/External_camera_file_names_and_attachment", "input");
REF_TO_TYPE.put("Buttons/Supplementary/External_camera_image_attachment", "file");
REF_TO_TYPE.put("Buttons/Supplementary/External_camera_image_attachment_Button_1", "button");
REF_TO_TYPE.put("Buttons/Supplementary/Survey_job_name", "input");
REF_TO_TYPE.put("Buttons/Supplementary/Survey_instrument_name", "dropdown");
REF_TO_TYPE.put("Buttons/Supplementary/Survey_instrument_point_codes", "input");
REF_TO_TYPE.put("Buttons/Supplementary/Related_site_name", "input");
REF_TO_TYPE.put("Buttons/Supplementary/Sample_context", "input");
REF_TO_TYPE.put("Buttons/Supplementary/Other_contextual_details", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/General/Knapped_Glass_Artefact_ID", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/General/Knapped_Glass_Artefact_author", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/General/Knapped_Glass_Artefact_timestamp", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/General/Latitude", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/General/Longitude", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/General/Northing", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/General/Easting", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/General/Accuracy", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/General/Take_From_GPS_1", "button");
REF_TO_TYPE.put("Knapped_Glass_Artefact/General/Find_This_in_The_Map", "button");
REF_TO_TYPE.put("Knapped_Glass_Artefact/General/Device_photos", "camera");
REF_TO_TYPE.put("Knapped_Glass_Artefact/General/Device_photos_Button_1", "button");
REF_TO_TYPE.put("Knapped_Glass_Artefact/General/Landform_element", "dropdown");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Type", "dropdown");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Glass_type", "dropdown");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Bottle_part", "checkbox");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Glass_colour", "dropdown");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Completeness", "dropdown");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Max_length_mm", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Max_width_mm", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Max_thickness_mm", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Weight_g", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Burned", "dropdown");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Patination", "dropdown");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Additional_notes", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Start_date", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/End_date", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Webview_glass_core_details", "webview");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Scar_count", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Largest_scar_length_mm", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Largest_scar_width_mm", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Core_type", "dropdown");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Original_base_diameter", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Webview_flake_details", "webview");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Platform_type", "dropdown");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Platform_depth_mm", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Platform_width_mm", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Distal_termination", "dropdown");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Cortex_percent", "dropdown");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Dorsal_scar_count", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Conjoin", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Refit", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Edge_damage", "dropdown");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details/Abrasion", "checkbox");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Supplementary/External_camera_ID", "dropdown");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Supplementary/External_camera_file_names_and_attachment", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Supplementary/External_camera_image_attachment", "file");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Supplementary/External_camera_image_attachment_Button_1", "button");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Supplementary/Survey_instrument_name", "dropdown");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Supplementary/Survey_instrument_point_codes", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Supplementary/Related_site_name", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Supplementary/Sample_context", "input");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Supplementary/Other_contextual_details", "input");
REF_TO_TYPE.put("Metal_Artefact/General/Metal_Artefact_ID", "input");
REF_TO_TYPE.put("Metal_Artefact/General/Metal_Artefact_author", "input");
REF_TO_TYPE.put("Metal_Artefact/General/Metal_Artefact_timestamp", "input");
REF_TO_TYPE.put("Metal_Artefact/General/Latitude", "input");
REF_TO_TYPE.put("Metal_Artefact/General/Longitude", "input");
REF_TO_TYPE.put("Metal_Artefact/General/Northing", "input");
REF_TO_TYPE.put("Metal_Artefact/General/Easting", "input");
REF_TO_TYPE.put("Metal_Artefact/General/Accuracy", "input");
REF_TO_TYPE.put("Metal_Artefact/General/Take_From_GPS_1", "button");
REF_TO_TYPE.put("Metal_Artefact/General/Find_This_in_The_Map", "button");
REF_TO_TYPE.put("Metal_Artefact/General/Device_photos", "camera");
REF_TO_TYPE.put("Metal_Artefact/General/Device_photos_Button_1", "button");
REF_TO_TYPE.put("Metal_Artefact/General/Landform_element", "dropdown");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Metal_type", "checkbox");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Metal_completeness", "dropdown");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Object_type", "dropdown");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Length_mm", "input");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Width_mm", "input");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Thickness_mm", "input");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Weight_g", "input");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Maker_s_marks_or_trademarks", "input");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Modification_or_re_use", "input");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Start_date", "input");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/End_date", "input");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Additional_notes", "input");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/References", "input");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Nails_or_structural_fasteners_only", "webview");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Form", "dropdown");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Head_shape", "dropdown");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Shaft_shape", "dropdown");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Manufacture_method", "dropdown");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Size_class", "dropdown");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Features", "checkbox");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Buckles_only", "webview");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Frame_type", "dropdown");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Frame_shape", "dropdown");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Pin", "dropdown");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Tongue", "dropdown");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Decoration_type", "checkbox");
REF_TO_TYPE.put("Metal_Artefact/Feature_details/Decorative_motifs", "checkbox");
REF_TO_TYPE.put("Metal_Artefact/Supplementary/External_camera_ID", "dropdown");
REF_TO_TYPE.put("Metal_Artefact/Supplementary/External_camera_file_names_and_attachment", "input");
REF_TO_TYPE.put("Metal_Artefact/Supplementary/External_camera_image_attachment", "file");
REF_TO_TYPE.put("Metal_Artefact/Supplementary/External_camera_image_attachment_Button_1", "button");
REF_TO_TYPE.put("Metal_Artefact/Supplementary/Survey_instrument_name", "dropdown");
REF_TO_TYPE.put("Metal_Artefact/Supplementary/Survey_instrument_point_codes", "input");
REF_TO_TYPE.put("Metal_Artefact/Supplementary/Related_site_name", "input");
REF_TO_TYPE.put("Metal_Artefact/Supplementary/Sample_context", "input");
REF_TO_TYPE.put("Metal_Artefact/Supplementary/Other_contextual_details", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/General/Weapons_and_Ammunition_ID", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/General/Weapons_and_Ammunition_author", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/General/Weapons_and_Ammunition_timestamp", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/General/Latitude", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/General/Longitude", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/General/Northing", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/General/Easting", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/General/Accuracy", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/General/Take_From_GPS_1", "button");
REF_TO_TYPE.put("Weapons_and_Ammunition/General/Find_This_in_The_Map", "button");
REF_TO_TYPE.put("Weapons_and_Ammunition/General/Device_photos", "camera");
REF_TO_TYPE.put("Weapons_and_Ammunition/General/Device_photos_Button_1", "button");
REF_TO_TYPE.put("Weapons_and_Ammunition/General/Landform_element", "dropdown");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Object", "dropdown");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Completeness", "dropdown");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Material", "checkbox");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Length_mm", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Width_mm", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Thickness_mm", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Weight_g", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Weight_grains_1_gram_is_15_4324_grains", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Gun_part", "dropdown");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Crown_or_head_stamps", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Other_trademarks", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Start_date", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/End_date", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Additional_notes", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/References", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Projectile_details", "webview");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Projectile_type", "dropdown");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Deformation", "dropdown");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Rifling_grooves", "dropdown");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Mould_seams_sprue_marks", "dropdown");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Number_of_grooves", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Cartridge_details", "webview");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Base", "dropdown");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Body", "dropdown");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details/Firing_mechanism", "dropdown");
REF_TO_TYPE.put("Weapons_and_Ammunition/Supplementary/External_camera_ID", "dropdown");
REF_TO_TYPE.put("Weapons_and_Ammunition/Supplementary/External_camera_file_names_and_attachment", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/Supplementary/External_camera_image_attachment", "file");
REF_TO_TYPE.put("Weapons_and_Ammunition/Supplementary/External_camera_image_attachment_Button_1", "button");
REF_TO_TYPE.put("Weapons_and_Ammunition/Supplementary/Survey_instrument_name", "dropdown");
REF_TO_TYPE.put("Weapons_and_Ammunition/Supplementary/Survey_instrument_point_codes", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/Supplementary/Related_site_name", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/Supplementary/Sample_context", "input");
REF_TO_TYPE.put("Weapons_and_Ammunition/Supplementary/Other_contextual_details", "input");
REF_TO_TYPE.put("User_List/User_List", "tab");
REF_TO_TYPE.put("Control/Control", "tab");
REF_TO_TYPE.put("Control/Map", "tab");
REF_TO_TYPE.put("Control/Recent", "tab");
REF_TO_TYPE.put("Control/Search", "tab");
REF_TO_TYPE.put("Control/Autonumbering", "tab");
REF_TO_TYPE.put("Flaked_Stone_Artefact/General", "tab");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Feature_details", "tab");
REF_TO_TYPE.put("Flaked_Stone_Artefact/Supplementary", "tab");
REF_TO_TYPE.put("Other_Stone_Artefact/General", "tab");
REF_TO_TYPE.put("Other_Stone_Artefact/Feature_details", "tab");
REF_TO_TYPE.put("Other_Stone_Artefact/Supplementary", "tab");
REF_TO_TYPE.put("Glass_Artefact/General", "tab");
REF_TO_TYPE.put("Glass_Artefact/Feature_details", "tab");
REF_TO_TYPE.put("Glass_Artefact/Supplementary", "tab");
REF_TO_TYPE.put("Ceramic_Artefact/General", "tab");
REF_TO_TYPE.put("Ceramic_Artefact/Feature_details", "tab");
REF_TO_TYPE.put("Ceramic_Artefact/Supplementary", "tab");
REF_TO_TYPE.put("Misc_Artefact/General", "tab");
REF_TO_TYPE.put("Misc_Artefact/Feature_details", "tab");
REF_TO_TYPE.put("Misc_Artefact/Supplementary", "tab");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/General", "tab");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/Feature_details", "tab");
REF_TO_TYPE.put("Discrete_Hearth_Artefact/Supplementary", "tab");
REF_TO_TYPE.put("Buttons/General", "tab");
REF_TO_TYPE.put("Buttons/Feature_details", "tab");
REF_TO_TYPE.put("Buttons/Supplementary", "tab");
REF_TO_TYPE.put("Knapped_Glass_Artefact/General", "tab");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Feature_details", "tab");
REF_TO_TYPE.put("Knapped_Glass_Artefact/Supplementary", "tab");
REF_TO_TYPE.put("Metal_Artefact/General", "tab");
REF_TO_TYPE.put("Metal_Artefact/Feature_details", "tab");
REF_TO_TYPE.put("Metal_Artefact/Supplementary", "tab");
REF_TO_TYPE.put("Weapons_and_Ammunition/General", "tab");
REF_TO_TYPE.put("Weapons_and_Ammunition/Feature_details", "tab");
REF_TO_TYPE.put("Weapons_and_Ammunition/Supplementary", "tab");

DATA_REFS.add("Flaked_Stone_Artefact/General/Flaked_Stone_Artefact_ID");
DATA_REFS.add("Flaked_Stone_Artefact/General/Flaked_Stone_Artefact_author");
DATA_REFS.add("Flaked_Stone_Artefact/General/Flaked_Stone_Artefact_timestamp");
DATA_REFS.add("Flaked_Stone_Artefact/General/Latitude");
DATA_REFS.add("Flaked_Stone_Artefact/General/Longitude");
DATA_REFS.add("Flaked_Stone_Artefact/General/Northing");
DATA_REFS.add("Flaked_Stone_Artefact/General/Easting");
DATA_REFS.add("Flaked_Stone_Artefact/General/Accuracy");
DATA_REFS.add("Flaked_Stone_Artefact/General/Device_photos");
DATA_REFS.add("Flaked_Stone_Artefact/General/Landform_element");
DATA_REFS.add("Flaked_Stone_Artefact/Feature_details/Raw_material_type");
DATA_REFS.add("Flaked_Stone_Artefact/Feature_details/Raw_material_colour");
DATA_REFS.add("Flaked_Stone_Artefact/Feature_details/Weight_g");
DATA_REFS.add("Flaked_Stone_Artefact/Feature_details/Flake_completeness");
DATA_REFS.add("Flaked_Stone_Artefact/Feature_details/Platform_surface");
DATA_REFS.add("Flaked_Stone_Artefact/Feature_details/Platform_angle");
DATA_REFS.add("Flaked_Stone_Artefact/Feature_details/Platform_width_mm");
DATA_REFS.add("Flaked_Stone_Artefact/Feature_details/Platform_thickness_mm");
DATA_REFS.add("Flaked_Stone_Artefact/Feature_details/Maximum_length_mm");
DATA_REFS.add("Flaked_Stone_Artefact/Feature_details/Maximum_width_mm");
DATA_REFS.add("Flaked_Stone_Artefact/Feature_details/Maximum_thickness_mm");
DATA_REFS.add("Flaked_Stone_Artefact/Feature_details/Termination_type");
DATA_REFS.add("Flaked_Stone_Artefact/Feature_details/Overhang_removal");
DATA_REFS.add("Flaked_Stone_Artefact/Feature_details/Dorsal_cortex_type");
DATA_REFS.add("Flaked_Stone_Artefact/Feature_details/Dorsal_cortex_amount");
DATA_REFS.add("Flaked_Stone_Artefact/Feature_details/Dorsal_scar_count");
DATA_REFS.add("Flaked_Stone_Artefact/Feature_details/Dorsal_scar_direction");
DATA_REFS.add("Flaked_Stone_Artefact/Feature_details/Dorsal_flake_scar_maximum_length");
DATA_REFS.add("Flaked_Stone_Artefact/Feature_details/Retouched_quadrants");
DATA_REFS.add("Flaked_Stone_Artefact/Feature_details/Retouch_initiation");
DATA_REFS.add("Flaked_Stone_Artefact/Feature_details/Retouch_shape");
DATA_REFS.add("Flaked_Stone_Artefact/Feature_details/Additional_notes");
DATA_REFS.add("Flaked_Stone_Artefact/Supplementary/External_camera_ID");
DATA_REFS.add("Flaked_Stone_Artefact/Supplementary/External_camera_file_names_and_attachment");
DATA_REFS.add("Flaked_Stone_Artefact/Supplementary/External_camera_image_attachment");
DATA_REFS.add("Flaked_Stone_Artefact/Supplementary/Survey_job_name");
DATA_REFS.add("Flaked_Stone_Artefact/Supplementary/Survey_instrument_name");
DATA_REFS.add("Flaked_Stone_Artefact/Supplementary/Survey_instrument_point_codes");
DATA_REFS.add("Flaked_Stone_Artefact/Supplementary/Related_site_name");
DATA_REFS.add("Flaked_Stone_Artefact/Supplementary/Sample_context");
DATA_REFS.add("Flaked_Stone_Artefact/Supplementary/Other_contextual_details");
DATA_REFS.add("Other_Stone_Artefact/General/Other_Stone_Artefact_ID");
DATA_REFS.add("Other_Stone_Artefact/General/Other_Stone_Artefact_author");
DATA_REFS.add("Other_Stone_Artefact/General/Other_Stone_Artefact_timestamp");
DATA_REFS.add("Other_Stone_Artefact/General/Latitude");
DATA_REFS.add("Other_Stone_Artefact/General/Longitude");
DATA_REFS.add("Other_Stone_Artefact/General/Northing");
DATA_REFS.add("Other_Stone_Artefact/General/Easting");
DATA_REFS.add("Other_Stone_Artefact/General/Accuracy");
DATA_REFS.add("Other_Stone_Artefact/General/Device_photos");
DATA_REFS.add("Other_Stone_Artefact/General/Landform_element");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Raw_material_type");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Raw_material_colour");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Completeness");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Weight_g");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Type");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Length_mm");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Width_mm");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Thickness_mm");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Largest_scar_length_mm");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Core_largest_scar_shape");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Core_platform_count");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Core_platform_1_surface");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Core_platform_1_length_mm");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Core_platform_1_width_mm");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Core_platform_1_angle_mm");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Core_platform_2_surface");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Core_platform_2_length_mm");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Core_platform_2_width_mm");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Core_platform_2_angle");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Core_classification");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Remaining_cortical_surface");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Usewear");
DATA_REFS.add("Other_Stone_Artefact/Feature_details/Additional_notes");
DATA_REFS.add("Other_Stone_Artefact/Supplementary/External_camera_ID");
DATA_REFS.add("Other_Stone_Artefact/Supplementary/External_camera_file_names_and_attachment");
DATA_REFS.add("Other_Stone_Artefact/Supplementary/External_camera_image_attachment");
DATA_REFS.add("Other_Stone_Artefact/Supplementary/Survey_job_name");
DATA_REFS.add("Other_Stone_Artefact/Supplementary/Survey_instrument_name");
DATA_REFS.add("Other_Stone_Artefact/Supplementary/Survey_instrument_point_codes");
DATA_REFS.add("Other_Stone_Artefact/Supplementary/Related_site_name");
DATA_REFS.add("Other_Stone_Artefact/Supplementary/Sample_context");
DATA_REFS.add("Other_Stone_Artefact/Supplementary/Other_contextual_details");
DATA_REFS.add("Glass_Artefact/General/Glass_Artefact_ID");
DATA_REFS.add("Glass_Artefact/General/Glass_Artefact_author");
DATA_REFS.add("Glass_Artefact/General/Glass_Artefact_timestamp");
DATA_REFS.add("Glass_Artefact/General/Latitude");
DATA_REFS.add("Glass_Artefact/General/Longitude");
DATA_REFS.add("Glass_Artefact/General/Northing");
DATA_REFS.add("Glass_Artefact/General/Easting");
DATA_REFS.add("Glass_Artefact/General/Accuracy");
DATA_REFS.add("Glass_Artefact/General/Device_photos");
DATA_REFS.add("Glass_Artefact/General/Landform_element");
DATA_REFS.add("Glass_Artefact/Feature_details/Diagnostic");
DATA_REFS.add("Glass_Artefact/Feature_details/Colour");
DATA_REFS.add("Glass_Artefact/Feature_details/Completeness");
DATA_REFS.add("Glass_Artefact/Feature_details/Grouped_fragments");
DATA_REFS.add("Glass_Artefact/Feature_details/Group_notes");
DATA_REFS.add("Glass_Artefact/Feature_details/Portion_or_component");
DATA_REFS.add("Glass_Artefact/Feature_details/Object_type");
DATA_REFS.add("Glass_Artefact/Feature_details/Tableware_type");
DATA_REFS.add("Glass_Artefact/Feature_details/Length_mm");
DATA_REFS.add("Glass_Artefact/Feature_details/Width_mm");
DATA_REFS.add("Glass_Artefact/Feature_details/Thickness_mm");
DATA_REFS.add("Glass_Artefact/Feature_details/Horizontal_shape");
DATA_REFS.add("Glass_Artefact/Feature_details/Probable_contents");
DATA_REFS.add("Glass_Artefact/Feature_details/Shoulder_width_mm");
DATA_REFS.add("Glass_Artefact/Feature_details/Complete_height_mm");
DATA_REFS.add("Glass_Artefact/Feature_details/Number_of_mould_seams");
DATA_REFS.add("Glass_Artefact/Feature_details/Mould_type");
DATA_REFS.add("Glass_Artefact/Feature_details/Patination_present");
DATA_REFS.add("Glass_Artefact/Feature_details/Base_diameter_mm");
DATA_REFS.add("Glass_Artefact/Feature_details/Base_thickness_mm");
DATA_REFS.add("Glass_Artefact/Feature_details/Pontil_mark_present");
DATA_REFS.add("Glass_Artefact/Feature_details/Kickup_depth_mm");
DATA_REFS.add("Glass_Artefact/Feature_details/Finish_inner_bore_diameter_mm");
DATA_REFS.add("Glass_Artefact/Feature_details/Finish_type");
DATA_REFS.add("Glass_Artefact/Feature_details/Closure_type");
DATA_REFS.add("Glass_Artefact/Feature_details/Applied_finish");
DATA_REFS.add("Glass_Artefact/Feature_details/Trademark");
DATA_REFS.add("Glass_Artefact/Feature_details/Marks_motifs_and_decoration");
DATA_REFS.add("Glass_Artefact/Feature_details/Start_date");
DATA_REFS.add("Glass_Artefact/Feature_details/End_date");
DATA_REFS.add("Glass_Artefact/Feature_details/Conjoin_information");
DATA_REFS.add("Glass_Artefact/Feature_details/References");
DATA_REFS.add("Glass_Artefact/Feature_details/Grouped_fragment_count");
DATA_REFS.add("Glass_Artefact/Feature_details/Grouped_fragment_weight_g");
DATA_REFS.add("Glass_Artefact/Feature_details/Group_max_fragment_length_mm");
DATA_REFS.add("Glass_Artefact/Feature_details/Group_max_fragment_width_mm");
DATA_REFS.add("Glass_Artefact/Feature_details/Group_max_fragment_thickness_mm");
DATA_REFS.add("Glass_Artefact/Feature_details/Group_min_fragment_length_mm");
DATA_REFS.add("Glass_Artefact/Feature_details/Group_min_fragment_width_mm");
DATA_REFS.add("Glass_Artefact/Feature_details/Group_min_fragment_thickness_mm");
DATA_REFS.add("Glass_Artefact/Feature_details/Grouped_fragments_additional_comments");
DATA_REFS.add("Glass_Artefact/Supplementary/External_camera_ID");
DATA_REFS.add("Glass_Artefact/Supplementary/External_camera_file_names_and_attachment");
DATA_REFS.add("Glass_Artefact/Supplementary/External_camera_image_attachment");
DATA_REFS.add("Glass_Artefact/Supplementary/Survey_job_name");
DATA_REFS.add("Glass_Artefact/Supplementary/Survey_instrument_name");
DATA_REFS.add("Glass_Artefact/Supplementary/Survey_instrument_point_codes");
DATA_REFS.add("Glass_Artefact/Supplementary/Related_site_name");
DATA_REFS.add("Glass_Artefact/Supplementary/Sample_context");
DATA_REFS.add("Glass_Artefact/Supplementary/Other_contextual_details");
DATA_REFS.add("Ceramic_Artefact/General/Ceramic_Artefact_ID");
DATA_REFS.add("Ceramic_Artefact/General/Ceramic_Artefact_author");
DATA_REFS.add("Ceramic_Artefact/General/Ceramic_Artefact_timestamp");
DATA_REFS.add("Ceramic_Artefact/General/Latitude");
DATA_REFS.add("Ceramic_Artefact/General/Longitude");
DATA_REFS.add("Ceramic_Artefact/General/Northing");
DATA_REFS.add("Ceramic_Artefact/General/Easting");
DATA_REFS.add("Ceramic_Artefact/General/Accuracy");
DATA_REFS.add("Ceramic_Artefact/General/Device_photos");
DATA_REFS.add("Ceramic_Artefact/General/Landform_element");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Diagnostic");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Technological_ware_type");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Element");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Form");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Completeness");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Function");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Length_mm");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Width_mm");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Thickness_mm");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Base_diameter_mm");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Rim_diameter_mm");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Paste_colour");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Glaze_type");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Decorative_methods");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Decorative_colours");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Visible_motifs");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Flaws");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Decorative_pattern_name");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Maker_s_marks_or_trademarks");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Start_date");
DATA_REFS.add("Ceramic_Artefact/Feature_details/End_date");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Conjoin_information");
DATA_REFS.add("Ceramic_Artefact/Feature_details/References");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Grouped_fragment_count");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Grouped_fragment_weight_g");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Group_max_fragment_length_mm");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Group_max_fragment_width_mm");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Group_max_fragment_thickness_mm");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Group_min_fragment_length_mm");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Group_min_fragment_width_mm");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Group_min_fragment_thickness_mm");
DATA_REFS.add("Ceramic_Artefact/Feature_details/Grouped_fragments_additional_comments");
DATA_REFS.add("Ceramic_Artefact/Supplementary/External_camera_ID");
DATA_REFS.add("Ceramic_Artefact/Supplementary/External_camera_file_names_and_attachment");
DATA_REFS.add("Ceramic_Artefact/Supplementary/External_camera_image_attachment");
DATA_REFS.add("Ceramic_Artefact/Supplementary/Survey_job_name");
DATA_REFS.add("Ceramic_Artefact/Supplementary/Survey_instrument_name");
DATA_REFS.add("Ceramic_Artefact/Supplementary/Survey_instrument_point_codes");
DATA_REFS.add("Ceramic_Artefact/Supplementary/Related_site_name");
DATA_REFS.add("Ceramic_Artefact/Supplementary/Sample_context");
DATA_REFS.add("Ceramic_Artefact/Supplementary/Other_contextual_details");
DATA_REFS.add("Misc_Artefact/General/Misc_Artefact_ID");
DATA_REFS.add("Misc_Artefact/General/Misc_Artefact_author");
DATA_REFS.add("Misc_Artefact/General/Misc_Artefact_timestamp");
DATA_REFS.add("Misc_Artefact/General/Latitude");
DATA_REFS.add("Misc_Artefact/General/Longitude");
DATA_REFS.add("Misc_Artefact/General/Northing");
DATA_REFS.add("Misc_Artefact/General/Easting");
DATA_REFS.add("Misc_Artefact/General/Accuracy");
DATA_REFS.add("Misc_Artefact/General/Device_photos");
DATA_REFS.add("Misc_Artefact/General/Landform_element");
DATA_REFS.add("Misc_Artefact/Feature_details/Material");
DATA_REFS.add("Misc_Artefact/Feature_details/Type");
DATA_REFS.add("Misc_Artefact/Feature_details/Length_mm");
DATA_REFS.add("Misc_Artefact/Feature_details/Width_mm");
DATA_REFS.add("Misc_Artefact/Feature_details/Thickness_mm");
DATA_REFS.add("Misc_Artefact/Feature_details/Height_mm");
DATA_REFS.add("Misc_Artefact/Feature_details/Maker_s_marks_or_trademarks");
DATA_REFS.add("Misc_Artefact/Feature_details/Start_date");
DATA_REFS.add("Misc_Artefact/Feature_details/End_date");
DATA_REFS.add("Misc_Artefact/Feature_details/Additional_notes");
DATA_REFS.add("Misc_Artefact/Supplementary/External_camera_ID");
DATA_REFS.add("Misc_Artefact/Supplementary/External_camera_file_names_and_attachment");
DATA_REFS.add("Misc_Artefact/Supplementary/External_camera_image_attachment");
DATA_REFS.add("Misc_Artefact/Supplementary/Survey_job_name");
DATA_REFS.add("Misc_Artefact/Supplementary/Survey_instrument_name");
DATA_REFS.add("Misc_Artefact/Supplementary/Survey_instrument_point_codes");
DATA_REFS.add("Misc_Artefact/Supplementary/Related_site_name");
DATA_REFS.add("Misc_Artefact/Supplementary/Sample_context");
DATA_REFS.add("Misc_Artefact/Supplementary/Other_contextual_details");
DATA_REFS.add("Discrete_Hearth_Artefact/General/Discrete_Hearth_Artefact_ID");
DATA_REFS.add("Discrete_Hearth_Artefact/General/Discrete_Hearth_Artefact_author");
DATA_REFS.add("Discrete_Hearth_Artefact/General/Discrete_Hearth_Artefact_timestamp");
DATA_REFS.add("Discrete_Hearth_Artefact/General/Latitude");
DATA_REFS.add("Discrete_Hearth_Artefact/General/Longitude");
DATA_REFS.add("Discrete_Hearth_Artefact/General/Northing");
DATA_REFS.add("Discrete_Hearth_Artefact/General/Easting");
DATA_REFS.add("Discrete_Hearth_Artefact/General/Accuracy");
DATA_REFS.add("Discrete_Hearth_Artefact/General/Device_photos");
DATA_REFS.add("Discrete_Hearth_Artefact/General/Landform_element");
DATA_REFS.add("Discrete_Hearth_Artefact/Feature_details/Hearth_type");
DATA_REFS.add("Discrete_Hearth_Artefact/Feature_details/Heating_element_types");
DATA_REFS.add("Discrete_Hearth_Artefact/Feature_details/Heating_element_frequency");
DATA_REFS.add("Discrete_Hearth_Artefact/Feature_details/Materials_present");
DATA_REFS.add("Discrete_Hearth_Artefact/Feature_details/Diameter_mm");
DATA_REFS.add("Discrete_Hearth_Artefact/Feature_details/Additional_notes");
DATA_REFS.add("Discrete_Hearth_Artefact/Supplementary/External_camera_ID");
DATA_REFS.add("Discrete_Hearth_Artefact/Supplementary/External_camera_file_names_and_attachment");
DATA_REFS.add("Discrete_Hearth_Artefact/Supplementary/External_camera_image_attachment");
DATA_REFS.add("Discrete_Hearth_Artefact/Supplementary/Survey_job_name");
DATA_REFS.add("Discrete_Hearth_Artefact/Supplementary/Survey_instrument_name");
DATA_REFS.add("Discrete_Hearth_Artefact/Supplementary/Survey_instrument_point_codes");
DATA_REFS.add("Discrete_Hearth_Artefact/Supplementary/Related_site_name");
DATA_REFS.add("Discrete_Hearth_Artefact/Supplementary/Sample_context");
DATA_REFS.add("Discrete_Hearth_Artefact/Supplementary/Other_contextual_details");
DATA_REFS.add("Buttons/General/Buttons_ID");
DATA_REFS.add("Buttons/General/Buttons_author");
DATA_REFS.add("Buttons/General/Buttons_timestamp");
DATA_REFS.add("Buttons/General/Latitude");
DATA_REFS.add("Buttons/General/Longitude");
DATA_REFS.add("Buttons/General/Northing");
DATA_REFS.add("Buttons/General/Easting");
DATA_REFS.add("Buttons/General/Accuracy");
DATA_REFS.add("Buttons/General/Device_photos");
DATA_REFS.add("Buttons/General/Landform_element");
DATA_REFS.add("Buttons/Feature_details/Material_type");
DATA_REFS.add("Buttons/Feature_details/Attachment_method");
DATA_REFS.add("Buttons/Feature_details/Ligne_size_mm");
DATA_REFS.add("Buttons/Feature_details/Manufacture_method");
DATA_REFS.add("Buttons/Feature_details/Construction");
DATA_REFS.add("Buttons/Feature_details/Shank_type");
DATA_REFS.add("Buttons/Feature_details/Sew_through_type");
DATA_REFS.add("Buttons/Feature_details/Number_of_eyes");
DATA_REFS.add("Buttons/Feature_details/Motifs");
DATA_REFS.add("Buttons/Feature_details/Maker_s_marks_or_trademarks");
DATA_REFS.add("Buttons/Feature_details/Start_date");
DATA_REFS.add("Buttons/Feature_details/End_date");
DATA_REFS.add("Buttons/Feature_details/Additional_notes");
DATA_REFS.add("Buttons/Feature_details/References");
DATA_REFS.add("Buttons/Supplementary/External_camera_ID");
DATA_REFS.add("Buttons/Supplementary/External_camera_file_names_and_attachment");
DATA_REFS.add("Buttons/Supplementary/External_camera_image_attachment");
DATA_REFS.add("Buttons/Supplementary/Survey_job_name");
DATA_REFS.add("Buttons/Supplementary/Survey_instrument_name");
DATA_REFS.add("Buttons/Supplementary/Survey_instrument_point_codes");
DATA_REFS.add("Buttons/Supplementary/Related_site_name");
DATA_REFS.add("Buttons/Supplementary/Sample_context");
DATA_REFS.add("Buttons/Supplementary/Other_contextual_details");
DATA_REFS.add("Knapped_Glass_Artefact/General/Knapped_Glass_Artefact_ID");
DATA_REFS.add("Knapped_Glass_Artefact/General/Knapped_Glass_Artefact_author");
DATA_REFS.add("Knapped_Glass_Artefact/General/Knapped_Glass_Artefact_timestamp");
DATA_REFS.add("Knapped_Glass_Artefact/General/Latitude");
DATA_REFS.add("Knapped_Glass_Artefact/General/Longitude");
DATA_REFS.add("Knapped_Glass_Artefact/General/Northing");
DATA_REFS.add("Knapped_Glass_Artefact/General/Easting");
DATA_REFS.add("Knapped_Glass_Artefact/General/Accuracy");
DATA_REFS.add("Knapped_Glass_Artefact/General/Device_photos");
DATA_REFS.add("Knapped_Glass_Artefact/General/Landform_element");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Type");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Glass_type");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Bottle_part");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Glass_colour");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Completeness");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Max_length_mm");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Max_width_mm");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Max_thickness_mm");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Weight_g");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Burned");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Patination");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Additional_notes");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Start_date");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/End_date");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Scar_count");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Largest_scar_length_mm");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Largest_scar_width_mm");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Core_type");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Original_base_diameter");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Platform_type");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Platform_depth_mm");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Platform_width_mm");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Distal_termination");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Cortex_percent");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Dorsal_scar_count");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Conjoin");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Refit");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Edge_damage");
DATA_REFS.add("Knapped_Glass_Artefact/Feature_details/Abrasion");
DATA_REFS.add("Knapped_Glass_Artefact/Supplementary/External_camera_ID");
DATA_REFS.add("Knapped_Glass_Artefact/Supplementary/External_camera_file_names_and_attachment");
DATA_REFS.add("Knapped_Glass_Artefact/Supplementary/External_camera_image_attachment");
DATA_REFS.add("Knapped_Glass_Artefact/Supplementary/Survey_instrument_name");
DATA_REFS.add("Knapped_Glass_Artefact/Supplementary/Survey_instrument_point_codes");
DATA_REFS.add("Knapped_Glass_Artefact/Supplementary/Related_site_name");
DATA_REFS.add("Knapped_Glass_Artefact/Supplementary/Sample_context");
DATA_REFS.add("Knapped_Glass_Artefact/Supplementary/Other_contextual_details");
DATA_REFS.add("Metal_Artefact/General/Metal_Artefact_ID");
DATA_REFS.add("Metal_Artefact/General/Metal_Artefact_author");
DATA_REFS.add("Metal_Artefact/General/Metal_Artefact_timestamp");
DATA_REFS.add("Metal_Artefact/General/Latitude");
DATA_REFS.add("Metal_Artefact/General/Longitude");
DATA_REFS.add("Metal_Artefact/General/Northing");
DATA_REFS.add("Metal_Artefact/General/Easting");
DATA_REFS.add("Metal_Artefact/General/Accuracy");
DATA_REFS.add("Metal_Artefact/General/Device_photos");
DATA_REFS.add("Metal_Artefact/General/Landform_element");
DATA_REFS.add("Metal_Artefact/Feature_details/Metal_type");
DATA_REFS.add("Metal_Artefact/Feature_details/Metal_completeness");
DATA_REFS.add("Metal_Artefact/Feature_details/Object_type");
DATA_REFS.add("Metal_Artefact/Feature_details/Length_mm");
DATA_REFS.add("Metal_Artefact/Feature_details/Width_mm");
DATA_REFS.add("Metal_Artefact/Feature_details/Thickness_mm");
DATA_REFS.add("Metal_Artefact/Feature_details/Weight_g");
DATA_REFS.add("Metal_Artefact/Feature_details/Maker_s_marks_or_trademarks");
DATA_REFS.add("Metal_Artefact/Feature_details/Modification_or_re_use");
DATA_REFS.add("Metal_Artefact/Feature_details/Start_date");
DATA_REFS.add("Metal_Artefact/Feature_details/End_date");
DATA_REFS.add("Metal_Artefact/Feature_details/Additional_notes");
DATA_REFS.add("Metal_Artefact/Feature_details/References");
DATA_REFS.add("Metal_Artefact/Feature_details/Form");
DATA_REFS.add("Metal_Artefact/Feature_details/Head_shape");
DATA_REFS.add("Metal_Artefact/Feature_details/Shaft_shape");
DATA_REFS.add("Metal_Artefact/Feature_details/Manufacture_method");
DATA_REFS.add("Metal_Artefact/Feature_details/Size_class");
DATA_REFS.add("Metal_Artefact/Feature_details/Features");
DATA_REFS.add("Metal_Artefact/Feature_details/Frame_type");
DATA_REFS.add("Metal_Artefact/Feature_details/Frame_shape");
DATA_REFS.add("Metal_Artefact/Feature_details/Pin");
DATA_REFS.add("Metal_Artefact/Feature_details/Tongue");
DATA_REFS.add("Metal_Artefact/Feature_details/Decoration_type");
DATA_REFS.add("Metal_Artefact/Feature_details/Decorative_motifs");
DATA_REFS.add("Metal_Artefact/Supplementary/External_camera_ID");
DATA_REFS.add("Metal_Artefact/Supplementary/External_camera_file_names_and_attachment");
DATA_REFS.add("Metal_Artefact/Supplementary/External_camera_image_attachment");
DATA_REFS.add("Metal_Artefact/Supplementary/Survey_instrument_name");
DATA_REFS.add("Metal_Artefact/Supplementary/Survey_instrument_point_codes");
DATA_REFS.add("Metal_Artefact/Supplementary/Related_site_name");
DATA_REFS.add("Metal_Artefact/Supplementary/Sample_context");
DATA_REFS.add("Metal_Artefact/Supplementary/Other_contextual_details");
DATA_REFS.add("Weapons_and_Ammunition/General/Weapons_and_Ammunition_ID");
DATA_REFS.add("Weapons_and_Ammunition/General/Weapons_and_Ammunition_author");
DATA_REFS.add("Weapons_and_Ammunition/General/Weapons_and_Ammunition_timestamp");
DATA_REFS.add("Weapons_and_Ammunition/General/Latitude");
DATA_REFS.add("Weapons_and_Ammunition/General/Longitude");
DATA_REFS.add("Weapons_and_Ammunition/General/Northing");
DATA_REFS.add("Weapons_and_Ammunition/General/Easting");
DATA_REFS.add("Weapons_and_Ammunition/General/Accuracy");
DATA_REFS.add("Weapons_and_Ammunition/General/Device_photos");
DATA_REFS.add("Weapons_and_Ammunition/General/Landform_element");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/Object");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/Completeness");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/Material");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/Length_mm");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/Width_mm");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/Thickness_mm");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/Weight_g");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/Weight_grains_1_gram_is_15_4324_grains");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/Gun_part");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/Crown_or_head_stamps");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/Other_trademarks");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/Start_date");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/End_date");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/Additional_notes");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/References");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/Projectile_type");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/Deformation");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/Rifling_grooves");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/Mould_seams_sprue_marks");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/Number_of_grooves");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/Base");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/Body");
DATA_REFS.add("Weapons_and_Ammunition/Feature_details/Firing_mechanism");
DATA_REFS.add("Weapons_and_Ammunition/Supplementary/External_camera_ID");
DATA_REFS.add("Weapons_and_Ammunition/Supplementary/External_camera_file_names_and_attachment");
DATA_REFS.add("Weapons_and_Ammunition/Supplementary/External_camera_image_attachment");
DATA_REFS.add("Weapons_and_Ammunition/Supplementary/Survey_instrument_name");
DATA_REFS.add("Weapons_and_Ammunition/Supplementary/Survey_instrument_point_codes");
DATA_REFS.add("Weapons_and_Ammunition/Supplementary/Related_site_name");
DATA_REFS.add("Weapons_and_Ammunition/Supplementary/Sample_context");
DATA_REFS.add("Weapons_and_Ammunition/Supplementary/Other_contextual_details");







HIER_REFS.add("Flaked_Stone_Artefact/General/Landform_element");
HIER_REFS.add("Other_Stone_Artefact/General/Landform_element");
HIER_REFS.add("Glass_Artefact/General/Landform_element");
HIER_REFS.add("Ceramic_Artefact/General/Landform_element");
HIER_REFS.add("Misc_Artefact/General/Landform_element");
HIER_REFS.add("Discrete_Hearth_Artefact/General/Landform_element");
HIER_REFS.add("Buttons/General/Landform_element");
HIER_REFS.add("Knapped_Glass_Artefact/General/Landform_element");
HIER_REFS.add("Metal_Artefact/General/Landform_element");
HIER_REFS.add("Metal_Artefact/Feature_details/Object_type");
HIER_REFS.add("Weapons_and_Ammunition/General/Landform_element");

TAB_GROUPS_AS_LIST.add("User_List");
TAB_GROUPS_AS_LIST.add("Control");
TAB_GROUPS_AS_LIST.add("Flaked_Stone_Artefact");
TAB_GROUPS_AS_LIST.add("Other_Stone_Artefact");
TAB_GROUPS_AS_LIST.add("Glass_Artefact");
TAB_GROUPS_AS_LIST.add("Ceramic_Artefact");
TAB_GROUPS_AS_LIST.add("Misc_Artefact");
TAB_GROUPS_AS_LIST.add("Discrete_Hearth_Artefact");
TAB_GROUPS_AS_LIST.add("Buttons");
TAB_GROUPS_AS_LIST.add("Knapped_Glass_Artefact");
TAB_GROUPS_AS_LIST.add("Metal_Artefact");
TAB_GROUPS_AS_LIST.add("Weapons_and_Ammunition");

TABS_AS_LIST.add("User_List/User_List");
TABS_AS_LIST.add("Control/Control");
TABS_AS_LIST.add("Control/Map");
TABS_AS_LIST.add("Control/Recent");
TABS_AS_LIST.add("Control/Search");
TABS_AS_LIST.add("Control/Autonumbering");
TABS_AS_LIST.add("Flaked_Stone_Artefact/General");
TABS_AS_LIST.add("Flaked_Stone_Artefact/Feature_details");
TABS_AS_LIST.add("Flaked_Stone_Artefact/Supplementary");
TABS_AS_LIST.add("Other_Stone_Artefact/General");
TABS_AS_LIST.add("Other_Stone_Artefact/Feature_details");
TABS_AS_LIST.add("Other_Stone_Artefact/Supplementary");
TABS_AS_LIST.add("Glass_Artefact/General");
TABS_AS_LIST.add("Glass_Artefact/Feature_details");
TABS_AS_LIST.add("Glass_Artefact/Supplementary");
TABS_AS_LIST.add("Ceramic_Artefact/General");
TABS_AS_LIST.add("Ceramic_Artefact/Feature_details");
TABS_AS_LIST.add("Ceramic_Artefact/Supplementary");
TABS_AS_LIST.add("Misc_Artefact/General");
TABS_AS_LIST.add("Misc_Artefact/Feature_details");
TABS_AS_LIST.add("Misc_Artefact/Supplementary");
TABS_AS_LIST.add("Discrete_Hearth_Artefact/General");
TABS_AS_LIST.add("Discrete_Hearth_Artefact/Feature_details");
TABS_AS_LIST.add("Discrete_Hearth_Artefact/Supplementary");
TABS_AS_LIST.add("Buttons/General");
TABS_AS_LIST.add("Buttons/Feature_details");
TABS_AS_LIST.add("Buttons/Supplementary");
TABS_AS_LIST.add("Knapped_Glass_Artefact/General");
TABS_AS_LIST.add("Knapped_Glass_Artefact/Feature_details");
TABS_AS_LIST.add("Knapped_Glass_Artefact/Supplementary");
TABS_AS_LIST.add("Metal_Artefact/General");
TABS_AS_LIST.add("Metal_Artefact/Feature_details");
TABS_AS_LIST.add("Metal_Artefact/Supplementary");
TABS_AS_LIST.add("Weapons_and_Ammunition/General");
TABS_AS_LIST.add("Weapons_and_Ammunition/Feature_details");
TABS_AS_LIST.add("Weapons_and_Ammunition/Supplementary");

ATTRIB_NAMES_NON_STANDARD.put("Flaked_Stone_Artefact/Feature_details/Raw_material_type", "Flaked Stone Artefact Raw material type");
ATTRIB_NAMES_NON_STANDARD.put("Flaked_Stone_Artefact/Feature_details/Weight_g", "Flaked Stone Artefact Weight g");
ATTRIB_NAMES_NON_STANDARD.put("Flaked_Stone_Artefact/Feature_details/Platform_width_mm", "Flaked Stone Artefact Platform width mm");
ATTRIB_NAMES_NON_STANDARD.put("Flaked_Stone_Artefact/Feature_details/Dorsal_scar_count", "Flaked Stone Artefact Dorsal scar count");
ATTRIB_NAMES_NON_STANDARD.put("Flaked_Stone_Artefact/Feature_details/Additional_notes", "Flaked Stone Artefact Additional notes");
ATTRIB_NAMES_NON_STANDARD.put("Other_Stone_Artefact/Feature_details/Raw_material_type", "Other Stone Artefact Raw material type");
ATTRIB_NAMES_NON_STANDARD.put("Other_Stone_Artefact/Feature_details/Completeness", "Other Stone Artefact Completeness");
ATTRIB_NAMES_NON_STANDARD.put("Other_Stone_Artefact/Feature_details/Weight_g", "Other Stone Artefact Weight g");
ATTRIB_NAMES_NON_STANDARD.put("Other_Stone_Artefact/Feature_details/Type", "Other Stone Artefact Type");
ATTRIB_NAMES_NON_STANDARD.put("Other_Stone_Artefact/Feature_details/Length_mm", "Other Stone Artefact Length mm");
ATTRIB_NAMES_NON_STANDARD.put("Other_Stone_Artefact/Feature_details/Width_mm", "Other Stone Artefact Width mm");
ATTRIB_NAMES_NON_STANDARD.put("Other_Stone_Artefact/Feature_details/Thickness_mm", "Other Stone Artefact Thickness mm");
ATTRIB_NAMES_NON_STANDARD.put("Other_Stone_Artefact/Feature_details/Largest_scar_length_mm", "Other Stone Artefact Largest scar length mm");
ATTRIB_NAMES_NON_STANDARD.put("Other_Stone_Artefact/Feature_details/Additional_notes", "Other Stone Artefact Additional notes");
ATTRIB_NAMES_NON_STANDARD.put("Glass_Artefact/Feature_details/Diagnostic", "Glass Artefact Diagnostic");
ATTRIB_NAMES_NON_STANDARD.put("Glass_Artefact/Feature_details/Completeness", "Glass Artefact Completeness");
ATTRIB_NAMES_NON_STANDARD.put("Glass_Artefact/Feature_details/Object_type", "Glass Artefact Object type");
ATTRIB_NAMES_NON_STANDARD.put("Glass_Artefact/Feature_details/Length_mm", "Glass Artefact Length mm");
ATTRIB_NAMES_NON_STANDARD.put("Glass_Artefact/Feature_details/Width_mm", "Glass Artefact Width mm");
ATTRIB_NAMES_NON_STANDARD.put("Glass_Artefact/Feature_details/Thickness_mm", "Glass Artefact Thickness mm");
ATTRIB_NAMES_NON_STANDARD.put("Glass_Artefact/Feature_details/Base_diameter_mm", "Glass Artefact Base diameter mm");
ATTRIB_NAMES_NON_STANDARD.put("Ceramic_Artefact/Feature_details/Diagnostic", "Ceramic Artefact Diagnostic");
ATTRIB_NAMES_NON_STANDARD.put("Ceramic_Artefact/Feature_details/Form", "Ceramic Artefact Form");
ATTRIB_NAMES_NON_STANDARD.put("Ceramic_Artefact/Feature_details/Completeness", "Ceramic Artefact Completeness");
ATTRIB_NAMES_NON_STANDARD.put("Ceramic_Artefact/Feature_details/Length_mm", "Ceramic Artefact Length mm");
ATTRIB_NAMES_NON_STANDARD.put("Ceramic_Artefact/Feature_details/Width_mm", "Ceramic Artefact Width mm");
ATTRIB_NAMES_NON_STANDARD.put("Ceramic_Artefact/Feature_details/Thickness_mm", "Ceramic Artefact Thickness mm");
ATTRIB_NAMES_NON_STANDARD.put("Ceramic_Artefact/Feature_details/Base_diameter_mm", "Ceramic Artefact Base diameter mm");
ATTRIB_NAMES_NON_STANDARD.put("Misc_Artefact/Feature_details/Material", "Misc Artefact Material");
ATTRIB_NAMES_NON_STANDARD.put("Misc_Artefact/Feature_details/Type", "Misc Artefact Type");
ATTRIB_NAMES_NON_STANDARD.put("Misc_Artefact/Feature_details/Length_mm", "Misc Artefact Length mm");
ATTRIB_NAMES_NON_STANDARD.put("Misc_Artefact/Feature_details/Width_mm", "Misc Artefact Width mm");
ATTRIB_NAMES_NON_STANDARD.put("Misc_Artefact/Feature_details/Thickness_mm", "Misc Artefact Thickness mm");
ATTRIB_NAMES_NON_STANDARD.put("Misc_Artefact/Feature_details/Additional_notes", "Misc Artefact Additional notes");
ATTRIB_NAMES_NON_STANDARD.put("Discrete_Hearth_Artefact/Feature_details/Additional_notes", "Discrete Hearth Artefact Additional notes");
ATTRIB_NAMES_NON_STANDARD.put("Buttons/Feature_details/Manufacture_method", "Buttons Manufacture method");
ATTRIB_NAMES_NON_STANDARD.put("Buttons/Feature_details/Additional_notes", "Buttons Additional notes");
ATTRIB_NAMES_NON_STANDARD.put("Knapped_Glass_Artefact/Feature_details/Type", "Knapped Glass Artefact Type");
ATTRIB_NAMES_NON_STANDARD.put("Knapped_Glass_Artefact/Feature_details/Completeness", "Knapped Glass Artefact Completeness");
ATTRIB_NAMES_NON_STANDARD.put("Knapped_Glass_Artefact/Feature_details/Weight_g", "Knapped Glass Artefact Weight g");
ATTRIB_NAMES_NON_STANDARD.put("Knapped_Glass_Artefact/Feature_details/Additional_notes", "Knapped Glass Artefact Additional notes");
ATTRIB_NAMES_NON_STANDARD.put("Knapped_Glass_Artefact/Feature_details/Largest_scar_length_mm", "Knapped Glass Artefact Largest scar length mm");
ATTRIB_NAMES_NON_STANDARD.put("Knapped_Glass_Artefact/Feature_details/Platform_width_mm", "Knapped Glass Artefact Platform width mm");
ATTRIB_NAMES_NON_STANDARD.put("Knapped_Glass_Artefact/Feature_details/Dorsal_scar_count", "Knapped Glass Artefact Dorsal scar count");
ATTRIB_NAMES_NON_STANDARD.put("Metal_Artefact/Feature_details/Object_type", "Metal Artefact Object type");
ATTRIB_NAMES_NON_STANDARD.put("Metal_Artefact/Feature_details/Length_mm", "Metal Artefact Length mm");
ATTRIB_NAMES_NON_STANDARD.put("Metal_Artefact/Feature_details/Width_mm", "Metal Artefact Width mm");
ATTRIB_NAMES_NON_STANDARD.put("Metal_Artefact/Feature_details/Thickness_mm", "Metal Artefact Thickness mm");
ATTRIB_NAMES_NON_STANDARD.put("Metal_Artefact/Feature_details/Weight_g", "Metal Artefact Weight g");
ATTRIB_NAMES_NON_STANDARD.put("Metal_Artefact/Feature_details/Additional_notes", "Metal Artefact Additional notes");
ATTRIB_NAMES_NON_STANDARD.put("Metal_Artefact/Feature_details/Form", "Metal Artefact Form");
ATTRIB_NAMES_NON_STANDARD.put("Metal_Artefact/Feature_details/Manufacture_method", "Metal Artefact Manufacture method");
ATTRIB_NAMES_NON_STANDARD.put("Weapons_and_Ammunition/Feature_details/Completeness", "Weapons and Ammunition Completeness");
ATTRIB_NAMES_NON_STANDARD.put("Weapons_and_Ammunition/Feature_details/Material", "Weapons and Ammunition Material");
ATTRIB_NAMES_NON_STANDARD.put("Weapons_and_Ammunition/Feature_details/Length_mm", "Weapons and Ammunition Length mm");
ATTRIB_NAMES_NON_STANDARD.put("Weapons_and_Ammunition/Feature_details/Width_mm", "Weapons and Ammunition Width mm");
ATTRIB_NAMES_NON_STANDARD.put("Weapons_and_Ammunition/Feature_details/Thickness_mm", "Weapons and Ammunition Thickness mm");
ATTRIB_NAMES_NON_STANDARD.put("Weapons_and_Ammunition/Feature_details/Weight_g", "Weapons and Ammunition Weight g");
ATTRIB_NAMES_NON_STANDARD.put("Weapons_and_Ammunition/Feature_details/Additional_notes", "Weapons and Ammunition Additional notes");

REF_TO_FLAG_STRING.put("User_List/User_List/User_List", "nolabel user");
REF_TO_FLAG_STRING.put("Control/Control/Flaked_Stone_Artefact", "");
REF_TO_FLAG_STRING.put("Control/Control/Other_Stone_Artefact", "");
REF_TO_FLAG_STRING.put("Control/Control/Knapped_Glass_Artefact", "");
REF_TO_FLAG_STRING.put("Control/Control/Discrete_Hearth_Feature", "");
REF_TO_FLAG_STRING.put("Control/Control/Glass_Artefact", "");
REF_TO_FLAG_STRING.put("Control/Control/Ceramic_Artefact", "");
REF_TO_FLAG_STRING.put("Control/Control/Buttons", "");
REF_TO_FLAG_STRING.put("Control/Control/Metal_Artefact", "");
REF_TO_FLAG_STRING.put("Control/Control/Weapons_and_Ammunition", "");
REF_TO_FLAG_STRING.put("Control/Control/Misc_Artefact", "");
REF_TO_FLAG_STRING.put("Control/Control/GPS_diagnostics", "");
REF_TO_FLAG_STRING.put("Control/Map/Map", "nolabel");
REF_TO_FLAG_STRING.put("Control/Map/Center_Me_1", "");
REF_TO_FLAG_STRING.put("Control/Map/Save_Map_Settings_1", "");
REF_TO_FLAG_STRING.put("Control/Recent/Recent_records", "");
REF_TO_FLAG_STRING.put("Control/Search/Search_Term", "");
REF_TO_FLAG_STRING.put("Control/Search/Search_Button", "");
REF_TO_FLAG_STRING.put("Control/Search/Entity_Types", "");
REF_TO_FLAG_STRING.put("Control/Search/Entity_List", "");
REF_TO_FLAG_STRING.put("Control/Autonumbering/Next_Flaked_Stone_Artefact_ID", "notnull");
REF_TO_FLAG_STRING.put("Control/Autonumbering/Next_Other_Stone_Artefact_ID", "notnull");
REF_TO_FLAG_STRING.put("Control/Autonumbering/Next_Glass_Artefact_ID", "notnull");
REF_TO_FLAG_STRING.put("Control/Autonumbering/Next_Ceramic_Artefact_ID", "notnull");
REF_TO_FLAG_STRING.put("Control/Autonumbering/Next_Misc_Artefact_ID", "notnull");
REF_TO_FLAG_STRING.put("Control/Autonumbering/Next_Discrete_Hearth_Artefact_ID", "notnull");
REF_TO_FLAG_STRING.put("Control/Autonumbering/Next_Buttons_ID", "notnull");
REF_TO_FLAG_STRING.put("Control/Autonumbering/Next_Knapped_Glass_Artefact_ID", "notnull");
REF_TO_FLAG_STRING.put("Control/Autonumbering/Next_Metal_Artefact_ID", "notnull");
REF_TO_FLAG_STRING.put("Control/Autonumbering/Next_Weapons_and_Ammunition_ID", "notnull");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/General/Flaked_Stone_Artefact_ID", "autonum id nocertainty");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/General/Flaked_Stone_Artefact_author", "readonly nocertainty");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/General/Flaked_Stone_Artefact_timestamp", "readonly noannotation nocertainty");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/General/Latitude", "readonly notnull");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/General/Longitude", "readonly notnull");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/General/Northing", "readonly notnull");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/General/Easting", "readonly notnull");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/General/Accuracy", "readonly notnull");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/General/Take_From_GPS_1", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/General/Find_This_in_The_Map", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/General/Device_photos", "nocertainty");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/General/Device_photos_Button_1", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/General/Landform_element", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details/Raw_material_type", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details/Raw_material_colour", "noannotation nocertainty");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details/Weight_g", "nocertainty");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details/Flake_completeness", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details/Platform_surface", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details/Platform_angle", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details/Platform_width_mm", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details/Platform_thickness_mm", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details/Maximum_length_mm", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details/Maximum_width_mm", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details/Maximum_thickness_mm", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details/Termination_type", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details/Overhang_removal", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details/Dorsal_cortex_type", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details/Dorsal_cortex_amount", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details/Dorsal_scar_count", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details/Dorsal_scar_direction", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details/Dorsal_flake_scar_maximum_length", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details/Retouched_quadrants", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details/Retouch_initiation", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details/Retouch_shape", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details/Additional_notes", "noannotation nocertainty");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Supplementary/External_camera_ID", "nocertainty");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Supplementary/External_camera_file_names_and_attachment", "nocertainty");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Supplementary/External_camera_image_attachment", "nocertainty");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Supplementary/External_camera_image_attachment_Button_1", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Supplementary/Survey_job_name", "noannotation");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Supplementary/Survey_instrument_name", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Supplementary/Survey_instrument_point_codes", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Supplementary/Related_site_name", "noannotation");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Supplementary/Sample_context", "noannotation");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Supplementary/Other_contextual_details", "noannotation");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/General/Other_Stone_Artefact_ID", "autonum id nocertainty");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/General/Other_Stone_Artefact_author", "readonly nocertainty");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/General/Other_Stone_Artefact_timestamp", "readonly noannotation nocertainty");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/General/Latitude", "readonly notnull");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/General/Longitude", "readonly notnull");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/General/Northing", "readonly notnull");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/General/Easting", "readonly notnull");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/General/Accuracy", "readonly notnull");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/General/Take_From_GPS_1", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/General/Find_This_in_The_Map", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/General/Device_photos", "nocertainty");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/General/Device_photos_Button_1", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/General/Landform_element", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Raw_material_type", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Raw_material_colour", "noannotation nocertainty");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Completeness", "nocertainty");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Weight_g", "nocertainty");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Type", "nocertainty");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Length_mm", "nocertainty");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Width_mm", "nocertainty");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Thickness_mm", "nocertainty");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Largest_scar_length_mm", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Core_largest_scar_shape", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Core_platform_count", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Core_platform_1_surface", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Core_platform_1_length_mm", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Core_platform_1_width_mm", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Core_platform_1_angle_mm", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Core_platform_2_surface", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Core_platform_2_length_mm", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Core_platform_2_width_mm", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Core_platform_2_angle", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Core_classification", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Remaining_cortical_surface", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Usewear", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details/Additional_notes", "noannotation nocertainty");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Supplementary/External_camera_ID", "nocertainty");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Supplementary/External_camera_file_names_and_attachment", "nocertainty");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Supplementary/External_camera_image_attachment", "nocertainty");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Supplementary/External_camera_image_attachment_Button_1", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Supplementary/Survey_job_name", "noannotation");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Supplementary/Survey_instrument_name", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Supplementary/Survey_instrument_point_codes", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Supplementary/Related_site_name", "noannotation");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Supplementary/Sample_context", "noannotation");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Supplementary/Other_contextual_details", "noannotation");
REF_TO_FLAG_STRING.put("Glass_Artefact/General/Glass_Artefact_ID", "autonum id nocertainty");
REF_TO_FLAG_STRING.put("Glass_Artefact/General/Glass_Artefact_author", "readonly nocertainty");
REF_TO_FLAG_STRING.put("Glass_Artefact/General/Glass_Artefact_timestamp", "readonly noannotation nocertainty");
REF_TO_FLAG_STRING.put("Glass_Artefact/General/Latitude", "readonly notnull");
REF_TO_FLAG_STRING.put("Glass_Artefact/General/Longitude", "readonly notnull");
REF_TO_FLAG_STRING.put("Glass_Artefact/General/Northing", "readonly notnull");
REF_TO_FLAG_STRING.put("Glass_Artefact/General/Easting", "readonly notnull");
REF_TO_FLAG_STRING.put("Glass_Artefact/General/Accuracy", "readonly notnull");
REF_TO_FLAG_STRING.put("Glass_Artefact/General/Take_From_GPS_1", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/General/Find_This_in_The_Map", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/General/Device_photos", "nocertainty");
REF_TO_FLAG_STRING.put("Glass_Artefact/General/Device_photos_Button_1", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/General/Landform_element", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Diagnostic", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Colour", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Completeness", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Grouped_fragments", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Group_notes", "noannotation nocertainty");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Portion_or_component", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Object_type", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Tableware_type", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Length_mm", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Width_mm", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Thickness_mm", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Horizontal_shape", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Probable_contents", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Shoulder_width_mm", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Complete_height_mm", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Number_of_mould_seams", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Mould_type", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Patination_present", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Base_diameter_mm", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Base_thickness_mm", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Pontil_mark_present", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Kickup_depth_mm", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Finish_inner_bore_diameter_mm", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Finish_type", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Closure_type", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Applied_finish", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Trademark", "noannotation nocertainty");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Marks_motifs_and_decoration", "noannotation nocertainty");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Start_date", "noannotation");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/End_date", "noannotation");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Conjoin_information", "noannotation");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/References", "noannotation");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Grouped_fragments_only", "nolabel");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Grouped_fragment_count", "noannotation");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Grouped_fragment_weight_g", "noannotation");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Group_max_fragment_length_mm", "noannotation");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Group_max_fragment_width_mm", "noannotation");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Group_max_fragment_thickness_mm", "noannotation");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Group_min_fragment_length_mm", "noannotation");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Group_min_fragment_width_mm", "noannotation");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Group_min_fragment_thickness_mm", "noannotation");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details/Grouped_fragments_additional_comments", "noannotation");
REF_TO_FLAG_STRING.put("Glass_Artefact/Supplementary/External_camera_ID", "nocertainty");
REF_TO_FLAG_STRING.put("Glass_Artefact/Supplementary/External_camera_file_names_and_attachment", "nocertainty");
REF_TO_FLAG_STRING.put("Glass_Artefact/Supplementary/External_camera_image_attachment", "nocertainty");
REF_TO_FLAG_STRING.put("Glass_Artefact/Supplementary/External_camera_image_attachment_Button_1", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Supplementary/Survey_job_name", "noannotation");
REF_TO_FLAG_STRING.put("Glass_Artefact/Supplementary/Survey_instrument_name", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Supplementary/Survey_instrument_point_codes", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Supplementary/Related_site_name", "noannotation");
REF_TO_FLAG_STRING.put("Glass_Artefact/Supplementary/Sample_context", "noannotation");
REF_TO_FLAG_STRING.put("Glass_Artefact/Supplementary/Other_contextual_details", "noannotation");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/General/Ceramic_Artefact_ID", "autonum id nocertainty");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/General/Ceramic_Artefact_author", "readonly nocertainty");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/General/Ceramic_Artefact_timestamp", "readonly noannotation nocertainty");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/General/Latitude", "readonly notnull");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/General/Longitude", "readonly notnull");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/General/Northing", "readonly notnull");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/General/Easting", "readonly notnull");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/General/Accuracy", "readonly notnull");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/General/Take_From_GPS_1", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/General/Find_This_in_The_Map", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/General/Device_photos", "nocertainty");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/General/Device_photos_Button_1", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/General/Landform_element", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Diagnostic", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Technological_ware_type", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Element", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Form", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Completeness", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Function", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Length_mm", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Width_mm", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Thickness_mm", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Base_diameter_mm", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Rim_diameter_mm", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Paste_colour", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Glaze_type", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Decorative_methods", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Decorative_colours", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Visible_motifs", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Flaws", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Decorative_pattern_name", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Maker_s_marks_or_trademarks", "noannotation");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Start_date", "noannotation");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/End_date", "noannotation");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Conjoin_information", "noannotation");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/References", "noannotation");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Grouped_fragments_only", "nolabel");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Grouped_fragment_count", "noannotation");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Grouped_fragment_weight_g", "noannotation");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Group_max_fragment_length_mm", "noannotation");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Group_max_fragment_width_mm", "noannotation");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Group_max_fragment_thickness_mm", "noannotation");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Group_min_fragment_length_mm", "noannotation");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Group_min_fragment_width_mm", "noannotation");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Group_min_fragment_thickness_mm", "noannotation");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details/Grouped_fragments_additional_comments", "noannotation");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Supplementary/External_camera_ID", "nocertainty");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Supplementary/External_camera_file_names_and_attachment", "nocertainty");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Supplementary/External_camera_image_attachment", "nocertainty");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Supplementary/External_camera_image_attachment_Button_1", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Supplementary/Survey_job_name", "noannotation");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Supplementary/Survey_instrument_name", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Supplementary/Survey_instrument_point_codes", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Supplementary/Related_site_name", "noannotation");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Supplementary/Sample_context", "noannotation");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Supplementary/Other_contextual_details", "noannotation");
REF_TO_FLAG_STRING.put("Misc_Artefact/General/Misc_Artefact_ID", "autonum id nocertainty");
REF_TO_FLAG_STRING.put("Misc_Artefact/General/Misc_Artefact_author", "readonly nocertainty");
REF_TO_FLAG_STRING.put("Misc_Artefact/General/Misc_Artefact_timestamp", "readonly noannotation nocertainty");
REF_TO_FLAG_STRING.put("Misc_Artefact/General/Latitude", "readonly notnull");
REF_TO_FLAG_STRING.put("Misc_Artefact/General/Longitude", "readonly notnull");
REF_TO_FLAG_STRING.put("Misc_Artefact/General/Northing", "readonly notnull");
REF_TO_FLAG_STRING.put("Misc_Artefact/General/Easting", "readonly notnull");
REF_TO_FLAG_STRING.put("Misc_Artefact/General/Accuracy", "readonly notnull");
REF_TO_FLAG_STRING.put("Misc_Artefact/General/Take_From_GPS_1", "");
REF_TO_FLAG_STRING.put("Misc_Artefact/General/Find_This_in_The_Map", "");
REF_TO_FLAG_STRING.put("Misc_Artefact/General/Device_photos", "nocertainty");
REF_TO_FLAG_STRING.put("Misc_Artefact/General/Device_photos_Button_1", "");
REF_TO_FLAG_STRING.put("Misc_Artefact/General/Landform_element", "");
REF_TO_FLAG_STRING.put("Misc_Artefact/Feature_details/Material", "");
REF_TO_FLAG_STRING.put("Misc_Artefact/Feature_details/Type", "noannotation nocertainty");
REF_TO_FLAG_STRING.put("Misc_Artefact/Feature_details/Length_mm", "");
REF_TO_FLAG_STRING.put("Misc_Artefact/Feature_details/Width_mm", "");
REF_TO_FLAG_STRING.put("Misc_Artefact/Feature_details/Thickness_mm", "");
REF_TO_FLAG_STRING.put("Misc_Artefact/Feature_details/Height_mm", "");
REF_TO_FLAG_STRING.put("Misc_Artefact/Feature_details/Maker_s_marks_or_trademarks", "noannotation");
REF_TO_FLAG_STRING.put("Misc_Artefact/Feature_details/Start_date", "noannotation");
REF_TO_FLAG_STRING.put("Misc_Artefact/Feature_details/End_date", "noannotation");
REF_TO_FLAG_STRING.put("Misc_Artefact/Feature_details/Additional_notes", "noannotation nocertainty");
REF_TO_FLAG_STRING.put("Misc_Artefact/Supplementary/External_camera_ID", "nocertainty");
REF_TO_FLAG_STRING.put("Misc_Artefact/Supplementary/External_camera_file_names_and_attachment", "nocertainty");
REF_TO_FLAG_STRING.put("Misc_Artefact/Supplementary/External_camera_image_attachment", "nocertainty");
REF_TO_FLAG_STRING.put("Misc_Artefact/Supplementary/External_camera_image_attachment_Button_1", "");
REF_TO_FLAG_STRING.put("Misc_Artefact/Supplementary/Survey_job_name", "noannotation");
REF_TO_FLAG_STRING.put("Misc_Artefact/Supplementary/Survey_instrument_name", "");
REF_TO_FLAG_STRING.put("Misc_Artefact/Supplementary/Survey_instrument_point_codes", "");
REF_TO_FLAG_STRING.put("Misc_Artefact/Supplementary/Related_site_name", "noannotation");
REF_TO_FLAG_STRING.put("Misc_Artefact/Supplementary/Sample_context", "noannotation");
REF_TO_FLAG_STRING.put("Misc_Artefact/Supplementary/Other_contextual_details", "noannotation");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/General/Discrete_Hearth_Artefact_ID", "autonum id nocertainty");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/General/Discrete_Hearth_Artefact_author", "readonly nocertainty");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/General/Discrete_Hearth_Artefact_timestamp", "readonly noannotation nocertainty");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/General/Latitude", "readonly notnull");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/General/Longitude", "readonly notnull");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/General/Northing", "readonly notnull");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/General/Easting", "readonly notnull");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/General/Accuracy", "readonly notnull");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/General/Take_From_GPS_1", "");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/General/Find_This_in_The_Map", "");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/General/Device_photos", "nocertainty");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/General/Device_photos_Button_1", "");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/General/Landform_element", "");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/Feature_details/Hearth_type", "");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/Feature_details/Heating_element_types", "");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/Feature_details/Heating_element_frequency", "");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/Feature_details/Materials_present", "");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/Feature_details/Diameter_mm", "");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/Feature_details/Additional_notes", "noannotation nocertainty");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/Supplementary/External_camera_ID", "nocertainty");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/Supplementary/External_camera_file_names_and_attachment", "nocertainty");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/Supplementary/External_camera_image_attachment", "nocertainty");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/Supplementary/External_camera_image_attachment_Button_1", "");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/Supplementary/Survey_job_name", "noannotation");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/Supplementary/Survey_instrument_name", "");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/Supplementary/Survey_instrument_point_codes", "");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/Supplementary/Related_site_name", "noannotation");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/Supplementary/Sample_context", "noannotation");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/Supplementary/Other_contextual_details", "noannotation");
REF_TO_FLAG_STRING.put("Buttons/General/Buttons_ID", "autonum nocertainty id");
REF_TO_FLAG_STRING.put("Buttons/General/Buttons_author", "readonly nocertainty");
REF_TO_FLAG_STRING.put("Buttons/General/Buttons_timestamp", "readonly noannotation nocertainty");
REF_TO_FLAG_STRING.put("Buttons/General/Latitude", "readonly notnull");
REF_TO_FLAG_STRING.put("Buttons/General/Longitude", "readonly notnull");
REF_TO_FLAG_STRING.put("Buttons/General/Northing", "readonly notnull");
REF_TO_FLAG_STRING.put("Buttons/General/Easting", "readonly notnull");
REF_TO_FLAG_STRING.put("Buttons/General/Accuracy", "readonly notnull");
REF_TO_FLAG_STRING.put("Buttons/General/Take_From_GPS_1", "");
REF_TO_FLAG_STRING.put("Buttons/General/Find_This_in_The_Map", "");
REF_TO_FLAG_STRING.put("Buttons/General/Device_photos", "nocertainty");
REF_TO_FLAG_STRING.put("Buttons/General/Device_photos_Button_1", "");
REF_TO_FLAG_STRING.put("Buttons/General/Landform_element", "");
REF_TO_FLAG_STRING.put("Buttons/Feature_details/Material_type", "");
REF_TO_FLAG_STRING.put("Buttons/Feature_details/Attachment_method", "");
REF_TO_FLAG_STRING.put("Buttons/Feature_details/Ligne_size_mm", "");
REF_TO_FLAG_STRING.put("Buttons/Feature_details/Manufacture_method", "");
REF_TO_FLAG_STRING.put("Buttons/Feature_details/Construction", "");
REF_TO_FLAG_STRING.put("Buttons/Feature_details/Shank_type", "");
REF_TO_FLAG_STRING.put("Buttons/Feature_details/Sew_through_type", "");
REF_TO_FLAG_STRING.put("Buttons/Feature_details/Number_of_eyes", "");
REF_TO_FLAG_STRING.put("Buttons/Feature_details/Motifs", "noannotation");
REF_TO_FLAG_STRING.put("Buttons/Feature_details/Maker_s_marks_or_trademarks", "noannotation");
REF_TO_FLAG_STRING.put("Buttons/Feature_details/Start_date", "noannotation");
REF_TO_FLAG_STRING.put("Buttons/Feature_details/End_date", "noannotation");
REF_TO_FLAG_STRING.put("Buttons/Feature_details/Additional_notes", "noannotation");
REF_TO_FLAG_STRING.put("Buttons/Feature_details/References", "noannotation");
REF_TO_FLAG_STRING.put("Buttons/Supplementary/External_camera_ID", "nocertainty");
REF_TO_FLAG_STRING.put("Buttons/Supplementary/External_camera_file_names_and_attachment", "nocertainty");
REF_TO_FLAG_STRING.put("Buttons/Supplementary/External_camera_image_attachment", "nocertainty");
REF_TO_FLAG_STRING.put("Buttons/Supplementary/External_camera_image_attachment_Button_1", "");
REF_TO_FLAG_STRING.put("Buttons/Supplementary/Survey_job_name", "noannotation");
REF_TO_FLAG_STRING.put("Buttons/Supplementary/Survey_instrument_name", "");
REF_TO_FLAG_STRING.put("Buttons/Supplementary/Survey_instrument_point_codes", "");
REF_TO_FLAG_STRING.put("Buttons/Supplementary/Related_site_name", "noannotation");
REF_TO_FLAG_STRING.put("Buttons/Supplementary/Sample_context", "noannotation");
REF_TO_FLAG_STRING.put("Buttons/Supplementary/Other_contextual_details", "noannotation");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/General/Knapped_Glass_Artefact_ID", "autonum nocertainty id");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/General/Knapped_Glass_Artefact_author", "readonly nocertainty");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/General/Knapped_Glass_Artefact_timestamp", "readonly noannotation nocertainty");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/General/Latitude", "readonly notnull");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/General/Longitude", "readonly notnull");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/General/Northing", "readonly notnull");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/General/Easting", "readonly notnull");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/General/Accuracy", "readonly notnull");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/General/Take_From_GPS_1", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/General/Find_This_in_The_Map", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/General/Device_photos", "nocertainty");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/General/Device_photos_Button_1", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/General/Landform_element", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Type", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Glass_type", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Bottle_part", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Glass_colour", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Completeness", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Max_length_mm", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Max_width_mm", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Max_thickness_mm", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Weight_g", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Burned", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Patination", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Additional_notes", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Start_date", "noannotation");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/End_date", "noannotation");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Webview_glass_core_details", "nolabel");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Scar_count", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Largest_scar_length_mm", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Largest_scar_width_mm", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Core_type", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Original_base_diameter", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Webview_flake_details", "nolabel");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Platform_type", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Platform_depth_mm", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Platform_width_mm", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Distal_termination", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Cortex_percent", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Dorsal_scar_count", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Conjoin", "noannotation");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Refit", "noannotation");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Edge_damage", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details/Abrasion", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Supplementary/External_camera_ID", "nocertainty");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Supplementary/External_camera_file_names_and_attachment", "nocertainty");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Supplementary/External_camera_image_attachment", "nocertainty");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Supplementary/External_camera_image_attachment_Button_1", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Supplementary/Survey_instrument_name", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Supplementary/Survey_instrument_point_codes", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Supplementary/Related_site_name", "noannotation");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Supplementary/Sample_context", "noannotation");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Supplementary/Other_contextual_details", "noannotation");
REF_TO_FLAG_STRING.put("Metal_Artefact/General/Metal_Artefact_ID", "autonum nocertainty id");
REF_TO_FLAG_STRING.put("Metal_Artefact/General/Metal_Artefact_author", "readonly nocertainty");
REF_TO_FLAG_STRING.put("Metal_Artefact/General/Metal_Artefact_timestamp", "readonly noannotation nocertainty");
REF_TO_FLAG_STRING.put("Metal_Artefact/General/Latitude", "readonly notnull");
REF_TO_FLAG_STRING.put("Metal_Artefact/General/Longitude", "readonly notnull");
REF_TO_FLAG_STRING.put("Metal_Artefact/General/Northing", "readonly notnull");
REF_TO_FLAG_STRING.put("Metal_Artefact/General/Easting", "readonly notnull");
REF_TO_FLAG_STRING.put("Metal_Artefact/General/Accuracy", "readonly notnull");
REF_TO_FLAG_STRING.put("Metal_Artefact/General/Take_From_GPS_1", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/General/Find_This_in_The_Map", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/General/Device_photos", "nocertainty");
REF_TO_FLAG_STRING.put("Metal_Artefact/General/Device_photos_Button_1", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/General/Landform_element", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Metal_type", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Metal_completeness", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Object_type", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Length_mm", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Width_mm", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Thickness_mm", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Weight_g", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Maker_s_marks_or_trademarks", "noannotation");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Modification_or_re_use", "noannotation");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Start_date", "noannotation");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/End_date", "noannotation");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Additional_notes", "noannotation");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/References", "noannotation");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Nails_or_structural_fasteners_only", "nolabel");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Form", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Head_shape", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Shaft_shape", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Manufacture_method", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Size_class", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Features", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Buckles_only", "nolabel");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Frame_type", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Frame_shape", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Pin", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Tongue", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Decoration_type", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details/Decorative_motifs", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Supplementary/External_camera_ID", "nocertainty");
REF_TO_FLAG_STRING.put("Metal_Artefact/Supplementary/External_camera_file_names_and_attachment", "nocertainty");
REF_TO_FLAG_STRING.put("Metal_Artefact/Supplementary/External_camera_image_attachment", "nocertainty");
REF_TO_FLAG_STRING.put("Metal_Artefact/Supplementary/External_camera_image_attachment_Button_1", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Supplementary/Survey_instrument_name", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Supplementary/Survey_instrument_point_codes", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Supplementary/Related_site_name", "noannotation");
REF_TO_FLAG_STRING.put("Metal_Artefact/Supplementary/Sample_context", "noannotation");
REF_TO_FLAG_STRING.put("Metal_Artefact/Supplementary/Other_contextual_details", "noannotation");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/General/Weapons_and_Ammunition_ID", "autonum nocertainty id");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/General/Weapons_and_Ammunition_author", "readonly nocertainty");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/General/Weapons_and_Ammunition_timestamp", "readonly noannotation nocertainty");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/General/Latitude", "readonly notnull");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/General/Longitude", "readonly notnull");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/General/Northing", "readonly notnull");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/General/Easting", "readonly notnull");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/General/Accuracy", "readonly notnull");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/General/Take_From_GPS_1", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/General/Find_This_in_The_Map", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/General/Device_photos", "nocertainty");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/General/Device_photos_Button_1", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/General/Landform_element", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Object", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Completeness", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Material", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Length_mm", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Width_mm", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Thickness_mm", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Weight_g", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Weight_grains_1_gram_is_15_4324_grains", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Gun_part", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Crown_or_head_stamps", "noannotation");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Other_trademarks", "noannotation");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Start_date", "noannotation");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/End_date", "noannotation");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Additional_notes", "noannotation");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/References", "noannotation");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Projectile_details", "nolabel");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Projectile_type", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Deformation", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Rifling_grooves", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Mould_seams_sprue_marks", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Number_of_grooves", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Cartridge_details", "nolabel");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Base", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Body", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details/Firing_mechanism", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Supplementary/External_camera_ID", "nocertainty");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Supplementary/External_camera_file_names_and_attachment", "nocertainty");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Supplementary/External_camera_image_attachment", "nocertainty");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Supplementary/External_camera_image_attachment_Button_1", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Supplementary/Survey_instrument_name", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Supplementary/Survey_instrument_point_codes", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Supplementary/Related_site_name", "noannotation");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Supplementary/Sample_context", "noannotation");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Supplementary/Other_contextual_details", "noannotation");
REF_TO_FLAG_STRING.put("User_List/User_List", "noscroll");
REF_TO_FLAG_STRING.put("Control/Control", "");
REF_TO_FLAG_STRING.put("Control/Map", "noscroll");
REF_TO_FLAG_STRING.put("Control/Recent", "noscroll");
REF_TO_FLAG_STRING.put("Control/Search", "nodata noscroll");
REF_TO_FLAG_STRING.put("Control/Autonumbering", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/General", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Feature_details", "");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact/Supplementary", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/General", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Feature_details", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact/Supplementary", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/General", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Feature_details", "");
REF_TO_FLAG_STRING.put("Glass_Artefact/Supplementary", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/General", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Feature_details", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact/Supplementary", "");
REF_TO_FLAG_STRING.put("Misc_Artefact/General", "");
REF_TO_FLAG_STRING.put("Misc_Artefact/Feature_details", "");
REF_TO_FLAG_STRING.put("Misc_Artefact/Supplementary", "");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/General", "");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/Feature_details", "");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact/Supplementary", "");
REF_TO_FLAG_STRING.put("Buttons/General", "");
REF_TO_FLAG_STRING.put("Buttons/Feature_details", "");
REF_TO_FLAG_STRING.put("Buttons/Supplementary", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/General", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Feature_details", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact/Supplementary", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/General", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Feature_details", "");
REF_TO_FLAG_STRING.put("Metal_Artefact/Supplementary", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/General", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Feature_details", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition/Supplementary", "");
REF_TO_FLAG_STRING.put("User_List", "nodata");
REF_TO_FLAG_STRING.put("Control", "nodata");
REF_TO_FLAG_STRING.put("Flaked_Stone_Artefact", "");
REF_TO_FLAG_STRING.put("Other_Stone_Artefact", "");
REF_TO_FLAG_STRING.put("Glass_Artefact", "");
REF_TO_FLAG_STRING.put("Ceramic_Artefact", "");
REF_TO_FLAG_STRING.put("Misc_Artefact", "");
REF_TO_FLAG_STRING.put("Discrete_Hearth_Artefact", "");
REF_TO_FLAG_STRING.put("Buttons", "");
REF_TO_FLAG_STRING.put("Knapped_Glass_Artefact", "");
REF_TO_FLAG_STRING.put("Metal_Artefact", "");
REF_TO_FLAG_STRING.put("Weapons_and_Ammunition", "");

String getType(String ref) {
  String type = REF_TO_TYPE.get(ref);
  if (type == null) return "";
  else              return type;
}

List getRefs() {
  return getRefsAsList();
}

List getRefsAsList() {
  if (REFS_AS_LIST == null)
    REFS_AS_LIST = new ArrayList(REF_TO_TYPE.keySet());
  return REFS_AS_LIST;
}

HashSet getRefsAsHashSet() {
  if (REFS_AS_HASH_SET == null)
    REFS_AS_HASH_SET = new HashSet(REF_TO_TYPE.keySet());
  return REFS_AS_HASH_SET;
}

List getRefsByType(String type) {
  List refs = new ArrayList();
  for (String ref : getRefs())
    if (getType(ref).equals(type))
      refs.add(ref);
  return refs;
}

List getNoautosaveTabGroups() {
  return NOAUTOSAVE_TAB_GROUPS;
}

HashSet getNoautosaveTabGroupsAsHashSet() {
  if (NOAUTOSAVE_TAB_GROUPS_AS_HASH_SET == null)
    NOAUTOSAVE_TAB_GROUPS_AS_HASH_SET = new HashSet(NOAUTOSAVE_TAB_GROUPS);
  return NOAUTOSAVE_TAB_GROUPS_AS_HASH_SET;
}

boolean isFlaggedNoautosave(String ref) {
  return getNoautosaveTabGroupsAsHashSet().contains(ref);
}

boolean hasData(String ref) {
  return DATA_REFS.contains(ref);
}

boolean hasNoUi(String ref) {
  return NO_UI_REFS.contains(ref);
}

String getVpRef(String ref) {
  return VP_REF_TO_REF.get(ref);
}

boolean hasVpRef(String ref) {
  return getVpRef(ref) != null;
}

/* Returns `true` if `ref` refers to a hierarhical menu. (e.g. a hierarchical
 * dropdown or hierarchical picture gallery.) Returns `false` otherwise.
 */
boolean isHier(String ref) {
  return HIER_REFS.contains(ref);
}

boolean isValidRef(String ref) {
  boolean isValidRef = false;
  if (!isInUnitTestTime())
    isValidRef = isValidRef || linker.getUIRenderer().getViewByRef(ref) != null;
  isValidRef = isValidRef || getRefsAsHashSet()     .contains(ref);
  isValidRef = isValidRef || getTabsAsHashSet()     .contains(ref);
  isValidRef = isValidRef || getTabGroupsAsHashSet().contains(ref);
  return isValidRef;
}

boolean validateRef(ref) {
  String msg =
    isInUnitTestTime() ?
    "Ref '" + ref + "' may not refer to a UI element" :
    "Ref '" + ref + "' does not refer to a UI element";

  if (!isValidRef(ref) && !"module".equals(ref)) {
    Log.w(this.callstack.get(1).getInvocationText(), msg);
    return false;
  }
  return true;
}

List getTabGroups() { return getTabGroupsAsList(); }
List getTabGroupsAsList() { return TAB_GROUPS_AS_LIST; }

HashSet getTabGroupsAsHashSet() {
  if (TAB_GROUPS_AS_HASH_SET == null)
    TAB_GROUPS_AS_HASH_SET = new HashSet(TAB_GROUPS_AS_LIST);
  return TAB_GROUPS_AS_HASH_SET;
}

List getTabs() { return getTabsAsList(); }
List getTabsAsList() { return TABS_AS_LIST; }

HashSet getTabsAsHashSet() {
  if (TABS_AS_HASH_SET == null)
    TABS_AS_HASH_SET = new HashSet(TABS_AS_LIST);
  return TABS_AS_HASH_SET;
}

List getStartingIdRefs() {
  List l = new ArrayList();
  l.add("Control/Autonumbering/Next_Flaked_Stone_Artefact_ID");
  l.add("Control/Autonumbering/Next_Other_Stone_Artefact_ID");
  l.add("Control/Autonumbering/Next_Glass_Artefact_ID");
  l.add("Control/Autonumbering/Next_Ceramic_Artefact_ID");
  l.add("Control/Autonumbering/Next_Misc_Artefact_ID");
  l.add("Control/Autonumbering/Next_Discrete_Hearth_Artefact_ID");
  l.add("Control/Autonumbering/Next_Buttons_ID");
  l.add("Control/Autonumbering/Next_Knapped_Glass_Artefact_ID");
  l.add("Control/Autonumbering/Next_Metal_Artefact_ID");
  l.add("Control/Autonumbering/Next_Weapons_and_Ammunition_ID");
  return l;
}

List getMenuTypes() {
  List menuTypes = new ArrayList();
  menuTypes.add("checkbox");
  menuTypes.add("dropdown");
  menuTypes.add("list");
  menuTypes.add("picture");
  menuTypes.add("radio");
  return menuTypes;
}

List getMediaTypes() {
  List mediaTypes = new ArrayList();
  mediaTypes.add("audio");
  mediaTypes.add("camera");
  mediaTypes.add("file");
  mediaTypes.add("video");
  return mediaTypes;
}

boolean isMenuType(String type) {
  return getMenuTypes().contains(type);
}

boolean isMediaType(String type) {
  return getMediaTypes().contains(type);
}

boolean hasMenuType(String ref) {
  String refType = getType(ref);
  return isMenuType(refType);
}

boolean hasMediaType(String ref) {
  String type = getType(ref);
  return isMediaType(type);
}

boolean isFlaggedNodata(String tabGroup) {
  return NODATA_TAB_GROUPS.contains(tabGroup);
}

void updateDisplayedTab(String tab) {
  if (tab.equals(CURRENTLY_DISPLAYED_TAB))
    return;

  PREVIOUSLY_DISPLAYED_TAB = CURRENTLY_DISPLAYED_TAB;
  CURRENTLY_DISPLAYED_TAB  = tab;
}

String getPreviouslyDisplayedTab() {
  return PREVIOUSLY_DISPLAYED_TAB;
}

String getDisplayedTab() {
  return CURRENTLY_DISPLAYED_TAB;
}

void updateDisplayedTabGroup(String tabGroup) {
  if (tabGroup.equals(CURRENTLY_DISPLAYED_TAB_GROUP))
    return;

  PREVIOUSLY_DISPLAYED_TAB_GROUP = CURRENTLY_DISPLAYED_TAB_GROUP;
  CURRENTLY_DISPLAYED_TAB_GROUP  = tabGroup;
}

String getPreviousTabGroup() {
  return getPreviouslyDisplayedTabGroup();
}

String getPreviouslyDisplayedTabGroup() {
  return PREVIOUSLY_DISPLAYED_TAB_GROUP;
}

String getDisplayedTabGroup() {
  return CURRENTLY_DISPLAYED_TAB_GROUP;
}

boolean isDisplayed(String ref) {
  return getDisplayedTabGroup().equals(ref) ||
         getDisplayedTab     ().equals(ref);
}

String getTabGroupRef(String fullRef) {
  Boolean lastPartOnly = false;
  return getTabGroupRef(fullRef, lastPartOnly);
}

String getTabGroupRef(String fullRef, Boolean lastPartOnly) {
  if (isNull(fullRef)) {
    return null;
  }

  String[] parts = fullRef.split("/");

  if (parts.length < 1) return null;
  return parts[0];
}

String getTabRef(String fullRef) {
  Boolean lastPartOnly = false;
  return getTabRef(fullRef, lastPartOnly);
}

String getTabRef(String fullRef, Boolean lastPartOnly) {
  if (isNull(fullRef)) {
    return null;
  }

  String[] parts = fullRef.split("/");

  if (parts.length < 2) return null;
  if (lastPartOnly) return                  parts[1];
  else              return parts[0] + "/" + parts[1];
}

String getLastRefPart(String fullRef) {
  if (isNull(fullRef)) {
    return null;
  }

  String[] parts = fullRef.split("/");
  return parts[parts.length-1];
}

String getGuiElementRef(String fullRef) {
  Boolean lastPartOnly = true;
  return getGuiElementRef(fullRef, lastPartOnly);
}

String getGuiElementRef(String fullRef, Boolean lastPartOnly) {
  if (isNull(fullRef)) {
    return null;
  }

  String[] parts = fullRef.split("/");

  if (parts.length < 3) return null;
  if (lastPartOnly) return parts[2];
  else              return fullRef;
}

boolean isTab(String ref) {
  return getTabsAsHashSet().contains(ref);
}

boolean isTabGroup(String ref) {
  return getTabGroupsAsHashSet().contains(ref);
}

String getArch16nKey(String ref) {
  String lastRefPart = getLastRefPart(ref);

  if (isNull(lastRefPart)) return null;
  else                     return "{" + lastRefPart + "}";
}

String getArch16nVal(String ref) {
  return arch16nSubstituteValues(getArch16nKey(ref));
}

String guessArch16nVal(String ref) {
  return guessArch16nValFromRef(ref);
}

String guessArch16nValFromRef(String ref) {
  String arch16nKey = getArch16nKey(ref);
  return guessArch16nValFromKey(arch16nKey);
}

String guessArch16nValFromKey(String key) {
  if (isNull(key)) return "";
  key = key.replaceAll("_", " ");
  key = key.replaceAll("^\\{", "");
  key = key.replaceAll("\\}$", "");
  return key;
}

/* Example:
 *   english.0.properties:
 *       please=Please
 *       enable_gps=enable GPS
 *       ...
 *
 *   ui_logic.bsh:
 *       arch16nSubstituteValues("{please} {enable_gps}.") ==
 *           "Please enable GPS."
 */
String arch16nSubstituteValues(String unSubbed) {
  if (isInUnitTestTime())
    return unSubbed;

  List entries = new ArrayList();
  entries.add(new NameValuePair(unSubbed, ""));
  entries = linker.convertToNameValuePairs(entries);
  return entries.get(0).getName();
}

String getAttributeName(String ref) {
  String guiElementRef = getGuiElementRef(ref);
  if (isNull(guiElementRef))
    return null;

  if (ATTRIB_NAMES_NON_STANDARD.containsKey(ref))
    return ATTRIB_NAMES_NON_STANDARD.get(ref);

  return guiElementRef.replaceAll("_", " ");
}

List getAttribsMatchingRef(String pattern) {
  Set attribsSet;

  List attribsList = new ArrayList();
  for (ref : getRefsMatching(pattern))
    attribsList.add(getAttributeName(ref));

  attribsSet  = new HashSet(attribsList);
  attribsList = new ArrayList(attribsSet);

  return attribsList;
}

String getArchEntType(String ref) {
  String tabGroupRef = getTabGroupRef(ref);
  if (isNull(tabGroupRef)) {
    return null;
  }

  String archEntType = tabGroupRef.replaceAll("_", " ");
  return archEntType;
}

String getArchEntTypePascalCased(String ref) {
  String archEntType = getArchEntType(ref);
  if (archEntType == null) {
    return archEntType;
  }

  return archEntType.replaceAll(" ", "");
}

List getRefsMatching(String pattern) {
  Map dict = new HashMap();
  dict.put('/', "\\/");
  dict.put('*', ".*");
  String regex = translate(pattern, dict);

  return filterListByRegex(getRefs(), regex);
}

String getRefMatching(String pattern) {
  List matches = getRefsMatching(pattern);
  if (matches.size() == 0)
    return "";
  return matches.get(0);
}

/******************************************************************************/
/*                            BINDING ACCUMULATOR                             */
/*                                                                            */
/* The binding accumulator allows onEvent bindings for the same element to    */
/* accumulate over multiple onEvent calls instead of having later calls       */
/* override earlier ones.                                                     */
/*                                                                            */
/* It also adds support for a several additional events:                      */
/*   - "blur" --- This is merely an interface to make code for adding "blur"  */
/*         events more consistent.                                            */
/*   - "copy" --- Triggered as a record is duplicated, immediately before it  */
/*         is first saved.                                                    */
/*   - "create" --- Triggered after a savable, auto-generated tab group is    */
/*         shown (but possibly before the "show" event is triggered).         */
/*   - "delete" --- Triggered after a record is deleted.                      */
/*   - "prefetch" --- Triggered before the "fetch" event. More specifically,  */
/*         this event is triggered before a tab group is fetched and          */
/*         displayed.                                                         */
/*   - "fetch" --- Triggered after a record is fetched and displayed in a     */
/*         given tab group.                                                   */
/*   - "focus" --- This is merely an interface to make code for adding        */
/*         "focus" events more consistent.                                    */
/*   - "leave" --- Triggered after a given tab group is navigated away        */
/*         from. Note that this event cannot be triggered when the FAIMS app  */
/*         is exited.                                                         */
/*   - "save" --- Triggered each time a tab group is saved. This includes the */
/*         first time the tab group is saved as well as subsequent            */
/*         onSave(String, Boolean) calls.                                     */
/*   - "firstsave" --- Similar to "save", but only triggered upon the first   */
/*         save (i.e. the save which creates the arch ent). When this event   */
/*         is triggered, it occurs immediately before the "save" event.       */
/*                                                                            */
/* Additionally, the binding accumulator augments the "load" event so that    */
/* the `statement` in addOnEvent("module", "load", statement) gets executed   */
/* after the module has finished loading. (That is, when this script has been */
/* loaded, including the execution of any asynchronous functions.)            */
/*                                                                            */
/* Importantly, a single call to `bindOnEvents` must occur after all the      */
/* `addOnEvent` and `delOnEvent` calls. Calling `bindOnEvents` is what        */
/* actually establishes the bindings once they have been added to the         */
/* accumulator.                                                               */
/******************************************************************************/
// This counts the number of _a_synchonrous jobs before the module is considered
// to be loaded.
//     Only one synchronous job is counted, and that's loading this script; that
// is why this variable is initialised to 1.
AtomicInteger NUM_JOBS_TILL_LOADED = new AtomicInteger(1);
AtomicInteger NUM_FETCHES_OCCURING = new AtomicInteger(0);

final int PRECEDENCE_MIN = 0;
final int PRECEDENCE_MID = Integer.MAX_VALUE/2;
final int PRECEDENCE_MAX = Integer.MAX_VALUE;

int NUM_EVTS = 0;
Map ON_EVT_CONDS  = new HashMap(); // (ref, event type) -> callback statement
Map ON_EVT_STMTS  = new HashMap(); // (ref, event type) -> callback statement
Set CUSTOM_EVENTS = new HashSet(); // Events not handled by `onEvent`

CUSTOM_EVENTS.add("blur");
CUSTOM_EVENTS.add("copy");
CUSTOM_EVENTS.add("create");
CUSTOM_EVENTS.add("delete");
CUSTOM_EVENTS.add("fetch");
CUSTOM_EVENTS.add("focus");
CUSTOM_EVENTS.add("leave");
CUSTOM_EVENTS.add("prefetch");
CUSTOM_EVENTS.add("save");
CUSTOM_EVENTS.add("firstsave");

List getPrioritised(String statement, int priority) {
  List prioritised = new ArrayList();

  prioritised.add(statement);
  prioritised.add(priority);
  prioritised.add(NUM_EVTS++);

  return prioritised;
}

Comparator PrioritisedComparator() {
  int compare(List a, List b) {
    int aPriority = a.get(1);
    int bPriority = b.get(1);

    int aEvtNum   = a.get(2);
    int bEvtNum   = b.get(2);

    if (aPriority > bPriority) return -1;
    if (aPriority < bPriority) return +1;
    if (aEvtNum   > bEvtNum  ) return +1;
    if (aEvtNum   < bEvtNum  ) return -1;
    return 0;
  }
  boolean equals(a, b) { return compare(a, b) == 0; }
  return this;
}

String getOnEventKey(String ref, String event) {
  return ref + SEP + event;
}

ArrayList getOnEventPriorities(String ref, String event, Map map) {
  String    key = getOnEventKey(ref, event);
  ArrayList val = (ArrayList) map.get(key);

  if (val == null) return new ArrayList();
  else             return val;
}

/* Returns the set of statements bound to an element at `ref` and occurring on
 * `event`.
 */
ArrayList getOnEventVal(String ref, String event, Map map) {
  String    key  = getOnEventKey(ref, event);
  ArrayList val  = (ArrayList) map.get(key);
  ArrayList val_ = new ArrayList();

  if (val == null)
    val = new ArrayList();

  // Sort the vals by their precedence
  Collections.sort(val, PrioritisedComparator());

  // Unpack the inner objects (Strings) from the `Prioritised` objects, put them
  // in `val_`.
  for (v : val)
    val_.add(v.get(0));

  return val_;
}

ArrayList getConds(String ref, String event) {
  return getOnEventVal(ref, event, ON_EVT_CONDS);
}

ArrayList getStatements(String ref, String event) {
  return getOnEventVal(ref, event, ON_EVT_STMTS);
}

void addToOnEventPriorities(
    String ref,
    String event,
    String statement,
    int precedence,
    Map map
) {
  // In the case that a statement already exists for a given (`ref`, `event`)
  // pair, writing `val.add(statement);` will be enough to add the extra
  // statement. This is because `getStatements` returns a reference to a list.
  // In the case just described, the list is stored in the `ON_EVT_STMTS` map.
  // However, sometimes `getStatements` returns empty lists which are not stored
  // in that map. In this case, calling `ON_EVT_STMTS.put` is required.
  //
  // `precedence` controls the order that statements are executed. Roughly,
  // a statement with a higher precedence is executed before a statement with
  // a lower precedence.
  assert(precedence >= 0);
  assert(precedence <= Integer.MAX_VALUE);

  validateRef(ref);

  String    key = getOnEventKey       (ref, event);
  ArrayList val = getOnEventPriorities(ref, event, map);

  ArrayList statements = val;

  statements.add(getPrioritised(statement, precedence));
  map.put(key, statements);
}

String getOnEventString(
    String ref,
    String event,
    Map map,
    String sep,
    boolean doAddTrailingSep
) {
  ArrayList stmts = getOnEventVal(ref, event, map);
  String stmtsStr = "";

  if (stmts.size() > 0)
    stmtsStr = stmts.get(0);

  for (int i = 1; i < stmts.size(); i++)
    stmtsStr += sep + stmts.get(i);

  if (doAddTrailingSep)
    stmtsStr += sep;

  return stmtsStr;
}

String getStatementsString(String ref, String event) {
  String condsStr = getOnEventString(ref, event, ON_EVT_CONDS, " && ", false);
  String stmtsStr = getOnEventString(ref, event, ON_EVT_STMTS, "; "  , true);

  if (isNull(condsStr))
    return stmtsStr;
  return "if (" + condsStr + ") { " + stmtsStr + " }";
}

void executeOnEvent(String ref, String event) {
  validateRef(ref);

  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}

boolean hasOnEvent(String ref, String event, String statement) {
  return getStatements(ref, event).contains(statement);
}

void delOnEvent(String ref, String event, String statement) {
  validateRef(ref);

  String    key = getOnEventKey(ref, event);
  ArrayList val = (ArrayList) ON_EVT_STMTS.get(key);

  if (val == null)
    return;

  for (Iterator i = val.iterator(); i.hasNext(); ) {
    obj = i.next();
    if (statement.equals(obj.get(0)))
      i.remove();
  }
}

void delOnEvents(String ref, String event) {
  validateRef(ref);

  String key = getOnEventKey(ref, event);
  ON_EVT_STMTS.remove(key);
}

void addOnEvent(String ref, String event, String statement, int precedence) {
  addToOnEventPriorities(ref, event, statement, precedence, ON_EVT_STMTS);
}

/* Adds a condition to be checked before any expressions bound by `addOnEvent`
 * are evaluated. `check` is `boolean` expression which must evaluate to `true`
 * before the bound expressions evaluate. For instance, in the following logic,
 * `onShowMyTabGroup()` will never be evaluated:
 *
 * ```
 * boolean myChecker() {
 *   showWarning("I'm Sorry, Dave", "I'm afraid I can't do that.");
 *   return false;
 * }
 *
 * addOnEvent    ("My_Tab_Group", "show", "onShowMyTabGroup()");
 * addOnEventCond("My_Tab_Group", "show", "myChecker()");
 * ```
 */
void addOnEventCond(String ref, String event, String check) {
  addToOnEventPriorities(ref, event, check, PRECEDENCE_MID, ON_EVT_CONDS);
}

void addOnEvent(String ref, String event, String statement) {
  addOnEvent(ref, event, statement, PRECEDENCE_MID);
}

void addOnEvent(
    String ref, String event, String function, Object[] args, int precedence
) {
  String statementString = function2callableString(function, args);
  addOnEvent(ref, event, statementString);
}

void addOnEvent(String ref, String event, String function, Object[] args) {
  addOnEvent(ref, event, function, args, PRECEDENCE_MID);
}

void addOnEventCond(String ref, String event, String check, Object[] args) {
  String checkString = runnable2runnableString(check);
  addOnEvent(ref, event, checkString);
}

void bindOnEvent(String ref, String event) {
  String stmtsStr     = getStatementsString(ref, event);
  String focusStmtStr = getStatementsString(ref, "focus");
  String blurStmtStr  = getStatementsString(ref, "blur" );

  if (event.equals("load") && ref.equals("module")) {
    ;
  } else if (event.equals("focus")) {
    onFocus(ref, focusStmtStr, blurStmtStr);
  } else if (event.equals("blur" )) {
    onFocus(ref, focusStmtStr, blurStmtStr);
  } else if (!CUSTOM_EVENTS.contains(event)) {
    onEvent(ref, event, stmtsStr);
  } else {
    ; // Other events are implemented using auto-generated callback functions
  }
}

void bindOnEvents() {
  for (String key : ON_EVT_STMTS.keySet()) {
    refevent = key.split(SEP);
    ref   = refevent[0];
    event = refevent[1];
    bindOnEvent(ref, event);
  }
}

void onLeaveTab() {
  onLeaveTabGroup(getPreviouslyDisplayedTab());
}

/* Execute the "leave" event for the tab group at `ref` if a callback for it
 * exists.
 */
void onLeaveTabGroup(String ref) {
  String event    = "leave";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}

void onLeaveTabGroup() {
  onLeaveTabGroup(getPreviouslyDisplayedTabGroup());
}

/* Execute the "leave" event for the tab group at `ref` if a callback for it
 * exists.
 */
void onLeaveTabGroup(String ref) {
  String event    = "leave";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}

void incJobsTillLoaded() {
  NUM_JOBS_TILL_LOADED.incrementAndGet();
}

boolean isModuleLoaded() {
  return NUM_JOBS_TILL_LOADED.get() == 0;
}

/* Returns `true` if the module has loaded.
 */
boolean decJobsTillLoaded() {
  return NUM_JOBS_TILL_LOADED.decrementAndGet() == 0;
}

void decAndExecIfModuleLoaded() {
  if (decJobsTillLoaded())
    executeOnEvent("module", "load");
}

boolean isDoingFetchEvent() {
  return NUM_FETCHES_OCCURING.get() > 0;
}

/* Establishes `onEvent` bindings necessary to make the "leave" event work for
 * tab groups. The "leave" event is really triggered upon "show" of another tab
 * group.
 */
for (String ref : getTabGroups()) {
  String callback;

  // Update (previously) displayed tab group
  callback = fun2str("updateDisplayedTabGroup", ref);
  addOnEvent(ref, "show",   callback, PRECEDENCE_MAX);
  addOnEvent(ref, "create", callback, PRECEDENCE_MAX);

  // Trigger on leave tab group event
  callback = "onLeaveTabGroup()";
  addOnEvent(ref, "show", callback, PRECEDENCE_MAX);
}

/* Establishes `onEvent` bindings necessary to make the "leave" event work for
 * tabs. The "leave" event is really triggered upon "show" of another tab.
 */
for (String ref : getTabs()) {
  String callback;

  // Update (previously) displayed tab group
  callback = fun2str("updateDisplayedTab", ref);
  addOnEvent(ref, "show",   callback, PRECEDENCE_MAX);

  // Trigger on leave tab group event
  callback = "onLeaveTab()";
  addOnEvent(ref, "show", callback, PRECEDENCE_MAX);
}

for (String tg : getTabGroups()) {
  if (isFlaggedNodata(tg))
    continue;

  addOnEvent(
      tg,
      "prefetch",
      "NUM_FETCHES_OCCURING.incrementAndGet()",
      PRECEDENCE_MAX
  );
  addOnEvent(
      tg,
      "fetch",
      "NUM_FETCHES_OCCURING.decrementAndGet()",
      0
  );
}

/******************************************************************************/
/*                     LOCALSETTINGS VIEW/TABLE CREATION                      */
/******************************************************************************/
void makeLocalId(){
  fetchOne(
      "CREATE TABLE IF NOT EXISTS perflog (" +
      "    id              INTEGER PRIMARY KEY," +
      "    deviceModel     TEXT," +
      "    sessStartMs     INTEGER," +
      "    parentNameSpace TEXT," +
      "    srcLine         TEXT," +
      "    query           TEXT," +
      "    queryStartMs    INTEGER," +
      "    queryStopMs     INTEGER," +
      "    numAentvalue    INTEGER," +
      "    numArchentity   INTEGER," +
      "    numRelationship INTEGER," +
      "    numAentreln     INTEGER " +
      ")"
  );

  fetchOne(
      "CREATE TABLE IF NOT EXISTS localSettings (" +
      "    key   TEXT PRIMARY KEY," +
      "    value TEXT" +
      ")"
  );

  fetchOne(
      "DROP VIEW IF EXISTS parentchild"
  );

  fetchOne(
      "CREATE VIEW parentchild AS "+
      "           SELECT parent.uuid as parentuuid, child.uuid as childuuid, parent.participatesverb as parentparticipatesverb, parent.relationshipid, parent.aenttypename as parentaenttypename, child.participatesverb as childparticipatesverb, child.aenttypename as childaenttypename, createdat"+
      "             FROM (SELECT uuid, participatesverb, aenttypename, relationshipid, relntimestamp as createdat"+
      "                     FROM latestnondeletedaentreln "+
      "                     JOIN relationship USING (relationshipid) "+
      "                     JOIN latestnondeletedarchent USING (uuid) "+
      "                     JOIN aenttype USING (aenttypeid)) parent "+
      "             JOIN (SELECT uuid, relationshipid, participatesverb, aenttypename "+
      "                     FROM latestnondeletedaentreln "+
      "                     JOIN relationship USING (relationshipid) "+
      "                     JOIN latestnondeletedarchent USING (uuid) "+
      "                     JOIN aenttype USING (aenttypeid)) child "+
      "               ON (parent.relationshipid = child.relationshipid AND parent.uuid != child.uuid)"
  );
}
makeLocalId();

/******************************************************************************/
/*                            PERFORMANCE TESTING                             */
/*                                                                            */
/* Code to a) time queries; and b) create dummy records. (The vast majority   */
/* the code is for the latter.)                                               */
/******************************************************************************/
import android.os.StatFs;
import android.os.Environment;
import java.io.File;
import java.io.FileOutputStream;
import java.nio.channels.Channels;
import java.nio.channels.FileChannel;
import java.nio.channels.ReadableByteChannel;
import java.nio.file.Files;
import java.text.DecimalFormat;
import java.util.concurrent.ConcurrentLinkedQueue;

ConcurrentLinkedQueue PERF_FILES             = new ConcurrentLinkedQueue();
AtomicInteger         PERF_NUM_CBS_DONE_FILE = null;
AtomicInteger         PERF_NUM_CBS_DONE_SAVE = null;
AtomicInteger         PERF_NUM_CBS_DONE_SET  = null;
AtomicInteger         PERF_NUM_CBS_TODO_FILE = null;
AtomicInteger         PERF_NUM_CBS_TODO_SAVE = null;
AtomicInteger         PERF_NUM_CBS_TODO_SET  = null;
boolean               PERF_ALLOW_CREATION    = false;
String                PERF_TEST_IMG          = "";
                      PERF_TYPE_TREE         = null;
int                   PERF_PHOTOS_PER_FIELD  = 1;

int getNumDummyPhotos() {
  return getNumDummyPhotos(PERF_TYPE_TREE);
}

int getNumDummyPhotos(tree) {
  if (tree == null) return 0;

  int childSum = 0;
  for (child : tree.getChildren())
    childSum += getNumDummyPhotos(child);

  boolean isRoot = isNull(tree.label);
  if (isRoot) return childSum;
  else        return childSum + getNumDummyPhotosAtNode(tree);
}

int getNumDummyPhotosAtNode(tree) {
  // Figure out how many camera refs there are at this node (i.e. in this arch
  // ent).
  List cameraRefs = getRefsByType("camera");
  List cameraRefsAtNode = new ArrayList();
  for (String ref : cameraRefs)
    if (getArchEntType(ref).equals(tree.label))
      cameraRefsAtNode.add(ref);

  return getNumDummyRecordsAtNode(tree) *
    cameraRefsAtNode.size() *
    PERF_PHOTOS_PER_FIELD;
}

int getNumSavedPhotos() {
  String dirStr = "/sdcard/faims/modules/" + getModuleId() + "/files/server/";
  return getNumFilesInDir(dirStr);
}

int getNumFilesInDir(String path) {
  File file = new File(path);
  return getNumFilesInDir(file);
}

int getNumFilesInDir(File dir) {
  int num = 0;

  File[] files = dir.listFiles();
  if (files == null) return num;

  for (File file : dir.listFiles())
    num += file.isFile() ? 1 : getNumFilesInDir(file);

  return num;
}

int getNumDummyRecords() {
  getNumDummyRecords(PERF_TYPE_TREE);
}

int getNumDummyRecords(tree) {
  if (tree == null) return 0;

  int childSum = 0;
  for (child : tree.getChildren())
    childSum += getNumDummyRecords(child);

  boolean isRoot = isNull(tree.label);
  if (isRoot) return childSum;
  else        return childSum + getNumDummyRecordsAtNode(tree);
}

int getNumDummyRecordsAtNode(tree) {
  int sum = 1;
  for (; tree.getParent() != null; tree = tree.getParent()) {
    sum *= tree.data;
  }
  return sum;
}

float getFileSizeInMBytes(String path) {
  File file = new File(path);
  return file.length() / 1000.f / 1000.f;
}

float getDirSizeInMBytes(String path) {
  File file = new File(path);
  return getDirSizeInMBytes(file);
}

float getDirSizeInMBytes(File dir) {
  float length = 0;

  File[] files = dir.listFiles();
  if (files == null) return length;

  for (File file : dir.listFiles())
    length += file.isFile()
      ? file.length() / 1000.f / 1000.f
      : getDirSizeInMBytes(file);

  return length;
}

float getSizeDummyPhotosInMBytes() {
  return getNumDummyPhotos() * getFileSizeInMBytes(PERF_TEST_IMG);
}

float getSizeSavedPhotosInMBytes() {
  String dirStr = "/sdcard/faims/modules/" + getModuleId() + "/files/server/";
  return getDirSizeInMBytes(dirStr);
}

String megabytesToString(float mb) {
  DecimalFormat df = new DecimalFormat();
  df.setMaximumFractionDigits(1);
  return df.format(mb);
}

String getSizeDummyPhotosInMBytesAsString() {
  return megabytesToString(getSizeDummyPhotosInMBytes());
}

String getSizeSavedPhotosInMBytesAsString() {
  return megabytesToString(getSizeSavedPhotosInMBytes());
}

float getFreeSpaceInMBytes() {
  return getFreeSpaceInMBytes(Environment.getRootDirectory().getAbsolutePath());
}

float getFreeSpaceInMBytes(String path) {
  StatFs statFs = new StatFs(path);
  return statFs.getBlockCount() * statFs.getBlockSize() / 1000.f / 1000.f;
}

String getFreeSpaceInMBytesAsString() {
  return megabytesToString(getFreeSpaceInMBytes());
}

Tree(String label, Object data) {
  String label    = label;
  Object data     = data;
         parent   = null;
  List   children;

  void addChild(tree) {
    if (super.children == null)
      super.children = new ArrayList();

    tree.setParent(super);
    super.children.add(tree);
  }

  getChild(int i) {
    return super.children.get(i);
  }

  int getIndex() {
    if (super.getParent() == null)
      return -1;
    return super.getParent().getChildren().indexOf(super);
  }

  getDescendant(String ref) {
    String[] refStrArr  = ref.split("/");
    List     refIntList = new ArrayList();

    for (String refStr : refStrArr) {
      int refInt = Integer.parseInt(refStr);
      refIntList.add(refInt);
    }

    return super.getDescendant(refIntList);
  }

  getDescendant(List ref) {
    if (ref.size() == 0)
      return super;

    int  head = ref.get(0);
    List tail = ref.subList(1, ref.size());

    if (ref.size() == 1) return getChild(head);
    if (ref.size() >= 2) return getChild(head).getDescendant(tail);
  }

  String getAncestorRefString(String sep, String key) {
    String s = "";
    for (Object n = super; n.getParent() != null; n = n.getParent()) {
      String val = "";
      if (key.equals("index")) val = n.getIndex() + "";
      if (key.equals("label")) val = n.label;

      s = sep + val + s;
    }

    if (!s.equals(""))
      s = s.substring(sep.length(), s.length()); // Remove initial `sep`

    return s;
  }

  String getAncestorRefString() {
    return getAncestorRefString("/", "index");
  }

  List getChildren() {
    if (super.children == null)
      return new ArrayList();
    return super.children;
  }

  int getNumNodes() {
    int sum = 1;
    for (child : super.getChildren())
      sum += child.getNumNodes();
    return sum;
  }

  void setParent(tree) {
    super.parent = tree;
  }

  getParent() {
    return super.parent;
  }

  String toString() {
    String s = "\n- " + super.label + " (" + data + ")";
    if (super.children != null)
      for (c : super.children)
        s += c.toString().replace("\n", "\n\t\t");
    return s;
  }

  return this;
}

TimedFetchCallback(String query, FetchCallback cb, int callerIdx) {
  int           callerIdx = callerIdx;
  String        query     = query;
  FetchCallback cb        = cb;
  bsh.CallStack cs_       = this.callstack.copy();

  long startTime = System.currentTimeMillis(); // Timer starts here
  long stopTime  = -1;

  void onFetch(Object result) {
    super.stopTimer();
    super.updatePerfLog();

    if (super.cb != null)
      super.cb.onFetch(result);
  }

  void onError(String message) {
    if (super.cb != null)
      super.cb.onError(message);
  }

  void stopTimer() {
    super.stopTime = System.currentTimeMillis();
  }

  double getElapsedMillis() {
    if (stopTime < 0)
      return -Double.MAX_VALUE;
    return super.stopTime - super.startTime;
  }

  void updatePerfLog() {
    String deviceModel     = android.os.Build.MODEL;
    String sessStartMs     = SESS_START_TIME + "";
    String parentNameSpace = cs_.get(callerIdx + 1).getName() + "";
    String srcLine         = cs_.get(callerIdx + 0).getInvocationLine() + "";
    String query           = query;
    String queryStartMs    = startTime + "";
    String queryStopMs     = stopTime + "";

    String updateQuery = "";
    updateQuery += " INSERT INTO perflog (";
    updateQuery += "             deviceModel,";
    updateQuery += "             sessStartMs,";
    updateQuery += "             parentNameSpace,";
    updateQuery += "             srcLine,";
    updateQuery += "             query,";
    updateQuery += "             queryStartMs,";
    updateQuery += "             queryStopMs,";
    updateQuery += "             numArchentity,";
    updateQuery += "             numAentvalue,";
    updateQuery += "             numRelationship,";
    updateQuery += "             numAentreln";
    updateQuery += " )    SELECT %s, %s, %s, %s, %s, %s, %s, a, av, r, ar";
    updateQuery += "        FROM";
    updateQuery += "             (SELECT COUNT(*) AS a  FROM archentity  ) a,";
    updateQuery += "             (SELECT COUNT(*) AS av FROM aentvalue   ) av,";
    updateQuery += "             (SELECT COUNT(*) AS r  FROM relationship) r,";
    updateQuery += "             (SELECT COUNT(*) AS ar FROM aentreln    ) ar";

    updateQuery = dbReplaceFirst(updateQuery, deviceModel);
    updateQuery = dbReplaceFirst(updateQuery, sessStartMs);
    updateQuery = dbReplaceFirst(updateQuery, parentNameSpace);
    updateQuery = dbReplaceFirst(updateQuery, srcLine);
    updateQuery = dbReplaceFirst(updateQuery, query);
    updateQuery = dbReplaceFirst(updateQuery, queryStartMs);
    updateQuery = dbReplaceFirst(updateQuery, queryStopMs);

    fetchOne(updateQuery);
  }

  return this;
}

void timedFetchOne(String q, FetchCallback cb, int callerIdx) {
  tcb = TimedFetchCallback(q, cb, callerIdx);
  fetchOne(q, tcb);
}

void timedFetchAll(String q, FetchCallback cb, int callerIdx) {
  tcb = TimedFetchCallback(q, cb, callerIdx);
  fetchAll(q, tcb);
}

void timedFetchOne(String q, FetchCallback cb) {
  timedFetchOne(q, cb, 2);
}

void timedFetchAll(String q, FetchCallback cb) {
  timedFetchAll(q, cb, 2);
}

void timedFetchOne(String q) {
  timedFetchOne(q, null, 2);
}

void timedFetchAll(String q) {
  timedFetchAll(q, null, 2);
}

void timedPopulateCursorList(String ref, String q, int limit) {
  String boundQ = q;
  boundQ = dbReplaceFirst(boundQ, "?", limit + "");
  boundQ = dbReplaceFirst(boundQ, "?", "0");
  timedFetchAll(boundQ, null, 2);

  populateCursorList(ref, q, limit);
}

void setUpTypeHierarchy() {
  //- 
  //  - Buttons
  //  - Ceramic Artefact
  //  - Discrete Hearth Artefact
  //  - Flaked Stone Artefact
  //  - Glass Artefact
  //  - Knapped Glass Artefact
  //  - Metal Artefact
  //  - Misc Artefact
  //  - Other Stone Artefact
  //  - Weapons and Ammunition

  n0 = Tree("", 1);
  n1 = Tree("Buttons", 1);
  n2 = Tree("Ceramic Artefact", 1);
  n3 = Tree("Discrete Hearth Artefact", 1);
  n4 = Tree("Flaked Stone Artefact", 1);
  n5 = Tree("Glass Artefact", 1);
  n6 = Tree("Knapped Glass Artefact", 1);
  n7 = Tree("Metal Artefact", 1);
  n8 = Tree("Misc Artefact", 1);
  n9 = Tree("Other Stone Artefact", 1);
  n10 = Tree("Weapons and Ammunition", 1);

  n0.addChild(n1);
  n0.addChild(n2);
  n0.addChild(n3);
  n0.addChild(n4);
  n0.addChild(n5);
  n0.addChild(n6);
  n0.addChild(n7);
  n0.addChild(n8);
  n0.addChild(n9);
  n0.addChild(n10);


  PERF_TYPE_TREE = n0;
}

setUpTypeHierarchy();

void saveEntitiesToPCRel(
    String parentType,
    String childType,
    String parentUuid,
    String childUuid
) {
    String relName = parentType + " - " + childType;
    String pOf     = "Parent Of";
    String cOf     = "Child Of";
    saveEntitiesToHierRel(relName, parentUuid, childUuid, pOf, cOf, "");
}

String randomMenuValue(String ref) {
  List vocabIds = getVocabIdsFromRef(ref);
  int  len      = vocabIds.size();
  if (len <= 0)
    return "";

  Random r   = new Random();
  int    i   = r.nextInt(len);

  return vocabIds.get(i);
}

String randomInputValue(String ref) {
  int len = 5;
  randomInputValue(ref, len);
}

String randomInputValue(String ref, int len) {
  if (getType(ref).equals("camera"))
    if (PERF_FILES.isEmpty()) {
      Log.e("randomInputValue()", "PERF_FILES empty, using empty string");
      return "";
    } else
      return PERF_FILES.poll();
  else
    return getRandomString(len);
}

List getAttribsForRef(String ref) {
  int numAttribs = 1;
  if (!hasData(ref))                 numAttribs = 0;
  if (hasMediaType(ref))             numAttribs = 0;
  if (getType(ref).equals("camera")) numAttribs = PERF_PHOTOS_PER_FIELD;

  List attribs = new ArrayList();
  for (int i = 0; i < numAttribs; i++) {
    String attribName = getAttributeName(ref);
    String annotation = "";
    String vocab      = "";
    String measure    = "";
    String certainty  = "1.0";

    if (hasMenuType(ref)) vocab   = randomMenuValue (ref);
    else                  measure = randomInputValue(ref);

    EntityAttribute ea = createEntityAttribute(
        attribName,
        annotation,
        vocab,
        measure,
        certainty
    );
    attribs.add(ea);
  }

  return attribs;
}

List getAttribsForArchEnt(String archEntType) {
  List attribs = new ArrayList();
  for (String ref : getRefs())
    if (getArchEntType(ref).equals(archEntType))
      attribs.addAll(getAttribsForRef(ref));

  return attribs;
}

List getDummyGeometry(String archEntType) {
  String tabGroupRef = archEntType.replaceAll(" ", "_");

  if (getTakeFromGpsMappings().get(tabGroupRef) == null)
    return null;

  Double northing = 1.f;
  Double easting  = 1.f;

  MapPos mapPos = new MapPos(easting, northing);
  Point samplePoint = new Point(mapPos, null, (PointStyle) null, null);
  ArrayList geolist = new ArrayList();
  geolist.add(samplePoint);

  return geolist;
}

void displayRecordDigest(int numCreated) {
  String q = "";
  q += "   SELECT '{All}', count(*)";
  q += "     FROM latestnondeletedarchent";
  q += "    UNION";
  q += "   SELECT aenttypename, count(*)";
  q += "     FROM latestnondeletedarchent";
  q += "     JOIN aenttype USING (aenttypeid)";
  q += " GROUP BY aenttypename";

  FetchCallback cb = new FetchCallback() {
    onFetch(result) {
      String head = "{perf_digest_1_head}";
      String body = "";
      if (numCreated >= 0)
        body += numCreated + " {perf_digest_1_body_1}";
      body += " {perf_digest_1_body_2}";

      if (result == null)
        result = new ArrayList();
      for (List row : result) {
        String type = row.get(0);
        String num  = row.get(1);

        body += "\t- " + type + ": " + num + "\n";
      }

      body += "\nThere are " +
        getNumSavedPhotos() +
        " saved files on this device. There is " +
        getFreeSpaceInMBytesAsString() +
        " MB of free space on this device, of which the saved files use " +
        getSizeSavedPhotosInMBytesAsString() +
        " MB.";

      if (dialog != null)
        dialog.dismiss();
      showWarning(head, body);
    }
  };

  fetchAll(q, cb);
}

void displayRecordDigest() {
  displayRecordDigest(-1);
}

PerfSaveCallback(tree, String parentUuid) {
  tree              = tree;
  String parentUuid = parentUuid;

  saveRel(uuid) {
    parent            = super.tree.getParent();
    String parentUuid = super.parentUuid;

    if (parent == null || parentUuid == null)
      return;

    String parentType = parent    .label;
    String childType  = super.tree.label;

    saveEntitiesToPCRel(parentType, childType, parentUuid, uuid);
  }

  void onSave(String uuid, boolean newRecord) {
    int cbsDone = PERF_NUM_CBS_DONE_SAVE.incrementAndGet();
    int cbsTodo = PERF_NUM_CBS_TODO_SAVE.get();
    if (cbsTodo == cbsDone)
      displayRecordDigest(cbsDone);

    if (newRecord)
      super.saveRel(uuid);

    for (subtree : super.tree.getChildren())
      saveArchEnts(subtree, uuid);
  }

  void onError(String message) {
    if (dialog != null)
      dialog.dismiss();
    showWarning("Error", message);
  }

  return this;
}

void saveArchEnts(tree, String parentUuid) {
  String archEntName = tree.label;
  List   geometry    = getDummyGeometry(archEntName);
  int    numEnts     = tree.data;
  cb                 = PerfSaveCallback(tree, parentUuid);

  for (int i = 0; i < numEnts; i++) {
    List attribs = getAttribsForArchEnt(archEntName);
    saveArchEnt(null, archEntName, geometry, attribs, cb);
  }
}

void createDummyRecords() {
  int  n = getNumDummyRecords();
  dialog = showBusy("{perf_dummy_busy_head}", n + " {perf_dummy_busy_body}");

  enqueueTestFiles("createDummyRecordsRecursively()");
}

void createDummyRecordsRecursively() {
  int n = getNumDummyRecords();
  PERF_NUM_CBS_TODO_SAVE = new AtomicInteger(n);
  PERF_NUM_CBS_DONE_SAVE = new AtomicInteger(0);

  for (child : PERF_TYPE_TREE.getChildren())
    saveArchEnts(child, null);
}

void enqueueTestFiles(String cb) {
  enqueueTestFiles(getNumDummyRecords(), cb);
}

void enqueueTestFiles(int numFiles, String cb) {
  if (isNull(PERF_TEST_IMG)) {
    String head; String body;
    head  = "Record Creation Aborted";
    body  = "The master file from which test files are enqueued could not be ";
    body += "found on disk. Record creation cannot take place unless this file";
    body += " is present. Please ensure that your device is connected to the ";
    body += "internet, re-load the module, and try to run a create dummy ";
    body += "records again.";
    showWarning(head, body);
    return;
  }

  // Set `PERF_NUM_CBS_TODO_FILE` and `PERF_NUM_CBS_DONE_FILE`
  int numPhotosToMake;
  numPhotosToMake  = getNumDummyPhotos();
  numPhotosToMake -= PERF_FILES.size();
  numPhotosToMake  = Math.max(0, numPhotosToMake);
  // We're going to count returns from attachFile too, hence multiplication by 2
  PERF_NUM_CBS_TODO_FILE = new AtomicInteger(numPhotosToMake + 1);
  PERF_NUM_CBS_DONE_FILE = new AtomicInteger(0);

  // Make records
  for (int i = 0; i < numPhotosToMake; i++) {
    String fileName = attachFile(
        PERF_TEST_IMG,
        false,
        null,
        fun2str("checkEnqueueTestFilesIsDone", cb)
    );

    PERF_FILES.add(fileName);
  }
  checkEnqueueTestFilesIsDone(cb);
}

void checkEnqueueTestFilesIsDone(String onDone) {
  int cbsDone = PERF_NUM_CBS_DONE_FILE.incrementAndGet();
  int cbsTodo = PERF_NUM_CBS_TODO_FILE.get();
  if (cbsTodo == cbsDone)
    execute(onDone);
}

PerfImageDownloader() {
  void run() {
    if (isInUnitTestTime())
      return;

    String filStr = "/sdcard/faims/modules/" + getModuleId() +
        "/files/test.jpg";
    String urlStr = "https://github.com/FAIMS/FAIMS-Tools/raw/master/" +
        "generators/christian/tests/images/construction-2894x1924.jpg";

    if (detectFile(filStr))
      return;

    try {
      URL           urlObj = new URL(urlStr);
      URLConnection urlCon = urlObj.openConnection();

      new File(filStr).getParentFile().mkdirs();

      InputStream      is  = urlCon.getInputStream();
      FileOutputStream fos = new FileOutputStream(filStr);

      byte[] buffer = new byte[4096];
      int len;

      // While we have availble data, continue downloading and storing to local
      // file
      while ((len = is.read(buffer)) > 0)
        fos.write(buffer, 0, len);

      if (is  != null) is .close();
      if (fos != null) fos.close();
    } catch (Exception e) {
      Log.e("PerfImageDownloader.run()", e.getMessage());
    }

    // Set `PERF_TEST_IMG` if the file was created successfully
    detectFile(filStr);
  }

  void start() {
    Runnable r = PerfImageDownloader();
    new Thread(r).start();
  }

  boolean detectFile(String filStr) {
    File newImg = new File(filStr);
    if (newImg.length() > 0) {
      PERF_TEST_IMG = filStr;
      return true;
    }
    return false;
  }

  return this;
}

void verifyEnableRecordCreation() {
  String q = "";
  q += " SELECT userid, fname, lname, email, password";
  q += "   FROM user";
  q += "  WHERE fname = 'Faims'";
  q += "    AND lname = 'Admin'";

  FetchCallback callback = new FetchCallback() {
    onFetch(result) {
      String userId    = result.get(0);
      String nameFirst = result.get(1);
      String nameLast  = result.get(2);
      String email     = result.get(3);
      String password  = result.get(4);

      User user = new User(userId, nameFirst, nameLast, email, password);
      setUser(user);

      showVerifyUserDialog("enableRecordCreation()");
    }
  };

  fetchOne(q, callback);
}

void enableRecordCreation() {
  PERF_ALLOW_CREATION = true;
  setUpPerfActionBarItems();

  showWarning("{perf_create_on_head}", "{perf_create_on_body}");
}

boolean isInPerfTestTime() {
  return false;
}

// Produce entity number specification
void setUpDummyRecordCreation() {
  int n = PERF_TYPE_TREE.getNumNodes()
      - 1; // Ignore root node

  PERF_NUM_CBS_TODO_SET = new AtomicInteger(n);
  PERF_NUM_CBS_DONE_SET = new AtomicInteger(0);

  setUpDummyRecordCreation(PERF_TYPE_TREE, "");
}

String getBreadCrumbs(node) {
  return node.getAncestorRefString(" › ", "label");
}

String typeToReadableType(String type) {
  if (type.equals("")) return "{this_module}";
  else                 return "{each} " + type;
}

void setUpDummyRecordCreation(tree, String parentType) {
  String type = tree.label;

  for (child : tree.getChildren())
    setUpDummyRecordCreation(child, type);

  if (!type.equals("")) {
    // Make head and body for `showTextAlert`
    String treeRef = tree.getAncestorRefString();
    String head    = getBreadCrumbs(tree);
    String body    = "{perf_rec_num_body_1} %s {perf_rec_num_body_2} %s " +
                     "{perf_rec_num_body_3}";
    body = replaceFirst(body, type);
    body = replaceFirst(body, typeToReadableType(parentType));

    promptSetDummyRecordQuantity(treeRef, head, body);
  }
}

void promptSetDummyRecordQuantity(String treeRef, String head, String body) {
  String cb = "setDummyRecordQuantity(\"%s\", \"%s\", \"%s\")";
  cb = replaceFirst(cb, treeRef);
  cb = replaceFirst(cb, head);
  cb = replaceFirst(cb, escape(body));

  showTextAlert(head, body, cb, "checkSetDummyRecordQuantityIsDone()");
}

void setDummyRecordQuantity(
    String treeRef,
    String failHead,
    String failBody
) {
  // Parse data as int
  int intData;
  try {
    intData = Integer.parseInt(getLastTextAlertInput());
  } catch (Exception e) {
    promptSetDummyRecordQuantity(treeRef, failHead, failBody);
    return;
  }

  PERF_TYPE_TREE.getDescendant(treeRef).data = intData;
  checkSetDummyRecordQuantityIsDone();
}

void checkSetDummyRecordQuantityIsDone() {
  int cbsDone = PERF_NUM_CBS_DONE_SET.incrementAndGet();
  int cbsTodo = PERF_NUM_CBS_TODO_SET.get();
  if (cbsTodo == cbsDone) {
    String totalImgs = getNumDummyPhotos() + "";
    String totalSizs = getSizeDummyPhotosInMBytesAsString();
    String totalFree = getFreeSpaceInMBytesAsString();
    String totalRecs = getNumDummyRecords() + "";
    String treeString = PERF_TYPE_TREE.toString();
    String treeStringNoRoot = treeString.substring(
        "\n-  (1)".length(),
        treeString.length()
    );

    String head = "{perf_update_head}";
    String body =
         "{perf_update_body_1} " + treeStringNoRoot +
        " {perf_update_body_2} " + totalRecs +
        " {perf_update_body_3} " + totalImgs +
        " {perf_update_body_4} " + totalFree +
        " {perf_update_body_5} " + totalSizs +
        " {perf_update_body_6}";

    showAlert(head, body, "createDummyRecords()", "");
  }
}

void verifyCreateDummyRecords() {
  // Unless syncing is disabled, 'database locked' errors will happen
  setFileSyncEnabled(false);
  setSyncEnabled    (false);

  if (isSyncEnabled()) {
    showWarning("{perf_dummy_err_head}", "{perf_dummy_err_body}");
    return;
  }

  showAlert(
      "{perf_wiz_head}",
      "{perf_wiz_body}",
      "setUpDummyRecordCreation()",
      ""
  );
}

void setUpPerfActionBarItems() {
  removeActionBarItem("create_dummy_records");
  removeActionBarItem("display_record_digest");
  removeActionBarItem("enable_record_creation");

  String userMenuTabGroup = getTabGroupRef(USER_MENU_PATH);
  if (!isDisplayed(userMenuTabGroup)) {
    PERF_ALLOW_CREATION = false;
    return;
  }
  if (!isInPerfTestTime())
    return;

  ActionButtonCallback createDummyRecords = new ActionButtonCallback() {
      actionOnLabel() {
        "{create_dummy_records}";
      }
      actionOn() {
        verifyCreateDummyRecords();
      }
  };

  ActionButtonCallback displayRecordDigest = new ActionButtonCallback() {
      actionOnLabel() {
        "{display_record_digest}";
      }
      actionOn() {
        displayRecordDigest();
      }
  };

  ActionButtonCallback enableRecordCreation = new ActionButtonCallback() {
      actionOnLabel() {
        "{enable_record_creation}";
      }
      actionOn() {
        verifyEnableRecordCreation();
      }
  };

  // Careful! The `if` statements are weirdly formatted
  addActionBarItem("display_record_digest",  displayRecordDigest);
  if (PERF_ALLOW_CREATION)
  addActionBarItem("create_dummy_records",   createDummyRecords);
  if (!PERF_ALLOW_CREATION)
  addActionBarItem("enable_record_creation", enableRecordCreation);
}

void setUpPerfTestMode() {
  if (!isInPerfTestTime())
    return;

  // Download test image
  PerfImageDownloader().start();

  // Display performance testing notification
  showWarning("{perf_mode_head}", "{perf_mode_body}");
}

if (!isNull(USER_MENU_PATH)) {
  String userMenuTabGroup = getTabGroupRef(USER_MENU_PATH);

  setUpPerfTestMode();
  addOnEvent(userMenuTabGroup, "show",  "setUpPerfActionBarItems()");
  addOnEvent(userMenuTabGroup, "leave", "setUpPerfActionBarItems()");
}


/******************************************************************************/
/*                           LOCALSETTINGS UPDATES                            */
/******************************************************************************/
void insertIntoLocalSettings(String ref) {
  String val = getFieldValue(ref);
  insertIntoLocalSettings(ref, val);
}

void insertIntoLocalSettings(String key, String val, boolean doOverwrite) {
  if (val == null) val = "";

  String q;
  if (doOverwrite) q = "REPLACE INTO localSettings(key, value) VALUES(%s, %s)";
  else             q = "INSERT  INTO localSettings(key, value) VALUES(%s, %s)";

  q = dbReplaceFirst(q, key);
  q = dbReplaceFirst(q, val);
  fetchOne(q);
}

void insertIntoLocalSettings(String key, String val) {
  insertIntoLocalSettings(key, val, true);
}

void insertIntoLocalSettings(String key, Integer val) {
  insertIntoLocalSettings(key, Integer.toString(val));
}

void deleteFromLocalSettings(String key) {
  String q = "DELETE FROM localsettings WHERE key=%s";
  q = dbReplaceFirst(q, key);

  fetchOne(q);
}

void insertIntoLocalSettingsOnChange(String ref) {
  String val = getFieldValue(ref);

  String insertCallback = fun2str("insertIntoLocalSettings", ref);

  addOnEvent(ref, "blur",  insertCallback);
  addOnEvent(ref, "click", insertCallback);
}

void setFieldValueFromLocalSettings(
    String  key,
    String  ref,
    boolean doOverwrite,
    String defaultVal
) {
  String val = getFieldValue(ref);
  if (!isNull(val) && !doOverwrite) {
    return;
  }

  String q = "SELECT value FROM localSettings WHERE key = %s";
  q = dbReplaceFirst(q, key);

  FetchCallback set = new FetchCallback() {
    onFetch(result) {
      if (result != null && result.size() >= 1) {
        setFieldValue(ref, result.get(0));
      } else if (defaultVal != null) {
        setFieldValue(ref, defaultVal);
      }
    }
  };

  fetchOne(q, set);
}

void setFieldValueFromLocalSettings(
    String  key,
    String  ref,
    boolean doOverwrite
) {
  setFieldValueFromLocalSettings(key, ref, doOverwrite, null);
}

void setFieldValueFromLocalSettings(
    String  ref,
    boolean doOverwrite,
    String  defaultVal
) {
  setFieldValueFromLocalSettings(ref, ref, doOverwrite, defaultVal);
}

void setFieldValueFromLocalSettings(String ref, boolean doOverwrite) {
  setFieldValueFromLocalSettings(ref, ref, doOverwrite);
}

void setFieldValueFromLocalSettings(String key, String ref) {
  setFieldValueFromLocalSettings(key, ref, false);
}

void setFieldValueFromLocalSettings(String ref) {
  setFieldValueFromLocalSettings(ref, false);
}

void setFieldValueFromLocalSettingsOnEvent(
    String ref,
    boolean doOverwrite,
    String defaultVal,
    String event
) {
  String cb = fun2str(
      "setFieldValueFromLocalSettings",
      new Object[]{ref, doOverwrite, defaultVal}
  );

  addOnEvent(getTabGroupRef(ref), event, cb);
}

void setFieldValueFromLocalSettingsOnShow(
    String ref,
    boolean doOverwrite,
    String defaultVal
) {
  setFieldValueFromLocalSettingsOnEvent(ref, doOverwrite, defaultVal, "show");
}

void setFieldValueFromLocalSettingsOnShow(String ref, boolean doOverwrite) {
  setFieldValueFromLocalSettingsOnShow(ref, doOverwrite, (String) null);
}

/* Causes the value of the field given by `ref` to be saved each time it is
 * modified (on blur). The value of the field is restored when the tab group
 * containing the field is displayed.
 *
 * This function depends on `addOnEvent`. Therefore this function must be called
 * after `addOnEvent` is defined, but before `bindOnEvents` is called. This will
 * be so if the call is made in the autogenerator's `logic` tags.
 */
void persistOverSessions(String ref, boolean doOverwrite, String defaultVal) {
  String tabGroupRef = getTabGroupRef(ref);
  boolean isData = !isFlaggedNodata(tabGroupRef);

  String event;
  if (isData) event = "create";
  else        event = "show";

  setFieldValueFromLocalSettingsOnEvent(ref, doOverwrite, defaultVal, event);
  insertIntoLocalSettingsOnChange      (ref);
}

void persistOverSessions(String ref, boolean doOverwrite) {
  setFieldValueFromLocalSettingsOnShow(ref, doOverwrite);
  insertIntoLocalSettingsOnChange     (ref);
}

void persistOverSessions(String ref, String defaultVal) {
  persistOverSessions(ref, false, defaultVal);
}

void persistOverSessions(String ref) {
  persistOverSessions(ref, false, (String) null);
}



/******************************************************************************/
/*                           FIELD COPYING HELPERS                            */
/*                                                                            */
/* Provides an easy way to copy field values, even between vocabs.            */
/******************************************************************************/
boolean isSelected(String ref, String vocabName) {
  String vocabNameActual = getMenuValue(ref);

  if (vocabNameActual == null)
    return vocabNameActual == vocabName;
  else
    return vocabNameActual.equals(vocabName);
}

boolean setMenuValue(String ref, String vocabName) {
  String attrName = getAttributeName(ref);
  String vocabId = getVocabId(attrName, vocabName);

  if (isNull(vocabId))
    return false;

  setFieldValue(ref, vocabId);
  return isSelected(ref, vocabName);
}

boolean copyFieldValue(String src, String dst) {
  Boolean doFindVocabId = true;
  return copyFieldValue(src, dst, doFindVocabId);
}

/* `src`           The ref of the source field.
 * `dst`           The ref of the destination field.
 * `doFindVocabId` If this is true, and the properties/attributes of `src` and
 *                 `dst` are different, `copyFieldValue` treats `src` and `dst`
 *                 as if they were menus. Therefore, to copy the value seen by
 *                 the user (i.e. the vocabName of `src`), a database query is
 *                 performed. The query determines the which vocabId of `dst`
 *                 will make it display the same vocabName as `src`.
 *
 *                 If `doFindVocabId` is false, the value returned by
 *                 `getFieldValue` is copied, without any database accesses.
 */
boolean copyFieldValue(String src, String dst, Boolean doFindVocabId) {
  if (!doFindVocabId) {
    String valSrc = getFieldValue(src);
    setFieldValue(dst, valSrc);
    return true;
  }

  String valSrc;
  if (hasMenuType(src)) valSrc = getMenuValue (src);
  else                  valSrc = getFieldValue(src);

  if (hasMenuType(dst)) setMenuValue (dst, valSrc);
  else                  setFieldValue(dst, valSrc);

  String valDst;
  if (hasMenuType(dst)) valDst = getMenuValue (dst);
  else                  valDst = getFieldValue(dst);

  return valDst.equals(valSrc);
}

void clearField(String ref) {
  switch(getType(ref)) {
    case "dropdown": setFieldValue(ref, null); break;
    case "list":     return;
    default:         setFieldValue(ref, "");
  }
}

/* Copies the value from the field at `src` to the field at `dst` whenever the
 * a new record containing `dst` is created.
 *
 * `doCheckParent` If this is true, the value is only copied when the parent tab
 *                 group of the tab group referred to by `dst` is equal to the
 *                 tab group referred to by `src`. This is a way of checking
 *                 whether the field referred to by `src` has been loaded.
 * `doFindVocabId` Same as the `doFindVocabId` argument for the `copyFieldValue`
 *                 function.
 */
void inheritFieldValue(
    String src,
    String dst,
    boolean doCheckParent,
    boolean doFindVocabId
) {
  String fun = "";
  fun += "if (!{check} || getPreviouslyDisplayedTabGroup().equals(\"{parent}\"))";
  fun += "  copyFieldValue(\"{src}\", \"{dst}\", {find})";

  fun = replaceFirst(fun, "{check}",  doCheckParent + "");
  fun = replaceFirst(fun, "{parent}", getTabGroupRef(src));
  fun = replaceFirst(fun, "{src}",    src);
  fun = replaceFirst(fun, "{dst}",    dst);
  fun = replaceFirst(fun, "{find}",   doFindVocabId + "");


  String dstParent = getTabGroupRef(dst);
  if (isFlaggedNodata(dstParent)) addOnEvent(dstParent, "show",   fun);
  else                            addOnEvent(dstParent, "create", fun);
}

/* If `doCheckParent`, then the value at `src` will only be inherited to `dst`
 * if `getTabGroupRef(src)` was the previously displayed tab group.
 */
void inheritFieldValue(String src, String dst, boolean doCheckParent) {
  inheritFieldValue(src, dst, doCheckParent, true);
}

void inheritFieldValue(String src, String dst) {
  inheritFieldValue(src, dst, true);
}



/******************************************************************************/
/*                            NEW TAB REDIRECTION                             */
/*                                                                            */
/* Causes a call to `newTab("tab/path")` to take the user to the specified    */
/* tab.                                                                       */
/******************************************************************************/
void newTab(String ref, Boolean resolveTabs) {
  if (!resolveTabs) {
    newTab(ref);
    return;
  }

  if (isTab(ref))
    redirectTab = ref;

  String tabGroupRef = getTabGroupRef(ref);
  if (isDisplayed(tabGroupRef))
    resolveNewTab();
  else
    newTabGroup(tabGroupRef);
}

void resolveNewTab() {
  if (isNull(redirectTab))
    return;
  if (!isTab(redirectTab))
    return;

  newTab(redirectTab);
  redirectTab = "";
}

for (String ref : getTabGroups()) {
  addOnEvent(ref, "show", "resolveNewTab()");
}

/******************************************************************************/
/*                           DROPDOWN VALUE GETTER                            */
/*                                                                            */
/* For consistency with `getListItemValue()`.                                 */
/******************************************************************************/
String DROPDOWN_ITEM_VALUE = null;

String getDropdownItemValue() {
  return DROPDOWN_ITEM_VALUE;
}

for (entry : REF_TO_TYPE.entrySet()) {
  String type = entry.getValue();
  String ref  = entry.getKey();
  String evt  = "click";
  String stmt = "DROPDOWN_ITEM_VALUE = getFieldValue(\"%s\")";
  stmt = replaceFirst(stmt, ref);

  if (!type.equals("dropdown"))
    continue;
  if (hasNoUi(ref))
    continue;

  addOnEvent(ref, evt, stmt);
}

/******************************************************************************/
/*                              MENU POPULATION                               */
/******************************************************************************/
/* Deprecated: Fetches the contents of a specifed vocabulary and stores it in
 * the given list.
 */
void fetchVocab(String vocabName, List storageList) {
  fetchVocab(vocabName, storageList, null);
}

void fetchVocab(String vocabName, List storageList, String callbackFunction) {
  fetchAll("select vocabid, vocabname from vocabulary left join attributekey using (attributeid) where attributename = '" + vocabName + "';", new FetchCallback() {
    onFetch(result) {
      if (isNull(result))
        result = new ArrayList();

      storageList.addAll(result);
      Log.d("fetchVocab()", "Fetched vocabulary \"" + vocabname + "\" contents: " + result.toString());
      if (callbackFunction != null && !isNull(callbackFunction)) {
        execute(callbackFunction);
      }
    }
  });
}

/** Wrapper for to make a vocab without an exlusion list **/
String getMakeVocabType(String ref) {
  if (isHier(ref)) return "hierarchical" + getType(ref);
  else             return ""             + getType(ref);
}

void makeVocabs() {
  for (String ref : DATA_REFS)
    if (!hasNoUi(ref))
      makeVocab(ref);
  for (String ref : VP_REF_TO_REF.keySet())
    if (!hasNoUi(ref))
      makeVocab(ref);
}

void makeVocab(String ref) {
  if (!hasMenuType(ref))
    return;

  if (hasVpRef(ref))
    makeVocab(getMakeVocabType(ref), ref, getAttributeName(getVpRef(ref)));
  else
    makeVocab(getMakeVocabType(ref), ref, getAttributeName(ref));
}

void makeVocab(String type, String ref, String attrName) {
  makeVocab(type, ref, attrName, null);
}
void makeVocab(String type, String ref, String attrName, List vocabExclusions) {
    makeVocab(type, ref, attrName, vocabExclusions, null);
}

/* Populates the ref specified vocabulary from the database based on the given
 * attribute name, where type is the type of the vocab to populate (checkbox,
 * dropdown, hierarchicaldropdown, hierarchicalpicture, list, picture, radio).
 * */
void makeVocab(
    String type,
    String ref,
    String attrName,
    List   vocabExclusions,
    String callbackFunction
){
  if (
      isNull(type) ||
      isNull(ref) ||
      isNull(attrName)
  ) {
    Log.e(
        "makeVocab()",
        "Can't make populate vocab whose type, ref or attribute is null"
    );
    return;
  }

  if (!isModuleLoaded()) {
    String head = "Logic Error";
    String body = "makeVocab called before module loaded";
    showWarning(head, body);
    return;
  }

  // Make a filtered vocab
  List menuEntries = getMenuEntries(attrName);
  if (vocabExclusions == null) vocabExclusions = new ArrayList();

  List filteredVocab = new ArrayList();
  for(item : menuEntries) {
    if (vocabExclusions.contains(item.get(1))) {
      Log.d("makeVocab()", "removing vocab exclusion: " + item.get(1));
    } else {
      filteredVocab.add(item);
    }
  }

  // Determine whether to include a null option in the menu
  Boolean hasNull =
         !vocabExclusions.contains("")
      && !vocabExclusions.contains(null);

  // Populate menu
  populateMenu(type, ref, attrName, filteredVocab, hasNull);

  // Execute callback
  if (!isNull(callbackFunction))
    execute(callbackFunction);
}

boolean populateMenu(
    String  type,
    String  ref,
    String  attrName,
    List    entries,
    boolean hasNull
) {
  if (isNull(type))
    type = getMakeVocabType(ref);

  switch(type) {
    case "checkbox":
    case "CheckBoxGroup":
      populateCheckBoxGroup             (ref, entries);           break;
    case "dropdown":
    case "DropDown":
      populateDropDown                  (ref, entries, hasNull);  break;
    case "hierarchicaldropdown":
    case "HierarchicalDropDown":
      populateHierarchicalDropDown      (ref, attrName, hasNull); break;
    case "hierarchicalpicture":
    case "HierarchicalPictureGallery":
      populateHierarchicalPictureGallery(ref, attrName);          break;
    case "List":
    case "list":
      populateList                      (ref, entries);           break;
    case "picture":
    case "PictureGallery":
      populatePictureGallery            (ref, entries);           break;
    case "radio":
    case "RadioGroup":
      populateRadioGroup                (ref, entries);           break;
    default:
      Log.e(
          "populateMenu()",
          "Can't populate vocab; type '" + type + "' not recognised"
      );
      return false;
  }
  return true;
}

boolean populateMenu(String ref, List entries, boolean hasNull) {
  return populateMenu(null, ref, "", entries, hasNull);
}

boolean populateMenu(String ref, List entries) {
  return populateMenu(null, ref, "", entries, true);
}

void populateMenu(String ref, String entry, boolean hasNull) {
  List entries  = new ArrayList();
  entries.add(new NameValuePair(entry, ""));

  populateMenu(ref, entries, hasNull);
}

void populateMenu(String ref, String entry) {
  populateMenu(ref, entry, false);
}

/******************************************************************************/
/*                             MENU VALUE GETTER                              */
/*                                                                            */
/* Provides simple ways of getting a menu's vocabname as opposed to the       */
/* default, which is the vocabid.                                             */
/******************************************************************************/
// Map from vocabid to vocabname. Populated by `fetchMenuValues()`.
Map VOCABID_TO_VOCABNAME        = new HashMap();
Map VOCABNAME_TO_VOCABID        = new HashMap();
Map ATTRIB_NAME_TO_VOCABIDS     = new HashMap();
Map ATTRIB_NAME_TO_MENU_ENTRIES = new HashMap();

void setVocabId(String attrName, String vocabName, String vocabId) {
  String key = attrName + SEP + vocabName;
  String val = vocabId;

  VOCABNAME_TO_VOCABID.put(key, val);
}

String getVocabId(String attrName, String vocabName) {
  return VOCABNAME_TO_VOCABID.get(attrName + SEP + vocabName);
}

void addVocabId(String attrName, String vocabId) {
  List vocabIds = ATTRIB_NAME_TO_VOCABIDS.get(attrName);
  if (vocabIds == null) {
    vocabIds = new ArrayList();
    ATTRIB_NAME_TO_VOCABIDS.put(attrName, vocabIds);
  }

  vocabIds.add(vocabId);
}

void addMenuEntry(
    String attrName,
    String vocabId,
    String vocabName,
    String picUrl,
    String parentVocabId
) {
  List menuEntries = ATTRIB_NAME_TO_MENU_ENTRIES.get(attrName);
  if (menuEntries == null) {
    menuEntries = new ArrayList();
    ATTRIB_NAME_TO_MENU_ENTRIES.put(attrName, menuEntries);
  }

  List menuEntry = new ArrayList();
  menuEntry.add(vocabId);
  menuEntry.add(vocabName);
  menuEntry.add(picUrl);
  menuEntry.add(parentVocabId);

  menuEntries.add(menuEntry);
}

List getMenuEntries(String attrName) {
  List menuEntries = ATTRIB_NAME_TO_MENU_ENTRIES.get(attrName);
  if (menuEntries == null) return new ArrayList();
  else                     return new ArrayList(menuEntries);
}

List getMenuEntriesFromRef(String ref) {
  return getMenuEntries(getAttributeName(ref));
}

List getVocabIdsFromAttribName(String attribName) {
  List vocabIds = ATTRIB_NAME_TO_VOCABIDS.get(attribName);
  if (vocabIds == null) return new ArrayList();
  else                  return new ArrayList(vocabIds);
}

List getVocabIdsFromRef(String ref) {
  String attribName = getAttributeName(ref);
  return getVocabIdsFromAttribName(attribName);
}

/*
 * Initialises `VOCABID_TO_VOCABNAME` with the (vocabid -> vocabname) mapping of
 * every menu.
 */
void fetchMenuValues() {
  String q = "";
  q += "   SELECT VocabID, VocabName, AttributeName, PictureURL, ParentVocabID";
  q += "     FROM Vocabulary";
  q += "     JOIN AttributeKey USING (AttributeID)";
  q += " ORDER BY VocabCountOrder";

  FetchCallback populateHashMap = new FetchCallback() {
    onFetch(List result) {
      if (result == null)
        result = new ArrayList();

      for (List row : result) {
        String vocabId       = row.get(0);
        String vocabName     = row.get(1);
        String attrName      = row.get(2);
        String picUrl        = row.get(3);
        String parentVocabId = row.get(4);

        // Populate VOCABID_TO_VOCABNAME
        VOCABID_TO_VOCABNAME.put(vocabId, vocabName);

        // Populate VOCABNAME_TO_VOCABID
        setVocabId(attrName, vocabName, vocabId);

        // Populate ATTRIB_NAME_TO_VOCABIDS
        addVocabId(attrName, vocabId);

        // Populate ATTRIB_NAME_TO_MENU_ENTRIES
        addMenuEntry(attrName, vocabId, vocabName, picUrl, parentVocabId);
      }

      decAndExecIfModuleLoaded();
    }
  };

  incJobsTillLoaded();
  fetchAll(q, populateHashMap);
}

addOnEvent("module", "load", "makeVocabs()");
fetchMenuValues();

/* Returns a menu's vocabname, instead of the (counter-intuitive) vocabid.
 */
String getFieldValue(String ref, Boolean doConvertVocabIds) {
  if (!doConvertVocabIds) {
    return getFieldValue(ref);
  }

  String val       = getFieldValue(ref);
  String vocabName = VOCABID_TO_VOCABNAME.get(val);

  if (val       == null) return "";
  if (vocabName == null) return "";
  return vocabName;
}

/* Shorthand for writing getFieldValue(ref, true). This function's use is
 * discouraged in favour of writing `getFieldValue(ref, true)`.
 */
String getMenuValue(String ref) {
  return getFieldValue(ref, true);
}

HashMap NODATA_DROPDOWNS = new HashMap(); // ref -> menu entries
void addNodataDropdownEntry(String ref, String entryKey, String entryVal) {
  List menuEntries = NODATA_DROPDOWNS.get(ref);
  if (menuEntries == null) {
    menuEntries = new ArrayList();
    NODATA_DROPDOWNS.put(ref, menuEntries);
  }

  List menuEntry = new ArrayList();
  menuEntry.add(entryKey);
  menuEntry.add(entryVal);

  menuEntries.add(menuEntry);
}



for (entry : NODATA_DROPDOWNS.entrySet()) {
  String ref = entry.getKey();
  List   entries = entry.getValue();
  populateMenu(ref, entries);
}

/******************************************************************************/
/*                                  GPS/MAP                                   */
/******************************************************************************/
addOnEvent("Control/Control/GPS_diagnostics", "show", "updateGPSDiagnostics()");

void updateGPSDiagnostics() {
  String diagnosticsRef = "Control/Control/GPS_diagnostics";
  if (diagnosticsRef.equals("")) {
    return;
  }

  String status         = "";
  String previousStatus = getFieldValue(diagnosticsRef);
  String notInitialised = "{GPS_is_not_initialised}";

  // Check if GPS is initialised or was previously initialised.
  if (!isExternalGPSOn() && !isInternalGPSOn()) {
    if (!isNull(previousStatus) && !previousStatus.equals(notInitialised)) { // previous gps status is some last valid coordinate.
      // This is hackish. Arch16n substitution happens only at display-time, but the following if clause requires substitution to have happened at run-time
      String error = "";
      error = "{GPS_is_no_longer_initialised}. {Previous_status}:";
      setFieldValue(diagnosticsRef, error);   // Arch16n entry is substituted after this
      error = getFieldValue(diagnosticsRef);

      // check that error message wasn't previously appended to the previous status message.
      if (previousStatus.length()    >= error.length() &&
          previousStatus.subSequence(0, error.length()).equals(error)) {
        status = previousStatus;
      } else {
        status = error + "\n" + previousStatus;
      }
    } else {
      status = notInitialised;
    }
  } else {
    status += "{Internal_GPS}: ";
    if (isInternalGPSOn())
    {
      status += "{on}";
    } else {
      status += "{off}";
    }
    status += "\nExternal GPS: ";
    if (isExternalGPSOn())
    {
      if (isBluetoothConnected()) {
        status += "{on_and_bluetooth_connected}";
      } else {
        status += "{on_and_bluetooth_disconnected}";
      }
    } else {
      status += "{off}";
    }
    Object position = getGPSPosition();
    if (position != null) {
      Object projPosition = getGPSPositionProjected();
      status += "\n{Latitude}: " + position.getLatitude();
      status += "   {Longitude}: " + position.getLongitude();
      status += "\n{Northing}: " + projPosition.getLatitude();
      status += "   {Easting}: " + projPosition.getLongitude();
      status += "\n{Accuracy}: " + getGPSEstimatedAccuracy();
    } else {
      status += "\n{Position}: {no_GPS_position_could_be_found}";
    }
  }
  setFieldValue(diagnosticsRef, status);
}

final String MAP_CFG_PATH = "files/data/saved_config.json";
final String MAP_REF = "Control/Map/Map";
void centerMe() { centerOnCurrentPosition(MAP_REF); }
addOnEvent("Control/Map/Center_Me_1", "click", "centerMe()");
addOnEvent("Control/Map/Save_Map_Settings_1", "click", "saveMapSettings()");
addOnEvent("module", "load", "loadMapSettings()");

void loadMapSettings() {
  String filePath = getAttachedFilePath(MAP_CFG_PATH);

  if (!new File(filePath).exists())
    return;

  String toast = "showToast(\"{Loaded_Map_Configuration}\")";
  loadMapViewConfiguration(MAP_REF, filePath, toast);
}

void saveMapSettings() {
  String filePath = getAttachedFilePath(MAP_CFG_PATH);

  String toast = "showToast(\"{Saved_Map_Configuration}\")";
  saveMapViewConfiguration(MAP_REF, filePath, toast);
}

/******************************************************************************/
/*                                 ACTION BAR                                 */
/******************************************************************************/
addActionBarItem("clean_synced_files", new ActionButtonCallback() {
  actionOnLabel() {
    "{Clean_Synced_Files}";
  }
  actionOn() {
    cleanSyncedFiles();
  }
});

addActionBarItem("sync", new ToggleActionButtonCallback() {
  actionOnLabel() {
    "{Disable_Sync}";
  }
  actionOn() {
    setSyncEnabled(false);
    setFileSyncEnabled(false);
    showToast("{Sync_Disabled}");
  }
  isActionOff() {
    isSyncEnabled();
  }
  actionOffLabel() {
    "{Enable_Sync}";
  }
  actionOff() {
    setSyncEnabled(true);
    setFileSyncEnabled(true);
    showToast("{Sync_Enabled}");
  }
});

addActionBarItem("internal_gps", new ToggleActionButtonCallback() {
  actionOnLabel() {
    "{Disable_Internal_GPS}";
  }
  actionOn() {
    stopGPS();
    showToast("{Internal_GPS_Disabled}");
    updateGPSDiagnostics();
  }
  isActionOff() {
    isInternalGPSOn();
  }
  actionOffLabel() {
    "{Enable_Internal_GPS}";
  }
  actionOff() {
    if(isExternalGPSOn()) {
      stopGPS();
    }
    startInternalGPS();
    showToast("{Internal_GPS_Enabled}");
    updateGPSDiagnostics();
  }
});

addActionBarItem("external_gps", new ToggleActionButtonCallback() {
  actionOnLabel() {
    "{Disable_External_GPS}";
  }
  actionOn() {
    stopGPS();
    if (isBluetoothConnected()) {
      showToast("{External_GPS_Disabled}");
    } else {
      showToast("{Please_Enable_Bluetooth}");
    }
    updateGPSDiagnostics();
  }
  isActionOff() {
    isExternalGPSOn();
  }
  actionOffLabel() {
    "{Enable_External_GPS}";
  }
  actionOff() {
    if(isInternalGPSOn()) {
      stopGPS();
    }
    startExternalGPS();
    if(isBluetoothConnected()) {
      showToast("{External_GPS_Enabled}");
    } else {
      showToast("{Please_Enable_Bluetooth}");
      this.actionOn();
    }
    updateGPSDiagnostics();
  }
});

/******************************************************************************/
/*                                 USER LOGIN                                 */
/******************************************************************************/
boolean USER_MENU_IS_LOADED = false;

void populateListForUsers(){
  String q = "";
  q  = " SELECT          userid ";
  q += "        ||'\\0'||fname ";
  q += "        ||'\\0'||lname ";
  q += "        ||'\\0'||email ";
  q += "        ||'\\0'||password ";
  q += "        ,        fname ";
  q += "        || ' ' ||lname ";
  q += "   FROM user ";
  q += "  WHERE userdeleted is null";


  FetchCallback callback = new FetchCallback() {
    onFetch(result) {
      populateMenu(USER_MENU_PATH, result);
      USER_MENU_IS_LOADED = true;
    }
  };

  USER_MENU_IS_LOADED = false;
  populateMenu(USER_MENU_PATH, MSG_LOADING);
  fetchAll(q, callback);
}

String getUserMenuValue(int i) {
  String selectedUser = getListItemValue();
  if (selectedUser == null)
    return "";

  String[] splitted = selectedUser.split("\\\\0");
  if (i < splitted.length) return splitted[i];
  else                     return "";

}

void resetUser() {
  userId   = "";
  username = "";
  User user = new User(userId, "", "", "", "");
  setUser(user);
}

void selectUser() {
  userId           = getUserMenuValue(0);
  String nameFirst = getUserMenuValue(1);
  String nameLast  = getUserMenuValue(2);
  String email     = getUserMenuValue(3);
  String password  = getUserMenuValue(4);
  username         = nameFirst + " " + nameLast;

  User user = new User(userId, nameFirst, nameLast, email, password);
  setUser(user);
}

void onClickSignup__ () {
  setSyncEnabled(true);
  showCreateUserDialog("onSignupSuccessful()");
}

void onSignupSuccessful() {
  showWarning("{signup_head}", "{signup_body}");
  populateListForUsers();
}

if (!isNull(USER_MENU_PATH)) {
  addOnEvent(getTabGroupRef(USER_MENU_PATH), "show", "resetUser()");

  addOnEvent(USER_MENU_PATH, "show",  "populateListForUsers()");
  addOnEvent(USER_MENU_PATH, "click", "selectUser()");

  addOnEventCond(USER_MENU_PATH, "click", "USER_MENU_IS_LOADED");
}



/******************************************************************************/
/*                                 VALIDATION                                 */
/******************************************************************************/
/* `ref`  is a reference/ref to a field
 * `name` is a human-readable name for that field
 * `cond` is a String containing a boolean expression that evaluates to true if
 *        and only if the the field pair returned by this function should be
 *        validated.
 *
 *  Returns a field pair (really just an ArrayList).
 */
List fieldPair(String ref, String name, String cond) {
  List fp = new ArrayList();
  fp.add(ref);
  fp.add(name);
  fp.add(cond);
  return fp;
}

List fieldPair(String ref, String name) {
  String t = "true";
  return fieldPair(ref, name, t);
}

/* Returns true if field specified by `ref` is valid. False otherwise.
 */
boolean isValidField(String ref) {
  return !isNull(getFieldValue(ref));
}
/* `format` can either be HTML or PLAINTEXT
 */
String validateFields(List fields, String format) {
  Integer numInvalid = 0;

  /* Build validation message string (and count how many invalid fields exist) */
  String out = "{please_fill_out_the_following_fields}";
  for(f : fields) {
    String ref  = f.get(0); // Reference to field
    String name = f.get(1); // Human-readable name
    String cond = f.get(2); // Validation condition

    // Only validate a field whose validation condition evaluates to `true`
    Boolean doValidateField = (Boolean) eval(cond);
    if (!doValidateField)
      continue;

    // Add any invalid fields to the output and tally them
    if (!isValidField(ref)) {
      out += "- " + name + "\n";
      numInvalid++;
    }
  }
  // All the fields are valid; just overwrite `out` with a cheery message
  if (numInvalid == 0)
    out = "{all_fields_contain_valid_data}";

  /* Format the output as dictated by `format` */
  if (format == "HTML") {
    out = out.replace("\n", "<br>");
  } else if (format == "PLAINTEXT") {
    ;
  }

  return out;
}

List getRefsToValidateByTabGroup(String tabGroup) {
  List f = new ArrayList(); // Fields to be validated
  for (String ref : getRefsMatching(tabGroup + "/*"))
    if (REF_TO_FLAG_STRING.get(ref).contains("notnull"))
      f.add(fieldPair(ref, getArch16nKey(ref)));
  return f;
}

String getValidationMessage(String tabGroup, String format) {
  List f = getRefsToValidateByTabGroup(tabGroup);
  return validateFields(f, format);
}

void validateTabGroup(String tabGroup) {
  String validationMessage = getValidationMessage(tabGroup, "PLAINTEXT");
  showWarning("{validation_results}", validationMessage);
}

void validateControl() {
  validateTabGroup("Control");
}
void validateFlakedStoneArtefact() {
  validateTabGroup("Flaked_Stone_Artefact");
}
void validateOtherStoneArtefact() {
  validateTabGroup("Other_Stone_Artefact");
}
void validateGlassArtefact() {
  validateTabGroup("Glass_Artefact");
}
void validateCeramicArtefact() {
  validateTabGroup("Ceramic_Artefact");
}
void validateMiscArtefact() {
  validateTabGroup("Misc_Artefact");
}
void validateDiscreteHearthArtefact() {
  validateTabGroup("Discrete_Hearth_Artefact");
}
void validateButtons() {
  validateTabGroup("Buttons");
}
void validateKnappedGlassArtefact() {
  validateTabGroup("Knapped_Glass_Artefact");
}
void validateMetalArtefact() {
  validateTabGroup("Metal_Artefact");
}
void validateWeaponsandAmmunition() {
  validateTabGroup("Weapons_and_Ammunition");
}


/******************************************************************************/
/*                                 AUTOSAVING                                 */
/******************************************************************************/
Map TABGROUP_TO_UUID = Collections.synchronizedMap(new HashMap());
Set SEEN_UUIDS       = Collections.synchronizedSet(new HashSet());

String getUuid(String tabgroup) {
  return TABGROUP_TO_UUID.get(tabgroup);
}

String getUuid() {
  return getUuid(getDisplayedTabGroup());
}

void setUuid(String tabgroup, String uuid) {
  TABGROUP_TO_UUID.put(tabgroup, uuid);
}

SaveCallback getDefaultSaveCallback(String tabgroup, String callback) {
  String parentTabgroup_     = parentTabgroup;
  String parentTabgroupUuid_ = getUuid(parentTabgroup_);

  parentTabgroup = null;

  Boolean userWasSet = !username.equals("");

  callback += "; " + fun2str("executeOnEvent", new Object[]{tabgroup, "save"});

  String callbackFirstSave =
    fun2str("executeOnEvent", new Object[]{tabgroup, "firstsave"}) + "; " +
    callback;

  return new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);

      // This is a workaround for a bug where `newRecord` can be `true` twice if
      // a record was saved again shortly after it was created.
      if (SEEN_UUIDS.contains(uuid))
        newRecord = false;
      if (uuid != null)
        SEEN_UUIDS.add(uuid);

      String cb = newRecord ? callbackFirstSave : callback;

      // Make a child-parent relationship if need be.
      if (
          newRecord &&
          !isNull(parentTabgroup_) &&
          !isNull(parentTabgroupUuid_)
      ) {
        String rel = "";
        rel += parentTabgroup_.replaceAll("_", " ");
        rel += " - ";
        rel += tabgroup.replaceAll("_", " ");
        saveEntitiesToHierRel(
          rel,
          parentTabgroupUuid_,
          uuid,
          "Parent Of",
          "Child Of",
          cb
        );
      } else {
        execute(cb);
      }

      // This fixes an interesting bug. Without this, if a user was not set
      // (by calling `setUser`) at the time `saveTabGroup` was first called, but
      // set by the time `onSave` was called, the tab group is saved correctly
      // the first time only.
      //
      // Adding this allows subsequent saves to succeed. Presumably it plays
      // some role in helping FAIMS associate the correct user with a record.
      if (!userWasSet) {
        saveTabGroup(tabgroup, cb);
      }

    }
    onError(message) {
      showToast(message);
    }
  };
}

void saveTabGroup(String tabgroup) {
  saveTabGroup(tabgroup, "");
}

void saveTabGroup(String tabgroup, String callback) {
  Boolean enableAutosave = true;
  String  uuid           = getUuid(tabgroup);

  SaveCallback saveCallback = getDefaultSaveCallback(tabgroup, callback);

  saveTabGroup(
      tabgroup,
      uuid,
      autoSaveGeo,
      autoSaveAttrs,
      saveCallback,
      enableAutosave
  );

  // Reset global variables
  autoSaveGeo   = null;
  autoSaveAttrs = null;
}

void setAutoSaveGeometry(List geometry) {
  autoSaveGeo = geometry;
}

void setToTimestampNow(String ref) {
  String now = getTimestampNow();
  setFieldValue(ref, now);
}

String getTimestampNow() {
  String fmt = "yyyy-MM-dd HH:mm:ssZ";
  return getTimestampNow(fmt);
}

String getTimestampNow(String fmt, boolean doInsertColon) {
  date    = new Date();
  dateFmt = new java.text.SimpleDateFormat(fmt);
  dateStr = dateFmt.format(date);

  // Insert colon into timezone (e.g. +1000 -> +10:00)
  if (doInsertColon) {
    String left; String right;

    left    = dateStr.substring(0, dateStr.length() - 2);
    right   = dateStr.substring(   dateStr.length() - 2);
    dateStr = left + ":" + right;
  }

  return dateStr;
}

String getTimestampNow(String fmt) {
  return getTimestampNow(fmt, true);
}

void populateAuthorAndTimestamp(String tabgroup) {
  Map tabgroupToAuthor    = new HashMap();
  Map tabgroupToTimestamp = new HashMap();
  tabgroupToAuthor.put("Flaked_Stone_Artefact", "Flaked_Stone_Artefact/General/Flaked_Stone_Artefact_author");
  tabgroupToAuthor.put("Other_Stone_Artefact", "Other_Stone_Artefact/General/Other_Stone_Artefact_author");
  tabgroupToAuthor.put("Glass_Artefact", "Glass_Artefact/General/Glass_Artefact_author");
  tabgroupToAuthor.put("Ceramic_Artefact", "Ceramic_Artefact/General/Ceramic_Artefact_author");
  tabgroupToAuthor.put("Misc_Artefact", "Misc_Artefact/General/Misc_Artefact_author");
  tabgroupToAuthor.put("Discrete_Hearth_Artefact", "Discrete_Hearth_Artefact/General/Discrete_Hearth_Artefact_author");
  tabgroupToAuthor.put("Buttons", "Buttons/General/Buttons_author");
  tabgroupToAuthor.put("Knapped_Glass_Artefact", "Knapped_Glass_Artefact/General/Knapped_Glass_Artefact_author");
  tabgroupToAuthor.put("Metal_Artefact", "Metal_Artefact/General/Metal_Artefact_author");
  tabgroupToAuthor.put("Weapons_and_Ammunition", "Weapons_and_Ammunition/General/Weapons_and_Ammunition_author");
  tabgroupToTimestamp.put("Flaked_Stone_Artefact", "Flaked_Stone_Artefact/General/Flaked_Stone_Artefact_timestamp");
  tabgroupToTimestamp.put("Other_Stone_Artefact", "Other_Stone_Artefact/General/Other_Stone_Artefact_timestamp");
  tabgroupToTimestamp.put("Glass_Artefact", "Glass_Artefact/General/Glass_Artefact_timestamp");
  tabgroupToTimestamp.put("Ceramic_Artefact", "Ceramic_Artefact/General/Ceramic_Artefact_timestamp");
  tabgroupToTimestamp.put("Misc_Artefact", "Misc_Artefact/General/Misc_Artefact_timestamp");
  tabgroupToTimestamp.put("Discrete_Hearth_Artefact", "Discrete_Hearth_Artefact/General/Discrete_Hearth_Artefact_timestamp");
  tabgroupToTimestamp.put("Buttons", "Buttons/General/Buttons_timestamp");
  tabgroupToTimestamp.put("Knapped_Glass_Artefact", "Knapped_Glass_Artefact/General/Knapped_Glass_Artefact_timestamp");
  tabgroupToTimestamp.put("Metal_Artefact", "Metal_Artefact/General/Metal_Artefact_timestamp");
  tabgroupToTimestamp.put("Weapons_and_Ammunition", "Weapons_and_Ammunition/General/Weapons_and_Ammunition_timestamp");
  String authorPath    = tabgroupToAuthor.get(tabgroup);
  String timestampPath = tabgroupToTimestamp.get(tabgroup);

  if (!isNull(authorPath))    setFieldValue(authorPath,    username);
  if (!isNull(timestampPath)) setFieldValue(timestampPath, getTimestampNow());
}

for (String tabGroup : getTabGroups()) {
  if (isFlaggedNodata    (tabGroup)) continue;
  if (hasNoUi            (tabGroup)) continue;
  if (isFlaggedNoautosave(tabGroup)) continue;
  String funStr = fun2str("saveTabGroup", new Object[]{tabGroup});
  addOnEvent(tabGroup, "show", funStr);
}

void onClickUserListUserList () {
  newTab("Control", true);
}

void onClickFlakedStoneArtefactFindThisinTheMap () {
  newTab("Control/Map", true);
}

void onClickOtherStoneArtefactFindThisinTheMap () {
  newTab("Control/Map", true);
}

void onClickGlassArtefactFindThisinTheMap () {
  newTab("Control/Map", true);
}

void onClickCeramicArtefactFindThisinTheMap () {
  newTab("Control/Map", true);
}

void onClickMiscArtefactFindThisinTheMap () {
  newTab("Control/Map", true);
}

void onClickDiscreteHearthArtefactFindThisinTheMap () {
  newTab("Control/Map", true);
}

void onClickButtonsFindThisinTheMap () {
  newTab("Control/Map", true);
}

void onClickKnappedGlassArtefactFindThisinTheMap () {
  newTab("Control/Map", true);
}

void onClickMetalArtefactFindThisinTheMap () {
  newTab("Control/Map", true);
}

void onClickWeaponsandAmmunitionFindThisinTheMap () {
  newTab("Control/Map", true);
}

void onClickControlFlakedStoneArtefact () {
  parentTabgroup__ = "Control";
  newFlakedStoneArtefact();
}

void onClickControlOtherStoneArtefact () {
  parentTabgroup__ = "Control";
  newOtherStoneArtefact();
}

void onClickControlKnappedGlassArtefact () {
  parentTabgroup__ = "Control";
  newKnappedGlassArtefact();
}

void onClickControlDiscreteHearthFeature () {
  parentTabgroup__ = "Control";
  newDiscreteHearthArtefact();
}

void onClickControlGlassArtefact () {
  parentTabgroup__ = "Control";
  newGlassArtefact();
}

void onClickControlCeramicArtefact () {
  parentTabgroup__ = "Control";
  newCeramicArtefact();
}

void onClickControlButtons () {
  parentTabgroup__ = "Control";
  newButtons();
}

void onClickControlMetalArtefact () {
  parentTabgroup__ = "Control";
  newMetalArtefact();
}

void onClickControlWeaponsandAmmunition () {
  parentTabgroup__ = "Control";
  newWeaponsandAmmunition();
}

void onClickControlMiscArtefact () {
  parentTabgroup__ = "Control";
  newMiscArtefact();
}








addOnEvent("User_List/User_List/User_List", "click", "onClickUserListUserList()");
addOnEvent("Control/Control/Flaked_Stone_Artefact", "click", "onClickControlFlakedStoneArtefact()");
addOnEvent("Control/Control/Other_Stone_Artefact", "click", "onClickControlOtherStoneArtefact()");
addOnEvent("Control/Control/Knapped_Glass_Artefact", "click", "onClickControlKnappedGlassArtefact()");
addOnEvent("Control/Control/Discrete_Hearth_Feature", "click", "onClickControlDiscreteHearthFeature()");
addOnEvent("Control/Control/Glass_Artefact", "click", "onClickControlGlassArtefact()");
addOnEvent("Control/Control/Ceramic_Artefact", "click", "onClickControlCeramicArtefact()");
addOnEvent("Control/Control/Buttons", "click", "onClickControlButtons()");
addOnEvent("Control/Control/Metal_Artefact", "click", "onClickControlMetalArtefact()");
addOnEvent("Control/Control/Weapons_and_Ammunition", "click", "onClickControlWeaponsandAmmunition()");
addOnEvent("Control/Control/Misc_Artefact", "click", "onClickControlMiscArtefact()");
addOnEvent("Flaked_Stone_Artefact/General/Find_This_in_The_Map", "click", "onClickFlakedStoneArtefactFindThisinTheMap()");
addOnEvent("Other_Stone_Artefact/General/Find_This_in_The_Map", "click", "onClickOtherStoneArtefactFindThisinTheMap()");
addOnEvent("Glass_Artefact/General/Find_This_in_The_Map", "click", "onClickGlassArtefactFindThisinTheMap()");
addOnEvent("Ceramic_Artefact/General/Find_This_in_The_Map", "click", "onClickCeramicArtefactFindThisinTheMap()");
addOnEvent("Misc_Artefact/General/Find_This_in_The_Map", "click", "onClickMiscArtefactFindThisinTheMap()");
addOnEvent("Discrete_Hearth_Artefact/General/Find_This_in_The_Map", "click", "onClickDiscreteHearthArtefactFindThisinTheMap()");
addOnEvent("Buttons/General/Find_This_in_The_Map", "click", "onClickButtonsFindThisinTheMap()");
addOnEvent("Knapped_Glass_Artefact/General/Find_This_in_The_Map", "click", "onClickKnappedGlassArtefactFindThisinTheMap()");
addOnEvent("Metal_Artefact/General/Find_This_in_The_Map", "click", "onClickMetalArtefactFindThisinTheMap()");
addOnEvent("Weapons_and_Ammunition/General/Find_This_in_The_Map", "click", "onClickWeaponsandAmmunitionFindThisinTheMap()");

/******************************************************************************/
/*                   AUDIO, CAMERA, FILE AND VIDEO BINDINGS                   */
/******************************************************************************/
addOnEvent("Flaked_Stone_Artefact/General/Device_photos_Button_1", "click", "attachPictureTo(\"Flaked_Stone_Artefact/General/Device_photos\")");
addOnEvent("Other_Stone_Artefact/General/Device_photos_Button_1", "click", "attachPictureTo(\"Other_Stone_Artefact/General/Device_photos\")");
addOnEvent("Glass_Artefact/General/Device_photos_Button_1", "click", "attachPictureTo(\"Glass_Artefact/General/Device_photos\")");
addOnEvent("Ceramic_Artefact/General/Device_photos_Button_1", "click", "attachPictureTo(\"Ceramic_Artefact/General/Device_photos\")");
addOnEvent("Misc_Artefact/General/Device_photos_Button_1", "click", "attachPictureTo(\"Misc_Artefact/General/Device_photos\")");
addOnEvent("Discrete_Hearth_Artefact/General/Device_photos_Button_1", "click", "attachPictureTo(\"Discrete_Hearth_Artefact/General/Device_photos\")");
addOnEvent("Buttons/General/Device_photos_Button_1", "click", "attachPictureTo(\"Buttons/General/Device_photos\")");
addOnEvent("Knapped_Glass_Artefact/General/Device_photos_Button_1", "click", "attachPictureTo(\"Knapped_Glass_Artefact/General/Device_photos\")");
addOnEvent("Metal_Artefact/General/Device_photos_Button_1", "click", "attachPictureTo(\"Metal_Artefact/General/Device_photos\")");
addOnEvent("Weapons_and_Ammunition/General/Device_photos_Button_1", "click", "attachPictureTo(\"Weapons_and_Ammunition/General/Device_photos\")");
addOnEvent("Flaked_Stone_Artefact/Supplementary/External_camera_image_attachment_Button_1", "click", "attachFileTo(\"Flaked_Stone_Artefact/Supplementary/External_camera_image_attachment\")");
addOnEvent("Other_Stone_Artefact/Supplementary/External_camera_image_attachment_Button_1", "click", "attachFileTo(\"Other_Stone_Artefact/Supplementary/External_camera_image_attachment\")");
addOnEvent("Glass_Artefact/Supplementary/External_camera_image_attachment_Button_1", "click", "attachFileTo(\"Glass_Artefact/Supplementary/External_camera_image_attachment\")");
addOnEvent("Ceramic_Artefact/Supplementary/External_camera_image_attachment_Button_1", "click", "attachFileTo(\"Ceramic_Artefact/Supplementary/External_camera_image_attachment\")");
addOnEvent("Misc_Artefact/Supplementary/External_camera_image_attachment_Button_1", "click", "attachFileTo(\"Misc_Artefact/Supplementary/External_camera_image_attachment\")");
addOnEvent("Discrete_Hearth_Artefact/Supplementary/External_camera_image_attachment_Button_1", "click", "attachFileTo(\"Discrete_Hearth_Artefact/Supplementary/External_camera_image_attachment\")");
addOnEvent("Buttons/Supplementary/External_camera_image_attachment_Button_1", "click", "attachFileTo(\"Buttons/Supplementary/External_camera_image_attachment\")");
addOnEvent("Knapped_Glass_Artefact/Supplementary/External_camera_image_attachment_Button_1", "click", "attachFileTo(\"Knapped_Glass_Artefact/Supplementary/External_camera_image_attachment\")");
addOnEvent("Metal_Artefact/Supplementary/External_camera_image_attachment_Button_1", "click", "attachFileTo(\"Metal_Artefact/Supplementary/External_camera_image_attachment\")");
addOnEvent("Weapons_and_Ammunition/Supplementary/External_camera_image_attachment_Button_1", "click", "attachFileTo(\"Weapons_and_Ammunition/Supplementary/External_camera_image_attachment\")");

/******************************************************************************/
/*                 BINDINGS FOR 'VIEW ATTACHED FILES' BUTTONS                 */
/******************************************************************************/


/******************************************************************************/
/*                             NAVIGATION DRAWER                              */
/******************************************************************************/
void removeNavigationButtons() {
  removeNavigationButton("new");
  removeNavigationButton("duplicate");
  removeNavigationButton("delete");
  removeNavigationButton("validate");
}

void addNavigationButtons(String tabgroup) {
  removeNavigationButtons();
  List tabgroupsToValidate = new ArrayList();
  tabgroupsToValidate.add("Control");
  tabgroupsToValidate.add("Ceramic_Artefact");
  tabgroupsToValidate.add("Discrete_Hearth_Artefact");
  tabgroupsToValidate.add("Knapped_Glass_Artefact");
  tabgroupsToValidate.add("Other_Stone_Artefact");
  tabgroupsToValidate.add("Weapons_and_Ammunition");
  tabgroupsToValidate.add("Buttons");
  tabgroupsToValidate.add("Metal_Artefact");
  tabgroupsToValidate.add("Flaked_Stone_Artefact");
  tabgroupsToValidate.add("Glass_Artefact");
  tabgroupsToValidate.add("Misc_Artefact");
  addNavigationButton("new", new ActionButtonCallback() {
    actionOnLabel() {
      "{New}";
    }
    actionOn() {
      if(isNull(getUuid(tabgroup))) {
        showAlert(
            "{Warning}",
            "{The_current_record_has_not_been_saved_yet}",
            fun2str("newRecord", new Object[]{tabgroup, true}),
            ""
        );
      } else {
        newRecord(tabgroup, true);
        showToast("{New_record_created}");
      }
    }
  }, "success");
  addNavigationButton("duplicate", new ActionButtonCallback() {
    actionOnLabel() {
      "{Duplicate}";
    }
    actionOn() {
      if(!isNull(getUuid(tabgroup))) {
        duplicateRecord(tabgroup);
      } else {
        showWarning("{Warning}", "{This_record_is_unsaved_and_cannot_be_duplicated}");
      }
    }
  }, "primary");
  addNavigationButton("delete", new ActionButtonCallback() {
    actionOnLabel() {
      "{Delete}";
    }
    actionOn() {
      deleteRecord(tabgroup);
    }
  }, "danger");
  if (tabgroupsToValidate.contains(tabgroup)) {
    addNavigationButton("validate", new ActionButtonCallback() {
      actionOnLabel() {
        "{Validate}";
      }
      actionOn() {
        String validationFunction = "validate" + tabgroup.replaceAll("_", "") + "()";
        eval(validationFunction);
      }
    }, "default");
  }
}

/******************************************************************************/
/*        ENTITY AND RELATIONSHIP SAVING AND LOADING HELPER FUNCTIONS         */
/******************************************************************************/
/** Saves two entity id's as a relation. **/
void saveEntitiesToRel(String type, String entity1, String entity2) {
  String callback = null;
  saveEntitiesToRel(type, entity1, entity2, callback);
}

/** Saves two entity id's as a relation with some callback executed. **/
void saveEntitiesToRel(String type, String entity1, String entity2, String callback) {
  String e1verb = null;
  String e2verb = null;
  saveEntitiesToHierRel(type, entity1, entity2, e1verb, e2verb, callback);
}

void saveEntitiesToRel(String type, String entity1, String entity2, Callable callback) {
  String e1verb = null;
  String e2verb = null;
  saveEntitiesToHierRel(type, entity1, entity2, e1verb, e2verb, callback);
}

/** Saves two entity id's as a hierachical relation with some callback executed. **/
void saveEntitiesToHierRel(String type, String entity1, String entity2, String e1verb, String e2verb, String callback) {
  if (isNull(entity1) || isNull(entity2)) return;

  SaveCallback execCallback = new SaveCallback() {
    onSaveAssociation(entity_id, rel_id) {
      if(!isNull(callback)) {
         execute(callback);
      }
    }
    onError(message) {
      Log.e("saveEntitiesToHierRel", message);
      showToast(message);
    }
  };

  SaveCallback addMoreToRel = new SaveCallback() {
    onSaveAssociation(entity_id, rel_id) {
      addReln(entity2, rel_id, e2verb, execCallback);
    }
    onError(message) {
      Log.e("saveEntitiesToHierRel", message);
      showToast(message);
    }
  };

  SaveCallback addToRel = new SaveCallback() {
    onSave(rel_id, newRecord) {
      addReln(entity1, rel_id, e1verb, addMoreToRel);
    }
    onError(message) {
      Log.e("saveEntitiesToHierRel", message);
      showToast(message);
    }
  };

  saveRel(null, type, null, null, addToRel);
}

void saveEntitiesToHierRel(String type, String entity1, String entity2, String e1verb, String e2verb, Callable callback) {
  if (isNull(entity1) || isNull(entity2)) return;

  SaveCallback execCallback = new SaveCallback() {
    onSaveAssociation(entity_id, rel_id) {
      if(callback == null) {
         callback.call();
      }
    }
    onError(message) {
      Log.e("saveEntitiesToHierRel", message);
      showToast(message);
    }
  };

  SaveCallback addMoreToRel = new SaveCallback() {
    onSaveAssociation(entity_id, rel_id) {
      addReln(entity2, rel_id, e2verb, execCallback);
    }
    onError(message) {
      Log.e("saveEntitiesToHierRel", message);
      showToast(message);
    }
  };

  SaveCallback addToRel = new SaveCallback() {
    onSave(rel_id, newRecord) {
      addReln(entity1, rel_id, e1verb, addMoreToRel);
    }
    onError(message) {
      Log.e("saveEntitiesToHierRel", message);
      showToast(message);
    }
  };

  saveRel(null, type, null, null, addToRel);
}

// Makes a new record of the given tabgroup
void newRecord(String tabgroup) {
  boolean doUpdateRelVars = false;
  newRecord(tabgroup, doUpdateRelVars);
}

void newRecord(String tabgroup, String parentTabGroup) {
  parentTabgroup   = parentTabGroup;
  parentTabgroup__ = parentTabGroup;
  newRecord(tabgroup, false);
}

void newRecord(String tabgroup, boolean doUpdateRelVars) {
  if (doUpdateRelVars) {
    String uuidOld = getUuid(getDisplayedTabGroup());
    String q       = getDuplicateRelnQuery(uuidOld); // We're not duplicating
                                                     // anything, just getting
                                                     // the parent's UUID.

    cancelTabGroup(tabgroup, false);

    FetchCallback updateRelVars = new FetchCallback() {
      onFetch(result) {
        if (result != null && result.size() >= 1) {
          parentTabgroup   = result.get(0).get(4);
          parentTabgroup   = parentTabgroup.replaceAll(" ", "_");
          parentTabgroup__ = parentTabgroup;
        }

        newRecord(tabgroup, false);
      }
    };
    fetchAll(q, updateRelVars);
    return;
  }

  String newTabGroupFunction = "new" + tabgroup.replaceAll("_", "") + "()"; // Typical value: "newTabgroup()"
  eval(newTabGroupFunction);

  Log.d("newRecord", tabgroup);
}

// Deletes the current record of the given tabgroup
void deleteRecord(String tabgroup) {
  if (isNull(getUuid(tabgroup))) {
    cancelTabGroup(tabgroup, true);
  } else {
    showAlert(
        "{Confirm_Deletion}",
        "{Press_OK_to_Delete_this_Record}",
        fun2str("reallyDeleteRecord", tabgroup),
        "doNotDelete()"
    );
  }

  Log.d("deleteRecord", tabgroup);
}

void reallyDeleteRecord(String tabgroup) {
  DeleteCallback callback = new DeleteCallback() {
    onDelete(uuid) {
      populateEntityListsOfArchEnt(tabgroup);
      executeOnEvent(tabgroup, "delete");
    }

    onError(message) {
      showToast(message);
    }
  };

  deleteArchEnt(getUuid(tabgroup), callback);
  cancelTabGroup(tabgroup, false);
}

// Duplicates the current record of the given tabgroup
void duplicateRecord(String tabgroup) {
  dialog = showBusy("Duplicating", "Please wait...");

  String duplicateTabGroupFunction = "duplicate" + tabgroup.replaceAll("_", "") + "()"; // Typical value: "duplicateTabgroup()"
  eval(duplicateTabGroupFunction);

  Log.d("duplicateRecord", tabgroup);
}

// generic fetch saved attributes query
String getDuplicateAttributeQuery(String originalRecordID, String attributesToDupe) {
  if (attributesToDupe.equals("")) {
    attributesToDupe = "''";
  }
  String duplicateQuery = "SELECT attributename, freetext, vocabid, measure, certainty " +
                          "  FROM latestnondeletedaentvalue JOIN attributekey USING (attributeid) " +
                          " WHERE attributename IN ('', "+attributesToDupe+") " +
                          "   AND uuid = '"+originalRecordID+"'; ";
  return duplicateQuery;
}

String getDuplicateRelnQuery(String originalRecordID) {
  String dupeRelnQuery = "SELECT relntypename, parentparticipatesverb, childparticipatesverb, parentuuid, parentaenttypename, childaenttypename"+
                         "  FROM parentchild join relationship using (relationshipid) "+
                         "  JOIN relntype using (relntypeid) "+
                         " WHERE childuuid = '"+originalRecordID+"' " +
                         "   AND parentparticipatesverb = 'Parent Of' ";
  return dupeRelnQuery;
}

void makeDuplicateRelationships(fetchedAttributes, String newUuid){
  Log.e("Module", "makeDuplicateRelationships");
  for (savedAttribute : fetchedAttributes){
    String relntypename           = savedAttribute.get(0);
    String parentparticipatesverb = savedAttribute.get(1);
    String childparticipatesverb  = savedAttribute.get(2);
    String parentUuid             = savedAttribute.get(3);
    String childArchEntType       = savedAttribute.get(5);

    String onSaveRel              = getStatementsString(
        childArchEntType.replaceAll(" ", "_"),
        "save"
    );

    saveEntitiesToHierRel(
        relntypename,
        parentUuid,
        newUuid,
        parentparticipatesverb,
        childparticipatesverb,
        onSaveRel
    );
  }
}

// generic get extra attributes
List getExtraAttributes(fetchedAttributes) {
  List extraAttributes = createAttributeList();
  Log.d("Module", "Duplicating fetched attributes: " + fetchedAttributes.toString());
  for (savedAttribute : fetchedAttributes) {
    extraAttributes.add(
      createEntityAttribute(
        savedAttribute.get(0),
        savedAttribute.get(1),
        savedAttribute.get(2),
        savedAttribute.get(3),
        savedAttribute.get(4)
      )
    );
  }
  return extraAttributes;
}

void loadEntity() {
  loadEntity(false);
}
void loadEntity(Boolean isDropdown) {
  if (isDropdown) {
    loadEntityFrom(getDropdownItemValue());
  } else {
    loadEntityFrom(getListItemValue());
  }
}

void loadEntityFrom(String entityID) {
  loadEntityFrom(entityID, "");
}

void loadEntityFrom(String entityID, String onFail) {
  if (isNull(entityID)) {
    return;
  }

  String getEntTypeNameQ = "SELECT aenttypename " +
                           "  FROM latestnondeletedarchent " +
                           "  JOIN aenttype " +
                           " USING (aenttypeid) " +
                           " WHERE uuid = '" + entityID + "'";
  fetchAll(getEntTypeNameQ, new FetchCallback() {
    onFetch(result) {
      if (
          result               == null ||
          result       .size() == 0    ||
          result.get(0).size() == 0
      ) {
        String head  = "{err_load_entity_head}";
        String body  = "{err_load_entity_body}";
        showWarning(head, body);
        execute(onFail);
        return;
      }

      String archEntName = result.get(0).get(0).replaceAll(" ", "");
      String loadFunction = "load" + archEntName + "From(entityID)"; // Typical value: loadContextFrom(entityID)
      eval(loadFunction);
    }
  });
}


void newFlakedStoneArtefact(String parent){
  String tabgroup = "Flaked_Stone_Artefact";
  if (!isNull(parent)) {
    triggerAutoSave();
    parentTabgroup   = parent;
    parentTabgroup__ = parent;
  }
  if (isNull("Control/Autonumbering/Next_Flaked_Stone_Artefact_ID")) {
    showWarning("{Alert}", "{A_next_ID_has_not_been_entered_please_provide_one}");
    return;
  }

  setUuid(tabgroup, null);
  newTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  incAutoNum("Flaked_Stone_Artefact/General/Flaked_Stone_Artefact_ID");

  executeOnEvent(tabgroup, "create");
}

void newFlakedStoneArtefact (){
  newFlakedStoneArtefact(null);
}

void newOtherStoneArtefact(String parent){
  String tabgroup = "Other_Stone_Artefact";
  if (!isNull(parent)) {
    triggerAutoSave();
    parentTabgroup   = parent;
    parentTabgroup__ = parent;
  }
  if (isNull("Control/Autonumbering/Next_Other_Stone_Artefact_ID")) {
    showWarning("{Alert}", "{A_next_ID_has_not_been_entered_please_provide_one}");
    return;
  }

  setUuid(tabgroup, null);
  newTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  incAutoNum("Other_Stone_Artefact/General/Other_Stone_Artefact_ID");

  executeOnEvent(tabgroup, "create");
}

void newOtherStoneArtefact (){
  newOtherStoneArtefact(null);
}

void newGlassArtefact(String parent){
  String tabgroup = "Glass_Artefact";
  if (!isNull(parent)) {
    triggerAutoSave();
    parentTabgroup   = parent;
    parentTabgroup__ = parent;
  }
  if (isNull("Control/Autonumbering/Next_Glass_Artefact_ID")) {
    showWarning("{Alert}", "{A_next_ID_has_not_been_entered_please_provide_one}");
    return;
  }

  setUuid(tabgroup, null);
  newTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  incAutoNum("Glass_Artefact/General/Glass_Artefact_ID");

  executeOnEvent(tabgroup, "create");
}

void newGlassArtefact (){
  newGlassArtefact(null);
}

void newCeramicArtefact(String parent){
  String tabgroup = "Ceramic_Artefact";
  if (!isNull(parent)) {
    triggerAutoSave();
    parentTabgroup   = parent;
    parentTabgroup__ = parent;
  }
  if (isNull("Control/Autonumbering/Next_Ceramic_Artefact_ID")) {
    showWarning("{Alert}", "{A_next_ID_has_not_been_entered_please_provide_one}");
    return;
  }

  setUuid(tabgroup, null);
  newTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  incAutoNum("Ceramic_Artefact/General/Ceramic_Artefact_ID");

  executeOnEvent(tabgroup, "create");
}

void newCeramicArtefact (){
  newCeramicArtefact(null);
}

void newMiscArtefact(String parent){
  String tabgroup = "Misc_Artefact";
  if (!isNull(parent)) {
    triggerAutoSave();
    parentTabgroup   = parent;
    parentTabgroup__ = parent;
  }
  if (isNull("Control/Autonumbering/Next_Misc_Artefact_ID")) {
    showWarning("{Alert}", "{A_next_ID_has_not_been_entered_please_provide_one}");
    return;
  }

  setUuid(tabgroup, null);
  newTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  incAutoNum("Misc_Artefact/General/Misc_Artefact_ID");

  executeOnEvent(tabgroup, "create");
}

void newMiscArtefact (){
  newMiscArtefact(null);
}

void newDiscreteHearthArtefact(String parent){
  String tabgroup = "Discrete_Hearth_Artefact";
  if (!isNull(parent)) {
    triggerAutoSave();
    parentTabgroup   = parent;
    parentTabgroup__ = parent;
  }
  if (isNull("Control/Autonumbering/Next_Discrete_Hearth_Artefact_ID")) {
    showWarning("{Alert}", "{A_next_ID_has_not_been_entered_please_provide_one}");
    return;
  }

  setUuid(tabgroup, null);
  newTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  incAutoNum("Discrete_Hearth_Artefact/General/Discrete_Hearth_Artefact_ID");

  executeOnEvent(tabgroup, "create");
}

void newDiscreteHearthArtefact (){
  newDiscreteHearthArtefact(null);
}

void newButtons(String parent){
  String tabgroup = "Buttons";
  if (!isNull(parent)) {
    triggerAutoSave();
    parentTabgroup   = parent;
    parentTabgroup__ = parent;
  }
  if (isNull("Control/Autonumbering/Next_Buttons_ID")) {
    showWarning("{Alert}", "{A_next_ID_has_not_been_entered_please_provide_one}");
    return;
  }

  setUuid(tabgroup, null);
  newTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  incAutoNum("Buttons/General/Buttons_ID");

  executeOnEvent(tabgroup, "create");
}

void newButtons (){
  newButtons(null);
}

void newKnappedGlassArtefact(String parent){
  String tabgroup = "Knapped_Glass_Artefact";
  if (!isNull(parent)) {
    triggerAutoSave();
    parentTabgroup   = parent;
    parentTabgroup__ = parent;
  }
  if (isNull("Control/Autonumbering/Next_Knapped_Glass_Artefact_ID")) {
    showWarning("{Alert}", "{A_next_ID_has_not_been_entered_please_provide_one}");
    return;
  }

  setUuid(tabgroup, null);
  newTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  incAutoNum("Knapped_Glass_Artefact/General/Knapped_Glass_Artefact_ID");

  executeOnEvent(tabgroup, "create");
}

void newKnappedGlassArtefact (){
  newKnappedGlassArtefact(null);
}

void newMetalArtefact(String parent){
  String tabgroup = "Metal_Artefact";
  if (!isNull(parent)) {
    triggerAutoSave();
    parentTabgroup   = parent;
    parentTabgroup__ = parent;
  }
  if (isNull("Control/Autonumbering/Next_Metal_Artefact_ID")) {
    showWarning("{Alert}", "{A_next_ID_has_not_been_entered_please_provide_one}");
    return;
  }

  setUuid(tabgroup, null);
  newTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  incAutoNum("Metal_Artefact/General/Metal_Artefact_ID");

  executeOnEvent(tabgroup, "create");
}

void newMetalArtefact (){
  newMetalArtefact(null);
}

void newWeaponsandAmmunition(String parent){
  String tabgroup = "Weapons_and_Ammunition";
  if (!isNull(parent)) {
    triggerAutoSave();
    parentTabgroup   = parent;
    parentTabgroup__ = parent;
  }
  if (isNull("Control/Autonumbering/Next_Weapons_and_Ammunition_ID")) {
    showWarning("{Alert}", "{A_next_ID_has_not_been_entered_please_provide_one}");
    return;
  }

  setUuid(tabgroup, null);
  newTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  incAutoNum("Weapons_and_Ammunition/General/Weapons_and_Ammunition_ID");

  executeOnEvent(tabgroup, "create");
}

void newWeaponsandAmmunition (){
  newWeaponsandAmmunition(null);
}
void duplicateFlakedStoneArtefact(){
  String tabgroup = "Flaked_Stone_Artefact";
  String uuidOld = getUuid(tabgroup);
  setUuid(tabgroup, "");
  disableAutoSave(tabgroup);
  incAutoNum("Flaked_Stone_Artefact/General/Flaked_Stone_Artefact_ID");
  clearGpsInTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  populateCameraPictureGallery("Flaked_Stone_Artefact/General/Device_photos", new ArrayList());
  populateFileList("Flaked_Stone_Artefact/Supplementary/External_camera_image_attachment", new ArrayList());
  executeOnEvent(tabgroup, "copy");

  saveCallback = new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);

      fetchAll(getDuplicateRelnQuery(uuidOld), new FetchCallback(){
        onFetch(result) {
          Log.e("Module", result.toString());

          if (result != null && result.size() >= 1) {
            parentTabgroup__ = result.get(0).get(4);
            parentTabgroup__ = parentTabgroup__.replaceAll(" ", "_");
          }

          makeDuplicateRelationships(result, getUuid(tabgroup));

          showToast("{Duplicated_record}");
          dialog.dismiss();
        }
      });

      saveTabGroup(tabgroup);
    }
  };

  String extraDupeAttributes = "";
  fetchAll(getDuplicateAttributeQuery(uuidOld, extraDupeAttributes), new FetchCallback(){
    onFetch(result) {
      excludeAttributes = new ArrayList();

      excludeAttributes.add("Device photos");
      excludeAttributes.add("External camera image attachment");

      duplicateTabGroup(tabgroup, null, getExtraAttributes(result), excludeAttributes, saveCallback);
    }
  });
}
void duplicateOtherStoneArtefact(){
  String tabgroup = "Other_Stone_Artefact";
  String uuidOld = getUuid(tabgroup);
  setUuid(tabgroup, "");
  disableAutoSave(tabgroup);
  incAutoNum("Other_Stone_Artefact/General/Other_Stone_Artefact_ID");
  clearGpsInTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  populateCameraPictureGallery("Other_Stone_Artefact/General/Device_photos", new ArrayList());
  populateFileList("Other_Stone_Artefact/Supplementary/External_camera_image_attachment", new ArrayList());
  executeOnEvent(tabgroup, "copy");

  saveCallback = new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);

      fetchAll(getDuplicateRelnQuery(uuidOld), new FetchCallback(){
        onFetch(result) {
          Log.e("Module", result.toString());

          if (result != null && result.size() >= 1) {
            parentTabgroup__ = result.get(0).get(4);
            parentTabgroup__ = parentTabgroup__.replaceAll(" ", "_");
          }

          makeDuplicateRelationships(result, getUuid(tabgroup));

          showToast("{Duplicated_record}");
          dialog.dismiss();
        }
      });

      saveTabGroup(tabgroup);
    }
  };

  String extraDupeAttributes = "";
  fetchAll(getDuplicateAttributeQuery(uuidOld, extraDupeAttributes), new FetchCallback(){
    onFetch(result) {
      excludeAttributes = new ArrayList();

      excludeAttributes.add("Device photos");
      excludeAttributes.add("External camera image attachment");

      duplicateTabGroup(tabgroup, null, getExtraAttributes(result), excludeAttributes, saveCallback);
    }
  });
}
void duplicateGlassArtefact(){
  String tabgroup = "Glass_Artefact";
  String uuidOld = getUuid(tabgroup);
  setUuid(tabgroup, "");
  disableAutoSave(tabgroup);
  incAutoNum("Glass_Artefact/General/Glass_Artefact_ID");
  clearGpsInTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  populateCameraPictureGallery("Glass_Artefact/General/Device_photos", new ArrayList());
  populateFileList("Glass_Artefact/Supplementary/External_camera_image_attachment", new ArrayList());
  executeOnEvent(tabgroup, "copy");

  saveCallback = new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);

      fetchAll(getDuplicateRelnQuery(uuidOld), new FetchCallback(){
        onFetch(result) {
          Log.e("Module", result.toString());

          if (result != null && result.size() >= 1) {
            parentTabgroup__ = result.get(0).get(4);
            parentTabgroup__ = parentTabgroup__.replaceAll(" ", "_");
          }

          makeDuplicateRelationships(result, getUuid(tabgroup));

          showToast("{Duplicated_record}");
          dialog.dismiss();
        }
      });

      saveTabGroup(tabgroup);
    }
  };

  String extraDupeAttributes = "";
  fetchAll(getDuplicateAttributeQuery(uuidOld, extraDupeAttributes), new FetchCallback(){
    onFetch(result) {
      excludeAttributes = new ArrayList();

      excludeAttributes.add("Device photos");
      excludeAttributes.add("External camera image attachment");

      duplicateTabGroup(tabgroup, null, getExtraAttributes(result), excludeAttributes, saveCallback);
    }
  });
}
void duplicateCeramicArtefact(){
  String tabgroup = "Ceramic_Artefact";
  String uuidOld = getUuid(tabgroup);
  setUuid(tabgroup, "");
  disableAutoSave(tabgroup);
  incAutoNum("Ceramic_Artefact/General/Ceramic_Artefact_ID");
  clearGpsInTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  populateCameraPictureGallery("Ceramic_Artefact/General/Device_photos", new ArrayList());
  populateFileList("Ceramic_Artefact/Supplementary/External_camera_image_attachment", new ArrayList());
  executeOnEvent(tabgroup, "copy");

  saveCallback = new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);

      fetchAll(getDuplicateRelnQuery(uuidOld), new FetchCallback(){
        onFetch(result) {
          Log.e("Module", result.toString());

          if (result != null && result.size() >= 1) {
            parentTabgroup__ = result.get(0).get(4);
            parentTabgroup__ = parentTabgroup__.replaceAll(" ", "_");
          }

          makeDuplicateRelationships(result, getUuid(tabgroup));

          showToast("{Duplicated_record}");
          dialog.dismiss();
        }
      });

      saveTabGroup(tabgroup);
    }
  };

  String extraDupeAttributes = "";
  fetchAll(getDuplicateAttributeQuery(uuidOld, extraDupeAttributes), new FetchCallback(){
    onFetch(result) {
      excludeAttributes = new ArrayList();

      excludeAttributes.add("Device photos");
      excludeAttributes.add("External camera image attachment");

      duplicateTabGroup(tabgroup, null, getExtraAttributes(result), excludeAttributes, saveCallback);
    }
  });
}
void duplicateMiscArtefact(){
  String tabgroup = "Misc_Artefact";
  String uuidOld = getUuid(tabgroup);
  setUuid(tabgroup, "");
  disableAutoSave(tabgroup);
  incAutoNum("Misc_Artefact/General/Misc_Artefact_ID");
  clearGpsInTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  populateCameraPictureGallery("Misc_Artefact/General/Device_photos", new ArrayList());
  populateFileList("Misc_Artefact/Supplementary/External_camera_image_attachment", new ArrayList());
  executeOnEvent(tabgroup, "copy");

  saveCallback = new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);

      fetchAll(getDuplicateRelnQuery(uuidOld), new FetchCallback(){
        onFetch(result) {
          Log.e("Module", result.toString());

          if (result != null && result.size() >= 1) {
            parentTabgroup__ = result.get(0).get(4);
            parentTabgroup__ = parentTabgroup__.replaceAll(" ", "_");
          }

          makeDuplicateRelationships(result, getUuid(tabgroup));

          showToast("{Duplicated_record}");
          dialog.dismiss();
        }
      });

      saveTabGroup(tabgroup);
    }
  };

  String extraDupeAttributes = "";
  fetchAll(getDuplicateAttributeQuery(uuidOld, extraDupeAttributes), new FetchCallback(){
    onFetch(result) {
      excludeAttributes = new ArrayList();

      excludeAttributes.add("Device photos");
      excludeAttributes.add("External camera image attachment");

      duplicateTabGroup(tabgroup, null, getExtraAttributes(result), excludeAttributes, saveCallback);
    }
  });
}
void duplicateDiscreteHearthArtefact(){
  String tabgroup = "Discrete_Hearth_Artefact";
  String uuidOld = getUuid(tabgroup);
  setUuid(tabgroup, "");
  disableAutoSave(tabgroup);
  incAutoNum("Discrete_Hearth_Artefact/General/Discrete_Hearth_Artefact_ID");
  clearGpsInTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  populateCameraPictureGallery("Discrete_Hearth_Artefact/General/Device_photos", new ArrayList());
  populateFileList("Discrete_Hearth_Artefact/Supplementary/External_camera_image_attachment", new ArrayList());
  executeOnEvent(tabgroup, "copy");

  saveCallback = new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);

      fetchAll(getDuplicateRelnQuery(uuidOld), new FetchCallback(){
        onFetch(result) {
          Log.e("Module", result.toString());

          if (result != null && result.size() >= 1) {
            parentTabgroup__ = result.get(0).get(4);
            parentTabgroup__ = parentTabgroup__.replaceAll(" ", "_");
          }

          makeDuplicateRelationships(result, getUuid(tabgroup));

          showToast("{Duplicated_record}");
          dialog.dismiss();
        }
      });

      saveTabGroup(tabgroup);
    }
  };

  String extraDupeAttributes = "";
  fetchAll(getDuplicateAttributeQuery(uuidOld, extraDupeAttributes), new FetchCallback(){
    onFetch(result) {
      excludeAttributes = new ArrayList();

      excludeAttributes.add("Device photos");
      excludeAttributes.add("External camera image attachment");

      duplicateTabGroup(tabgroup, null, getExtraAttributes(result), excludeAttributes, saveCallback);
    }
  });
}
void duplicateButtons(){
  String tabgroup = "Buttons";
  String uuidOld = getUuid(tabgroup);
  setUuid(tabgroup, "");
  disableAutoSave(tabgroup);
  incAutoNum("Buttons/General/Buttons_ID");
  clearGpsInTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  populateCameraPictureGallery("Buttons/General/Device_photos", new ArrayList());
  populateFileList("Buttons/Supplementary/External_camera_image_attachment", new ArrayList());
  executeOnEvent(tabgroup, "copy");

  saveCallback = new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);

      fetchAll(getDuplicateRelnQuery(uuidOld), new FetchCallback(){
        onFetch(result) {
          Log.e("Module", result.toString());

          if (result != null && result.size() >= 1) {
            parentTabgroup__ = result.get(0).get(4);
            parentTabgroup__ = parentTabgroup__.replaceAll(" ", "_");
          }

          makeDuplicateRelationships(result, getUuid(tabgroup));

          showToast("{Duplicated_record}");
          dialog.dismiss();
        }
      });

      saveTabGroup(tabgroup);
    }
  };

  String extraDupeAttributes = "";
  fetchAll(getDuplicateAttributeQuery(uuidOld, extraDupeAttributes), new FetchCallback(){
    onFetch(result) {
      excludeAttributes = new ArrayList();

      excludeAttributes.add("Device photos");
      excludeAttributes.add("External camera image attachment");

      duplicateTabGroup(tabgroup, null, getExtraAttributes(result), excludeAttributes, saveCallback);
    }
  });
}
void duplicateKnappedGlassArtefact(){
  String tabgroup = "Knapped_Glass_Artefact";
  String uuidOld = getUuid(tabgroup);
  setUuid(tabgroup, "");
  disableAutoSave(tabgroup);
  incAutoNum("Knapped_Glass_Artefact/General/Knapped_Glass_Artefact_ID");
  clearGpsInTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  populateCameraPictureGallery("Knapped_Glass_Artefact/General/Device_photos", new ArrayList());
  populateFileList("Knapped_Glass_Artefact/Supplementary/External_camera_image_attachment", new ArrayList());
  executeOnEvent(tabgroup, "copy");

  saveCallback = new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);

      fetchAll(getDuplicateRelnQuery(uuidOld), new FetchCallback(){
        onFetch(result) {
          Log.e("Module", result.toString());

          if (result != null && result.size() >= 1) {
            parentTabgroup__ = result.get(0).get(4);
            parentTabgroup__ = parentTabgroup__.replaceAll(" ", "_");
          }

          makeDuplicateRelationships(result, getUuid(tabgroup));

          showToast("{Duplicated_record}");
          dialog.dismiss();
        }
      });

      saveTabGroup(tabgroup);
    }
  };

  String extraDupeAttributes = "";
  fetchAll(getDuplicateAttributeQuery(uuidOld, extraDupeAttributes), new FetchCallback(){
    onFetch(result) {
      excludeAttributes = new ArrayList();

      excludeAttributes.add("Device photos");
      excludeAttributes.add("External camera image attachment");

      duplicateTabGroup(tabgroup, null, getExtraAttributes(result), excludeAttributes, saveCallback);
    }
  });
}
void duplicateMetalArtefact(){
  String tabgroup = "Metal_Artefact";
  String uuidOld = getUuid(tabgroup);
  setUuid(tabgroup, "");
  disableAutoSave(tabgroup);
  incAutoNum("Metal_Artefact/General/Metal_Artefact_ID");
  clearGpsInTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  populateCameraPictureGallery("Metal_Artefact/General/Device_photos", new ArrayList());
  populateFileList("Metal_Artefact/Supplementary/External_camera_image_attachment", new ArrayList());
  executeOnEvent(tabgroup, "copy");

  saveCallback = new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);

      fetchAll(getDuplicateRelnQuery(uuidOld), new FetchCallback(){
        onFetch(result) {
          Log.e("Module", result.toString());

          if (result != null && result.size() >= 1) {
            parentTabgroup__ = result.get(0).get(4);
            parentTabgroup__ = parentTabgroup__.replaceAll(" ", "_");
          }

          makeDuplicateRelationships(result, getUuid(tabgroup));

          showToast("{Duplicated_record}");
          dialog.dismiss();
        }
      });

      saveTabGroup(tabgroup);
    }
  };

  String extraDupeAttributes = "";
  fetchAll(getDuplicateAttributeQuery(uuidOld, extraDupeAttributes), new FetchCallback(){
    onFetch(result) {
      excludeAttributes = new ArrayList();

      excludeAttributes.add("Device photos");
      excludeAttributes.add("External camera image attachment");

      duplicateTabGroup(tabgroup, null, getExtraAttributes(result), excludeAttributes, saveCallback);
    }
  });
}
void duplicateWeaponsandAmmunition(){
  String tabgroup = "Weapons_and_Ammunition";
  String uuidOld = getUuid(tabgroup);
  setUuid(tabgroup, "");
  disableAutoSave(tabgroup);
  incAutoNum("Weapons_and_Ammunition/General/Weapons_and_Ammunition_ID");
  clearGpsInTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  populateCameraPictureGallery("Weapons_and_Ammunition/General/Device_photos", new ArrayList());
  populateFileList("Weapons_and_Ammunition/Supplementary/External_camera_image_attachment", new ArrayList());
  executeOnEvent(tabgroup, "copy");

  saveCallback = new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);

      fetchAll(getDuplicateRelnQuery(uuidOld), new FetchCallback(){
        onFetch(result) {
          Log.e("Module", result.toString());

          if (result != null && result.size() >= 1) {
            parentTabgroup__ = result.get(0).get(4);
            parentTabgroup__ = parentTabgroup__.replaceAll(" ", "_");
          }

          makeDuplicateRelationships(result, getUuid(tabgroup));

          showToast("{Duplicated_record}");
          dialog.dismiss();
        }
      });

      saveTabGroup(tabgroup);
    }
  };

  String extraDupeAttributes = "";
  fetchAll(getDuplicateAttributeQuery(uuidOld, extraDupeAttributes), new FetchCallback(){
    onFetch(result) {
      excludeAttributes = new ArrayList();

      excludeAttributes.add("Device photos");
      excludeAttributes.add("External camera image attachment");

      duplicateTabGroup(tabgroup, null, getExtraAttributes(result), excludeAttributes, saveCallback);
    }
  });
}
addOnEvent("Flaked_Stone_Artefact", "save", "populateEntityListsOfArchEnt(\"Flaked_Stone_Artefact\")");
addOnEvent("Other_Stone_Artefact", "save", "populateEntityListsOfArchEnt(\"Other_Stone_Artefact\")");
addOnEvent("Glass_Artefact", "save", "populateEntityListsOfArchEnt(\"Glass_Artefact\")");
addOnEvent("Ceramic_Artefact", "save", "populateEntityListsOfArchEnt(\"Ceramic_Artefact\")");
addOnEvent("Misc_Artefact", "save", "populateEntityListsOfArchEnt(\"Misc_Artefact\")");
addOnEvent("Discrete_Hearth_Artefact", "save", "populateEntityListsOfArchEnt(\"Discrete_Hearth_Artefact\")");
addOnEvent("Buttons", "save", "populateEntityListsOfArchEnt(\"Buttons\")");
addOnEvent("Knapped_Glass_Artefact", "save", "populateEntityListsOfArchEnt(\"Knapped_Glass_Artefact\")");
addOnEvent("Metal_Artefact", "save", "populateEntityListsOfArchEnt(\"Metal_Artefact\")");
addOnEvent("Weapons_and_Ammunition", "save", "populateEntityListsOfArchEnt(\"Weapons_and_Ammunition\")");

void doNotDelete(){
  showToast("{Delete_Cancelled}");
}

addOnEvent("User_List", "show", "removeNavigationButtons()");
addOnEvent("Control", "show", "removeNavigationButtons()");
addOnEvent("Flaked_Stone_Artefact", "show", "removeNavigationButtons()");
addOnEvent("Other_Stone_Artefact", "show", "removeNavigationButtons()");
addOnEvent("Glass_Artefact", "show", "removeNavigationButtons()");
addOnEvent("Ceramic_Artefact", "show", "removeNavigationButtons()");
addOnEvent("Misc_Artefact", "show", "removeNavigationButtons()");
addOnEvent("Discrete_Hearth_Artefact", "show", "removeNavigationButtons()");
addOnEvent("Buttons", "show", "removeNavigationButtons()");
addOnEvent("Knapped_Glass_Artefact", "show", "removeNavigationButtons()");
addOnEvent("Metal_Artefact", "show", "removeNavigationButtons()");
addOnEvent("Weapons_and_Ammunition", "show", "removeNavigationButtons()");
addOnEvent("Flaked_Stone_Artefact", "show", "addNavigationButtons(\"Flaked_Stone_Artefact\")");
addOnEvent("Other_Stone_Artefact", "show", "addNavigationButtons(\"Other_Stone_Artefact\")");
addOnEvent("Glass_Artefact", "show", "addNavigationButtons(\"Glass_Artefact\")");
addOnEvent("Ceramic_Artefact", "show", "addNavigationButtons(\"Ceramic_Artefact\")");
addOnEvent("Misc_Artefact", "show", "addNavigationButtons(\"Misc_Artefact\")");
addOnEvent("Discrete_Hearth_Artefact", "show", "addNavigationButtons(\"Discrete_Hearth_Artefact\")");
addOnEvent("Buttons", "show", "addNavigationButtons(\"Buttons\")");
addOnEvent("Knapped_Glass_Artefact", "show", "addNavigationButtons(\"Knapped_Glass_Artefact\")");
addOnEvent("Metal_Artefact", "show", "addNavigationButtons(\"Metal_Artefact\")");
addOnEvent("Weapons_and_Ammunition", "show", "addNavigationButtons(\"Weapons_and_Ammunition\")");

/******************************************************************************/
/*                                   SEARCH                                   */
/******************************************************************************/
addOnEvent("Control/Search"               , "show"  , "search()");
addOnEvent("Control/Search/Entity_List"   , "click" , "loadEntity();");
addOnEvent("Control/Search/Search_Button" , "click" , "search()");
addOnEvent("Control/Search/Search_Term"   , "click" , "clearSearch()");

addOnEvent("Control/Search/Entity_Types"  , "click" , "search()");
entityTypes = new ArrayList();
entityTypes.add(new NameValuePair("{All}", ""));
entityTypes.add(new NameValuePair("{Buttons}", "Buttons"));
entityTypes.add(new NameValuePair("{Ceramic_Artefact}", "Ceramic Artefact"));
entityTypes.add(new NameValuePair("{Discrete_Hearth_Artefact}", "Discrete Hearth Artefact"));
entityTypes.add(new NameValuePair("{Flaked_Stone_Artefact}", "Flaked Stone Artefact"));
entityTypes.add(new NameValuePair("{Glass_Artefact}", "Glass Artefact"));
entityTypes.add(new NameValuePair("{Knapped_Glass_Artefact}", "Knapped Glass Artefact"));
entityTypes.add(new NameValuePair("{Metal_Artefact}", "Metal Artefact"));
entityTypes.add(new NameValuePair("{Misc_Artefact}", "Misc Artefact"));
entityTypes.add(new NameValuePair("{Other_Stone_Artefact}", "Other Stone Artefact"));
entityTypes.add(new NameValuePair("{Weapons_and_Ammunition}", "Weapons and Ammunition"));
populateDropDown("Control/Search/Entity_Types", entityTypes);

void clearSearch(){
  setFieldValue("Control/Search/Search_Term","");
}

void search(){
  String refEntityList  = "Control/Search/Entity_List";
  String refSearchTerm  = "Control/Search/Search_Term";
  String refEntityTypes = "Control/Search/Entity_Types";

  String type = getFieldValue(refEntityTypes);
  String term = getFieldValue(refSearchTerm);
  String searchQuery = "SELECT uuid, response "+
                       "  FROM latestNonDeletedArchEntFormattedIdentifiers  "+
                       " WHERE uuid in (SELECT uuid "+
                       "                  FROM latestNonDeletedArchEntIdentifiers "+
                       "                 WHERE measure LIKE {term}||'%'  "+
                       "                   AND ( aenttypename = {type} OR '' = {type} ) "+
                       "                )  "+
                       " ORDER BY substr(uuid, 7, 13) desc, response " +
                       " LIMIT ? "+
                       "OFFSET ? ";
  searchQuery = dbReplaceFirst(searchQuery, "{term}", term);
  searchQuery = dbReplaceFirst(searchQuery, "{type}", type);
  searchQuery = dbReplaceFirst(searchQuery, "{type}", type);

  populateMenu(refEntityList, MSG_LOADING);
  populateCursorList(refEntityList, searchQuery, 25);
  refreshTabgroupCSS("Control");

  Log.d("Module", "Search query: " + searchQuery);
}

void loadFlakedStoneArtefactFrom(String uuid) {
  String tabgroup = "Flaked_Stone_Artefact";
  setUuid(tabgroup, uuid);
  if (isNull(uuid)) return;

  FetchCallback cb = new FetchCallback() {
    onFetch(result) {
      populateEntityListsInTabGroup(tabgroup);
      executeOnEvent(tabgroup, "fetch");
    }
  };

  executeOnEvent(tabgroup, "prefetch");
  showTabGroup(tabgroup, uuid, cb);
}
void loadOtherStoneArtefactFrom(String uuid) {
  String tabgroup = "Other_Stone_Artefact";
  setUuid(tabgroup, uuid);
  if (isNull(uuid)) return;

  FetchCallback cb = new FetchCallback() {
    onFetch(result) {
      populateEntityListsInTabGroup(tabgroup);
      executeOnEvent(tabgroup, "fetch");
    }
  };

  executeOnEvent(tabgroup, "prefetch");
  showTabGroup(tabgroup, uuid, cb);
}
void loadGlassArtefactFrom(String uuid) {
  String tabgroup = "Glass_Artefact";
  setUuid(tabgroup, uuid);
  if (isNull(uuid)) return;

  FetchCallback cb = new FetchCallback() {
    onFetch(result) {
      populateEntityListsInTabGroup(tabgroup);
      executeOnEvent(tabgroup, "fetch");
    }
  };

  executeOnEvent(tabgroup, "prefetch");
  showTabGroup(tabgroup, uuid, cb);
}
void loadCeramicArtefactFrom(String uuid) {
  String tabgroup = "Ceramic_Artefact";
  setUuid(tabgroup, uuid);
  if (isNull(uuid)) return;

  FetchCallback cb = new FetchCallback() {
    onFetch(result) {
      populateEntityListsInTabGroup(tabgroup);
      executeOnEvent(tabgroup, "fetch");
    }
  };

  executeOnEvent(tabgroup, "prefetch");
  showTabGroup(tabgroup, uuid, cb);
}
void loadMiscArtefactFrom(String uuid) {
  String tabgroup = "Misc_Artefact";
  setUuid(tabgroup, uuid);
  if (isNull(uuid)) return;

  FetchCallback cb = new FetchCallback() {
    onFetch(result) {
      populateEntityListsInTabGroup(tabgroup);
      executeOnEvent(tabgroup, "fetch");
    }
  };

  executeOnEvent(tabgroup, "prefetch");
  showTabGroup(tabgroup, uuid, cb);
}
void loadDiscreteHearthArtefactFrom(String uuid) {
  String tabgroup = "Discrete_Hearth_Artefact";
  setUuid(tabgroup, uuid);
  if (isNull(uuid)) return;

  FetchCallback cb = new FetchCallback() {
    onFetch(result) {
      populateEntityListsInTabGroup(tabgroup);
      executeOnEvent(tabgroup, "fetch");
    }
  };

  executeOnEvent(tabgroup, "prefetch");
  showTabGroup(tabgroup, uuid, cb);
}
void loadButtonsFrom(String uuid) {
  String tabgroup = "Buttons";
  setUuid(tabgroup, uuid);
  if (isNull(uuid)) return;

  FetchCallback cb = new FetchCallback() {
    onFetch(result) {
      populateEntityListsInTabGroup(tabgroup);
      executeOnEvent(tabgroup, "fetch");
    }
  };

  executeOnEvent(tabgroup, "prefetch");
  showTabGroup(tabgroup, uuid, cb);
}
void loadKnappedGlassArtefactFrom(String uuid) {
  String tabgroup = "Knapped_Glass_Artefact";
  setUuid(tabgroup, uuid);
  if (isNull(uuid)) return;

  FetchCallback cb = new FetchCallback() {
    onFetch(result) {
      populateEntityListsInTabGroup(tabgroup);
      executeOnEvent(tabgroup, "fetch");
    }
  };

  executeOnEvent(tabgroup, "prefetch");
  showTabGroup(tabgroup, uuid, cb);
}
void loadMetalArtefactFrom(String uuid) {
  String tabgroup = "Metal_Artefact";
  setUuid(tabgroup, uuid);
  if (isNull(uuid)) return;

  FetchCallback cb = new FetchCallback() {
    onFetch(result) {
      populateEntityListsInTabGroup(tabgroup);
      executeOnEvent(tabgroup, "fetch");
    }
  };

  executeOnEvent(tabgroup, "prefetch");
  showTabGroup(tabgroup, uuid, cb);
}
void loadWeaponsandAmmunitionFrom(String uuid) {
  String tabgroup = "Weapons_and_Ammunition";
  setUuid(tabgroup, uuid);
  if (isNull(uuid)) return;

  FetchCallback cb = new FetchCallback() {
    onFetch(result) {
      populateEntityListsInTabGroup(tabgroup);
      executeOnEvent(tabgroup, "fetch");
    }
  };

  executeOnEvent(tabgroup, "prefetch");
  showTabGroup(tabgroup, uuid, cb);
}

/******************************************************************************/
/*                          TAKE FROM GPS BUTTON(S)                           */
/******************************************************************************/
addOnEvent("Flaked_Stone_Artefact/General/Take_From_GPS_1", "click", "takePoint(\"Flaked_Stone_Artefact\")");
addOnEvent("Other_Stone_Artefact/General/Take_From_GPS_1", "click", "takePoint(\"Other_Stone_Artefact\")");
addOnEvent("Glass_Artefact/General/Take_From_GPS_1", "click", "takePoint(\"Glass_Artefact\")");
addOnEvent("Ceramic_Artefact/General/Take_From_GPS_1", "click", "takePoint(\"Ceramic_Artefact\")");
addOnEvent("Misc_Artefact/General/Take_From_GPS_1", "click", "takePoint(\"Misc_Artefact\")");
addOnEvent("Discrete_Hearth_Artefact/General/Take_From_GPS_1", "click", "takePoint(\"Discrete_Hearth_Artefact\")");
addOnEvent("Buttons/General/Take_From_GPS_1", "click", "takePoint(\"Buttons\")");
addOnEvent("Knapped_Glass_Artefact/General/Take_From_GPS_1", "click", "takePoint(\"Knapped_Glass_Artefact\")");
addOnEvent("Metal_Artefact/General/Take_From_GPS_1", "click", "takePoint(\"Metal_Artefact\")");
addOnEvent("Weapons_and_Ammunition/General/Take_From_GPS_1", "click", "takePoint(\"Weapons_and_Ammunition\")");

Map getTakeFromGpsMappings() {
  Map tabgroupToTabRef = new HashMap();
  tabgroupToTabRef.put("Flaked_Stone_Artefact", "Flaked_Stone_Artefact/General");
  tabgroupToTabRef.put("Other_Stone_Artefact", "Other_Stone_Artefact/General");
  tabgroupToTabRef.put("Glass_Artefact", "Glass_Artefact/General");
  tabgroupToTabRef.put("Ceramic_Artefact", "Ceramic_Artefact/General");
  tabgroupToTabRef.put("Misc_Artefact", "Misc_Artefact/General");
  tabgroupToTabRef.put("Discrete_Hearth_Artefact", "Discrete_Hearth_Artefact/General");
  tabgroupToTabRef.put("Buttons", "Buttons/General");
  tabgroupToTabRef.put("Knapped_Glass_Artefact", "Knapped_Glass_Artefact/General");
  tabgroupToTabRef.put("Metal_Artefact", "Metal_Artefact/General");
  tabgroupToTabRef.put("Weapons_and_Ammunition", "Weapons_and_Ammunition/General");
  return tabgroupToTabRef;
}

/* Takes the current point using gps. */
void takePoint(String tabgroup) {
  triggerAutoSave();
  Map tabgroupToTabRef = getTakeFromGpsMappings();

  String archEntType = getArchEntType(tabgroup);
  String currentUuid = getUuid(tabgroup);

  boolean isInternalGPSOff = !isInternalGPSOn();
  boolean isExternalGPSOff = !isExternalGPSOn();
  Object  position = getGPSPosition();
  if (position == null || isInternalGPSOff && isExternalGPSOff) {
    showToast("{GPS_Not_Initialised}");
    return;
  }

  Object projPosition = getGPSPositionProjected();
  Double latitude     = position.getLatitude();
  Double longitude    = position.getLongitude();
  Double northing     = projPosition.getLatitude();
  Double easting      = projPosition.getLongitude();

  String sLatitude    = "" + latitude;
  String sLongitude   = "" + longitude;
  String sNorthing    = "" + northing;
  String sEasting     = "" + easting;

  MapPos mapPos = new MapPos(easting, northing);
  Point samplePoint = new Point(mapPos, null, (PointStyle) null, null);
  ArrayList geolist = new ArrayList();
  geolist.add(samplePoint);

  String accuracy = "" + getGPSEstimatedAccuracy();
  setFieldValue(tabgroupToTabRef.get(tabgroup) + "/Accuracy",  accuracy);
  setFieldValue(tabgroupToTabRef.get(tabgroup) + "/Longitude", sLongitude);
  setFieldValue(tabgroupToTabRef.get(tabgroup) + "/Latitude",  sLatitude);
  setFieldValue(tabgroupToTabRef.get(tabgroup) + "/Easting",   sEasting);
  setFieldValue(tabgroupToTabRef.get(tabgroup) + "/Northing",  sNorthing);

  List attribs = createAttributeList();
  attribs.add(createEntityAttribute("Accuracy",  "", "", accuracy,   "1.0"));
  attribs.add(createEntityAttribute("Longitude", "", "", sLongitude,  "1.0"));
  attribs.add(createEntityAttribute("Latitude",  "", "", sLatitude, "1.0"));
  attribs.add(createEntityAttribute("Northing",  "", "", sNorthing,  "1.0"));
  attribs.add(createEntityAttribute("Easting",   "", "", sEasting,   "1.0"));

  String showToast = fun2str(
      "showToast",
      getArch16nKey(tabgroup) + " {toast_saved}"
  );
  SaveCallback saveCallback = getDefaultSaveCallback(tabgroup, showToast);
  saveArchEnt(currentUuid, archEntType, geolist, attribs, saveCallback);
}

/* Sets the value of GPS views for the given tab ref. */
void fillInGPS(String tabgroup) {
  Map tabgroupToTabRef = getTakeFromGpsMappings();
  String currentUuid = getUuid(tabgroup);
  if (isNull(currentUuid)) {
    return;
  }

  String query = "SELECT x(transform(geospatialcolumn,                4326)) as longtiude, " +
                 "       y(transform(geospatialcolumn,                4326)) as latitude, " +
                 "       x(transform(geospatialcolumn, "+getModuleSrid()+")) as easting, " +
                 "       y(transform(geospatialcolumn, "+getModuleSrid()+")) as northing " +
                 "  FROM latestnondeletedarchent " +
                 " WHERE uuid = '" + currentUuid + "';";

  fetchOne(query, new FetchCallback() {
    onFetch(result) {
      print("[fillInGPS()] Fetched DB transformed geometry: " + result);
      setFieldValue(tabgroupToTabRef.get(tabgroup) + "/Longitude" , result.get(0));
      setFieldValue(tabgroupToTabRef.get(tabgroup) + "/Latitude"  , result.get(1));
      setFieldValue(tabgroupToTabRef.get(tabgroup) + "/Easting"   , result.get(2));
      setFieldValue(tabgroupToTabRef.get(tabgroup) + "/Northing"  , result.get(3));
    }
  });
}

void clearGpsInTabGroup(String tabgroup) {
  Map tabgroupToTabRef = getTakeFromGpsMappings();

  String tabRef = tabgroupToTabRef.get(tabgroup);
  if (isNull(tabRef)) return;

  clearGpsInTab(tabRef);
}

void clearGpsInTab(String tabRef) {
  setFieldValue(tabRef + "/Accuracy"  , "");
  setFieldValue(tabRef + "/Latitude"  , "");
  setFieldValue(tabRef + "/Longitude" , "");
  setFieldValue(tabRef + "/Easting"   , "");
  setFieldValue(tabRef + "/Northing"  , "");
}

/******************************************************************************/
/*               LOADING AND CREATION OF RECORDS FROM QR CODES                */
/******************************************************************************/
import java.util.regex.Pattern;
import java.util.regex.Matcher;

void bindQrScanning(String refButton) {
  addOnEvent(refButton, "click", "scanEntityFromQrCode()");
}

void scanEntityFromQrCode() {
  scanCode("loadEntityFromScannedQrCode()");
}

void loadEntityFromScannedQrCode() {
  String code = getLastScanContents();

  String  uuidString  = "";
  Pattern uuidPattern = Pattern.compile("(\\d{19})");
  Matcher matcher     = uuidPattern.matcher(code);
  while (matcher.find())
    uuidString = matcher.group(1);

  if (isNull(uuidString)) {
    showWarning("{load_scanned_err_head}", "{load_scanned_err_body}");
    return;
  }

  loadEntityFrom(uuidString);
}



/******************************************************************************/
/*                       AUTONUMBERING HELPER FUNCTIONS                       */
/******************************************************************************/
Map AUTONUM_DEST_TO_SOURCE = new HashMap();
AUTONUM_DEST_TO_SOURCE.put("Flaked_Stone_Artefact/General/Flaked_Stone_Artefact_ID", "Control/Autonumbering/Next_Flaked_Stone_Artefact_ID");
AUTONUM_DEST_TO_SOURCE.put("Other_Stone_Artefact/General/Other_Stone_Artefact_ID", "Control/Autonumbering/Next_Other_Stone_Artefact_ID");
AUTONUM_DEST_TO_SOURCE.put("Glass_Artefact/General/Glass_Artefact_ID", "Control/Autonumbering/Next_Glass_Artefact_ID");
AUTONUM_DEST_TO_SOURCE.put("Ceramic_Artefact/General/Ceramic_Artefact_ID", "Control/Autonumbering/Next_Ceramic_Artefact_ID");
AUTONUM_DEST_TO_SOURCE.put("Misc_Artefact/General/Misc_Artefact_ID", "Control/Autonumbering/Next_Misc_Artefact_ID");
AUTONUM_DEST_TO_SOURCE.put("Discrete_Hearth_Artefact/General/Discrete_Hearth_Artefact_ID", "Control/Autonumbering/Next_Discrete_Hearth_Artefact_ID");
AUTONUM_DEST_TO_SOURCE.put("Buttons/General/Buttons_ID", "Control/Autonumbering/Next_Buttons_ID");
AUTONUM_DEST_TO_SOURCE.put("Knapped_Glass_Artefact/General/Knapped_Glass_Artefact_ID", "Control/Autonumbering/Next_Knapped_Glass_Artefact_ID");
AUTONUM_DEST_TO_SOURCE.put("Metal_Artefact/General/Metal_Artefact_ID", "Control/Autonumbering/Next_Metal_Artefact_ID");
AUTONUM_DEST_TO_SOURCE.put("Weapons_and_Ammunition/General/Weapons_and_Ammunition_ID", "Control/Autonumbering/Next_Weapons_and_Ammunition_ID");

/*
 * If value of field specified by `ref` is null, sets the field to `defaultVal`,
 * otherwise increments its value.
 *
 * Returns the value the field was updated to.
 */
Integer incField(String ref, Integer defaultVal) {
  String val = getFieldValue(ref);

  if (isNull(val)) {
    setFieldValue(ref, defaultVal);
    return defaultVal;
  }

  Integer inc = null;
  try {
    inc = Integer.parseInt(val) + 1;
  } catch (Exception e) { ; }

  if (inc == null) {
    try {
      Double dinc = Double.parseDouble(val) + 1;
      inc = Math.round(dinc);

      String head, body;
      head  = "{inc_field_head}";
      body  = "{inc_field_body_1}" + getArch16nKey(ref) + "{inc_field_body_2}";

      showWarning(head, body);
    } catch (Exception e) {
      Log.d("incField", "" + e);
      ;
    }
  }

  if (inc == null) {
    String head, body;
    head  = "{inc_field_head}";
    body  = "{inc_field_body_1}" + getArch16nKey(ref) + "{inc_field_body_3}";

    showWarning(head, body);
  }

  if (inc != null) {
    setFieldValue(ref, inc);
    insertIntoLocalSettings(ref, inc.toString());
  }

  return inc;
}

/* Increments the field at `ref` or returns null if it does not contain a
 * number.
 */
Integer incField(String ref) {
  return incField(ref, 1);
}

for (String ref : getStartingIdRefs())
  persistOverSessions(ref, "1");

void incAutoNum(String destPath) {
  String sourcePath = AUTONUM_DEST_TO_SOURCE.get(destPath);
  String destVal    = getFieldValue(sourcePath);
  setFieldValue(destPath, destVal);
  incField(sourcePath);
}
/******************************************************************************/
/*                         POPULATION VIA <MARKDOWN>                          */
/******************************************************************************/
populateWebViewHtml("Glass_Artefact/Feature_details/Grouped_fragments_only", "<h2 id=\"grouped-fragments-only\">Grouped Fragments Only</h2>\n");
populateWebViewHtml("Ceramic_Artefact/Feature_details/Grouped_fragments_only", "<h2 id=\"grouped-fragments-only\">Grouped Fragments Only</h2>\n");
populateWebViewHtml("Knapped_Glass_Artefact/Feature_details/Webview_glass_core_details", "<h2 id=\"glass-core-details-complete-only-for-cores\">Glass Core details (complete only for cores)</h2>\n");
populateWebViewHtml("Knapped_Glass_Artefact/Feature_details/Webview_flake_details", "<h2 id=\"flake-details-complete-only-for-flakes\">Flake details (complete only for flakes)</h2>\n");
populateWebViewHtml("Metal_Artefact/Feature_details/Nails_or_structural_fasteners_only", "<h2 id=\"nails-or-structural-fasteners-only\">Nails or structural fasteners only</h2>\n");
populateWebViewHtml("Metal_Artefact/Feature_details/Buckles_only", "<h1 id=\"buckles-only\">Buckles only</h1>\n");
populateWebViewHtml("Weapons_and_Ammunition/Feature_details/Projectile_details", "<h2 id=\"projectile-details\">Projectile details</h2>\n");
populateWebViewHtml("Weapons_and_Ammunition/Feature_details/Cartridge_details", "<h2 id=\"cartridge-details\">Cartridge details</h2>\n");

/******************************************************************************/
/*                POPULATION OF ENTITY AND CHILD ENTITY LISTS                 */
/******************************************************************************/
/*
 * `ref`       the reference of the GUI element to be populated.
 * `parentUuid` the parent in the relationship denoted by `relType`.
 * `entType`    the type of the entities the menu will be populated with.
 * `relType`    the name of the relationship the children are to be in with the
 *              entity denoted by `parentUuid`.
 */
void populateMenuWithEntities (
  String ref,
  String parentUuid,
  String entType,
  String relType
) {
  String viewType = getType(ref);

  String limit;
  switch (viewType) {
    case "dropdown": limit = "";                   break;
    case "list":     limit = " LIMIT ? OFFSET ? "; break;
  }

  String getChildEntitiesQ = "" +
    "SELECT childuuid, response " +
    "  FROM (select childuuid, createdat" +
    "          from (select childuuid, createdat, relationshipid" +
    "                    from parentchild" +
    "                   where parentuuid = '" + parentUuid + "' " +
    "                   and (childaenttypename = '"+entType+"')" +
    "                   order by createdat           " +
    "                   )" +
    "          JOIN (SELECT relationshipid   " +
    "                  FROM latestnondeletedrelationship JOIN relntype USING (relntypeid)  " +
    "                 WHERE relntypename = '"+relType+"') USING (relationshipid)" +
    "          order by createdat desc" +
    limit +
    "        )  " +
    "  JOIN latestNonDeletedArchEntFormattedIdentifiers ON (childuuid = uuid)   " +
    "  order by createdat desc, response";

  String getEntitiesQ = "" +
    "SELECT uuid, response "+
    "  FROM latestNonDeletedArchEntFormattedIdentifiers  "+
    " WHERE uuid in (SELECT uuid "+
    "                  FROM latestNonDeletedArchEntIdentifiers "+
    "                 WHERE aenttypename = '"+entType+"' OR '"+entType+"' = '' " +
    "               )  "+
    " ORDER BY substr(uuid, 7, 13) desc, response " +
    limit;

  FetchCallback cbPopulateDropDown = new FetchCallback() {
    onFetch(result) {
      populateDropDown(ref, result, true);
    }
  };

  String q;
  if (relType.equals("")) q = getEntitiesQ;
  else                    q = getChildEntitiesQ;

  switch (viewType) {
    case "dropdown": fetchAll(q, cbPopulateDropDown); break;
    case "list":     populateCursorList(ref, q, 25); break;
  }
}

void populateEntityListsInTabGroup(String tabGroup) {
  if (isNull(tabGroup)) {
    return;
  }

  for (m : ENTITY_MENUS) {
    String ref          = m[0];
    String menuTabGroup = getTabGroupRef(ref);
    String functionCall = getEntityMenuPopulationFunction(m);

    if (menuTabGroup.equals(tabGroup))
      execute(functionCall);
  }
}

/* Populates each list containing records whose archent type is the same as that
 * of `tabGroup`.
 */
void populateEntityListsOfArchEnt(String tabGroup) {
  if (isNull(tabGroup)) {
    return;
  }

  String archEntTypeToPopulate = getArchEntType(tabGroup);

  for (m : ENTITY_MENUS) {
    String archEntType  = m[2];
    String functionCall = getEntityMenuPopulationFunction(m);

    if (archEntType.equals(archEntTypeToPopulate))
      execute(functionCall);
  }
}

String getEntityMenuPopulationFunction(String[] menuDescriptor) {
  String ref            = menuDescriptor[0];
  String parentUuidCall = menuDescriptor[1];
  String entType        = menuDescriptor[2];
  String relType        = menuDescriptor[3];

  String functionCall = "";
  functionCall += "populateMenuWithEntities(";
  functionCall += "\"" + ref            + "\"";
  functionCall += ", ";
  functionCall +=        parentUuidCall       ;
  functionCall += ", ";
  functionCall += "\"" + entType        + "\"";
  functionCall += ", ";
  functionCall += "\"" + relType        + "\"";
  functionCall += ")";

  return functionCall;
}

ENTITY_MENUS = new ArrayList();

for (m : ENTITY_MENUS) {
  String functionCall = getEntityMenuPopulationFunction(m);
  execute(functionCall);
}
for (m : ENTITY_MENUS) {
  String menuRef = m[0];

  String ref = getTabRef(menuRef);
  String evt = "show";
  String cmd = "clearField(\"{menuRef}\")";
  cmd = replaceFirst(cmd, "{menuRef}", menuRef);

  addOnEvent(ref, evt, cmd);
}


/******************************************************************************/
/*                             HANDWRITTEN LOGIC                              */
/******************************************************************************/

/**** Change sync default ***/

setSyncEnabled(true);
startInternalGPS();
/************************************ MAP *************************************/

final List REFS_FIND_THIS_IN_THE_MAP =
  getRefsMatching("*/Find_This_in_The_Map");

void initMap() {

  setMapZoom(MAP_REF, 15.0f);
  // Shape
  // isEntity = true;
  showBaseMap(MAP_REF, "Base Raster Map", "files/data/maps/Basemap.3857.tif");

  
}


void centreMe() {
  String mapRef = "Control/Map/Map";
  if(!isExternalGPSOn() && !isInternalGPSOn()) {
    showToast("{GPS_Not_Initialised}");
  } else {
    centerOnCurrentPosition(mapRef);
  }
}
void refreshMap() {
  String mapRef = "Control/Map/Map";
  refreshMap(mapRef);
}

initMap();
addOnEvent("Control/Map",           "show",  "refreshMap()");



// DATA_ENTRY_LAYER    = "Data Entry Layer";
// DATA_ENTRY_LAYER_ID = createCanvasLayer(MAP_REF, DATA_ENTRY_LAYER);

// DATA_ENTRY_IDS.put(MAP_REF, DATA_ENTRY_LAYER_ID);

// setSelectedLayer(MAP_REF, DATA_ENTRY_LAYER);
setMapZoom(MAP_REF, 15.0f);

void refreshMap() {
  refreshMap(MAP_REF);
}

// showDatabaseLayers(MAP_REF);
addOnEvent(getTabRef(MAP_REF), "show",  "refreshMap()");

void addDatabaseLayer(String layerName, String tableName, String hexColourCode){
  int transBlk = Color.parseColor("#AA000000");
  int hexColour = Color.parseColor(hexColourCode);
  //int hexColour = Color.BLACK;
  GeometryStyle sln_ = createLineStyle(10, transBlk, 0.01f, 0.3f, null);
  String q;

  q  = "SELECT uuid, aenttimestamp";
  q += "  FROM latestNonDeletedArchEnt";
  q += "  JOIN aenttype USING (aenttypeid)";
  q += " WHERE aenttypename = {aenttypename}";  
  q  = dbReplaceFirst(q, "{aenttypename}", tableName);
  Log.w("databaselayer",q);
  boolean isEntity = true;
  GeometryStyle spt = createPointStyle(5, hexColour, 0.5f, 2f);
  GeometryStyle sln = createLineStyle(5, hexColour, 0.05f, 0.3f, null);
  GeometryStyle spg = createPolygonStyle(5, hexColour, sln_);
  GeometryTextStyle stx = createTextStyle(
      10,
      Color.BLACK,
      40,
      Typeface.SANS_SERIF
  );
  showDatabaseLayer(
      MAP_REF,
      layerName,
      isEntity,
      layerName,
      q,
      spt,
      sln,
      spg,
      stx
  );
}


void addBoundaryDatabaseLayer(String layerName, String tableName, String hexColourCode){
  int transBlk = Color.parseColor("#AA000000");
  int hexColour = Color.parseColor(hexColourCode);
  GeometryStyle sln_ = createLineStyle(5, transBlk, 0.01f, 0.1f, null);
  String q;

  q  = "SELECT uuid, aenttimestamp";
  q += "  FROM latestNonDeletedArchEnt";
  q += "  JOIN aenttype USING (aenttypeid)";
  q += "  JOIN parentchild ON (uuid = childuuid)";
  q += " WHERE aenttypename = {aenttypename}";  //remember the db replace auto-quotes
  q  = dbReplaceFirst(q, "{aenttypename}",  tableName);
  Log.w("boundary", q);
  boolean isEntity = true;
  GeometryStyle spt = createPointStyle(10, hexColour, 0.1f, 1f);
  GeometryStyle sln = createLineStyle(10, hexColour, 0.05f, 0.3f, null);
  GeometryStyle spg = createPolygonStyle(10, hexColour, sln_);
  GeometryTextStyle stx = createTextStyle(
      10,
      Color.BLACK,
      40,
      Typeface.SANS_SERIF
  );
  showDatabaseLayer(
      MAP_REF,
      layerName,
      isEntity,
      layerName,
      q,
      spt,
      sln,
      spg,
      stx
  );
}

//To enable or disable the tools bar and layers bar use the following
//
setToolsEnabled(MAP_REF, true);

// The create point, line and polygon tools trigger the tool create event when a geometry is created 
// and the Load tool triggers a tool load event when a geometry is selected. 
// Use the following to bind callback to those events.

onToolEvent(MAP_REF, "load", "onLoad()");

onLoad() {
    id = getMapGeometryLoaded(); // uuid or relationshipid of the vector element
    type = getMapGeometryLoadedType(); // either "entity" or "relationship"    
    showToast("Loading: "+id);
    loadEntityFrom(id);
}
  
// onMapEvent(MAP_REF, "clickCallback()", "selectCallback()");
// addDatabaseLayer("Surface Exposure", "Surface Exposure", "#980000");
// addBoundaryDatabaseLayer("Surface Exposure Boundary Point", "Surface Exposure Boundary point", "#980000");
// addDatabaseLayer("Mound", "Mound", "#4a86e8");
// addBoundaryDatabaseLayer("Mound Boundary Point", "Mound Boundary point", "#4a86e8"); //lowercase P is critical. 
// addDatabaseLayer("Rock Shelter", "Rock Shelter", "#b7b7b7");
// addBoundaryDatabaseLayer("Rock Shelter Boundary Point", "Rock Shelter Boundary point", "#b7b7b7"); //lowercase P is critical. 
// addDatabaseLayer("Historical Feature", "Historical Feature", "#ff9900");
// addBoundaryDatabaseLayer("Historical Feature Boundary Point", "Historical Feature Boundary point", "#ff9900"); //lowercase P is critical. 
// addDatabaseLayer("Burial", "Burial", "#ff0000");
// addBoundaryDatabaseLayer("Burial Boundary Point", "Burial Boundary point", "#ff0000"); //lowercase P is critical. 









final List COLOURS = new ArrayList();

COLOURS.add("#808A28");
COLOURS.add("#358A28");
COLOURS.add("#28868A");
COLOURS.add("#2F47A1");
COLOURS.add("#35B89A");
COLOURS.add("#8A4C28");
COLOURS.add("#8A2883");
COLOURS.add("#8A285E");
COLOURS.add("#8A283A");
COLOURS.add("#FE8C4A");

for (int i = 0; i < REFS_FIND_THIS_IN_THE_MAP.size(); i++) {
  addDatabaseLayer(
      getArchEntType(REFS_FIND_THIS_IN_THE_MAP.get(i)),
      getArchEntType(REFS_FIND_THIS_IN_THE_MAP.get(i)),
      COLOURS.get(i % COLOURS.size())
  );
}


clickCallback() {
  point = getMapPointClicked();
  
  Log.i("clickCallback", point.toString());
}
 
selectCallback() {
  geomId = getMapGeometrySelected();
  geom = getGeometry(MAP_REF, geomId);

  Log.i("selectCallback", " "+geom.toString());
  //clearGeometryHighlights(MAP_REF);
}
/****************************** GIS POINT STYLES ******************************/
//final String MAP_REF = "Control/Map/Map";
/* Displays the geometry of each entity whose menu, by the name of `attribName`,
 * has `vocabName` saved in it. The geometry is displayed in whatever colour is
 * given by `geoColor`.
 *
 * The geometry is displayed in a layer called `layerName`. This is a
 * human-readable name that the user can use to toggle the visibility of the
 * geometry in the UI.
 */
// void showDatabaseLayerByVocabName(
//     String attribName,
//     String vocabName,
//     int    geoColor, /* Example argument: Color.BLACK */
//     String layerName
// ) {
//   int transBlk = Color.parseColor("#AA000000");
//   GeometryStyle sln_ = createLineStyle(10, transBlk, 0.01f, 0.3f, null);
//   // Define arguments to `showDatabaseLayer`
//   String q;
//   q  = "SELECT uuid, aenttimestamp";
//   q += "  FROM latestNonDeletedArchEnt";
//   q += "  JOIN latestnondeletedaentvalue USING (uuid)";
//   q += "  JOIN attributekey              USING (attributeid)";
//   q += "  JOIN vocabulary                USING (vocabid)";
//   q += " WHERE {vocabName}  IN ('', vocabname)";
//   q += "   AND {attribName} IN ('', attributename)";
//   q  = dbReplaceFirst(q, "{vocabName}",  vocabName);
//   q  = dbReplaceFirst(q, "{attribName}", attribName);
//   boolean isEntity = true;
//   GeometryStyle spt = createPointStyle(10, geoColor, 0.2f, 0.5f);
//   GeometryStyle sln = createLineStyle(10, geoColor, 0.05f, 0.3f, null);
//   GeometryStyle spg = createPolygonStyle(10, geoColor, sln_);
//   GeometryTextStyle stx = createTextStyle(
//       10,
//       Color.BLACK,
//       40,
//       Typeface.SANS_SERIF
//   );
//   showDatabaseLayer(
//       MAP_REF,
//       layerName,
//       isEntity,
//       layerName,
//       q,
//       spt,
//       sln,
//       spg,
//       stx
//   );
// }
// void showDatabaseLayerByVocabName(
//     String vocabName,
//     int    geoColor,
//     String layerName
// ) {
//   showDatabaseLayerByVocabName("", vocabName, geoColor, layerName);
// }
// void showDatabaseLayerByVocabName(String vocabName, int geoColor) {
//   String layerName = guessArch16nValFromKey(vocabName);
//   showDatabaseLayerByVocabName(vocabName, geoColor, layerName);
// }
// void initMap() {
//   //showBaseMap(MAP_REF, "Base Map", "files/data/Map/K-35-066-3_Razdel.tif");
//   /*
//   showDatabaseLayerByVocabName("{1___pristine}",   Color.GREEN);
//   showDatabaseLayerByVocabName("{2___minor_damage}", Color.BLUE);
//   showDatabaseLayerByVocabName("{3___damaged}",  Color.YELLOW);
//   showDatabaseLayerByVocabName("{4___seriously_damaged}", Color.parseColor("#FFA500"));//FFA500 is orange in hex
//   showDatabaseLayerByVocabName("{5___extinct_or_near_extinct}", Color.RED);
//   showDatabaseLayerByVocabName("{NA}",  Color.BLACK);
//   */
//   String refMap = "Control/Map/Map";
//   isEntity = true;
//   queryName = "Burial Mound";
//   querySQL = "SELECT uuid, aenttimestamp FROM latestNonDeletedArchEnt join aenttype using (aenttypeid) where aenttypename = 'Burial Mound'";
//   ps = createPointStyle(10, Color.BLUE, 0.2f, 0.5f);
//   ls = createLineStyle(10, Color.BLUE, 0.05f, 0.3f, null);
//   pos = createPolygonStyle(10, Color.parseColor("#440000FF"), createLineStyle(10, Color.parseColor("#AA000000"), 0.01f, 0.3f, null));
//   ts = createTextStyle(10, Color.BLUE, 30, Typeface.SANS_SERIF);
//   showDatabaseLayer(refMap, "Burial Mound Layer", isEntity, queryName, querySQL, ps, ls, pos, ts);
//   setMapZoom(MAP_REF, 13.0f);
// }
// initMap();
/****************************** SEARCH EXTENSION ******************************/
/* Implements an extension to the search page which allows users to           */
/* constrain their searches by user.                                          */
/******************************************************************************/
populateDropDown("Control/Search/Entity_Types", entityTypes);

delOnEvent("Control/Search", "show", "search()");
addOnEvent("Control/Search", "show", "populateSelectUser()");
addOnEvent("Control/Search", "show", "populateDate()");
addOnEvent("Control/Search/Select_Author", "click", "search()");
addOnEvent("Control/Search/Select_Date", "click", "search()");
void populateDate(){
  String refSearchDate = "Control/Search/Select_Date";
  String getDatesQuery = "SELECT distinct strftime('%Y-%m-%d', createdat) as value,strftime('%Y-%m-%d', createdat) "+
                         "  FROM createdModifiedAtBy "+
                         " UNION "+
                         "SELECT '-1', '{All}'"+
                         " ORDER BY value";
  fetchAll(getDatesQuery, new FetchCallback() {
    onFetch(result) {
      populateDropDown(refSearchDate, result, false);
      // search();
    }
  });                        
}

void populateSelectUser(){
  String refSearchUsers = "Control/Search/Select_Author";
  String getNonDeletedUsersQuery = "SELECT userid, fname || ' ' || lname "+
                                   "  FROM user "+
                                   " WHERE userdeleted is null "+
                                   " UNION " +
                                   "SELECT -1, '{All}'";

  fetchAll(getNonDeletedUsersQuery, new FetchCallback() {
    onFetch(result) {
      populateDropDown(refSearchUsers, result, false);
      search();
    }
  });
}


// Overrides auto-generated definition
void search(){
  String tabgroup = "Control";
  String refEntityList  = tabgroup + "/Search/Entity_List";
  String refSearchTerm  = tabgroup + "/Search/Search_Term";
  String refEntityTypes = tabgroup + "/Search/Entity_Types";
  String refSelectUser  = tabgroup + "/Search/Select_Author";
  String refSelectDate  = tabgroup + "/Search/Select_Date";

  String type = getFieldValue(refEntityTypes);
  String term = getFieldValue(refSearchTerm);
  String user = getFieldValue(refSelectUser);
  String date = getFieldValue(refSelectDate);

  if (isNull(user)) return;
  String searchQuery = "SELECT uuid, response " +
                       "  FROM latestNonDeletedArchEntFormattedIdentifiers  " +
                       " WHERE uuid in (SELECT uuid " +
                       "                  FROM latestNonDeletedArchEntIdentifiers " +
                       "                 WHERE measure LIKE '{term}%'  " +
                       "                   AND ( aenttypename LIKE '{type}' OR '' = '{type}' ) " +
                       "                   AND ( userid = {user} OR -1 = {user}) " +
                       "                   AND ( strftime('%Y-%m-%d', aenttimestamp) = '{date}' OR '-1' = '{date}') " +
                       "                ) " +
                       " ORDER BY response " +
                       " LIMIT ? " +
                       "OFFSET ? ";
  searchQuery = replaceFirst(searchQuery, "{term}", term);
  searchQuery = replaceFirst(searchQuery, "{type}", type);
  searchQuery = replaceFirst(searchQuery, "{type}", type);
  searchQuery = replaceFirst(searchQuery, "{user}", user);
  searchQuery = replaceFirst(searchQuery, "{user}", user);
  searchQuery = replaceFirst(searchQuery, "{date}", date);
  searchQuery = replaceFirst(searchQuery, "{date}", date);

  populateCursorList(refEntityList, searchQuery, 25);
  refreshTabgroupCSS(tabgroup);

  Log.d("Module", "Search query: " + searchQuery);
}
/****************************** RECENT RECORDS EXTENSION **********************/
/* Provides list of most recent entities on device  			              */
/******************************************************************************/

final String RECENT_TABGROUP = "Control";
final String RECENT_TAB = "Recent";
final String RECENT_LIST = RECENT_TABGROUP+"/"+RECENT_TAB+"/Recent_records";

//fetchOne is to run a query
//TAB_GROUPS_AS_LIST is the set of tabgroups
//NODATA_TAB_GROUPS 
void setupRecentList(){

	recentListQuery = 	"CREATE TABLE IF NOT EXISTS recent(" +
						"  UUID INTEGER PRIMARY KEY, "+
						"  TIMESTAMP timestamp DEFAULT CURRENT_TIMESTAMP, "+
						"  identifier text NOT NULL "+
				 	 	");";
	fetchOne(recentListQuery);				 	 	
	// for ( tabgroup : TAB_GROUPS_AS_LIST ){
	// 	if (! isNull(tabgroup)){
	// 		Log.i("addToRecent", tabgroup);
	// 		if (! NODATA_TAB_GROUPS.contains(tabgroup)){
	// 			Log.i("addToRecent", "added "+tabgroup);
	// 			//If the tabgroup is a saving tabgroup
	// 			addOnEvent(tabgroup, "save", "addToRecent()");
	// 		}
	// 	}
	// }
}
setupRecentList();

// void addToRecent(){
// 	currentUUID = getUuid();
// 	if (! isNull(currentUUID)){
// 		String recentQuery 	= "REPLACE INTO recent(uuid, identifier) SELECT uuid, response " +
// 		                     "  FROM latestNonDeletedArchEntFormattedIdentifiers  " +
// 		                     " WHERE uuid = {uuid} ";
// 		recentQuery 		= dbReplaceFirst(recentQuery, "{uuid}", currentUUID);
// 		fetchOne(recentQuery);
// 	}
// 	//insertIntoLocalSettings	                     
// }


addOnEvent(RECENT_TABGROUP+"/"+RECENT_TAB, "show", "regenerateRecent()");

addOnEvent(RECENT_LIST, "click", "loadEntity()");


void populateRecent(){
	String recentQuery = "SELECT uuid, identifier " +
	                     "  FROM recent  " +	                     
//	                     " WHERE aenttypename not like '%point' "+
	                     " ORDER BY timestamp DESC "+
	                     " LIMIT ? " +
                       	 "OFFSET ? ";
	

	populateCursorList(RECENT_LIST, recentQuery, 15);
  //refreshTabgroupCSS("Control");


}
                     
void regenerateRecent(){
	String recentRegenQuery = "REPLACE INTO recent(uuid, timestamp, identifier) SELECT uuid, modifiedat, response " +
		                      "  FROM latestNonDeletedArchEntFormattedIdentifiers JOIN createdmodifiedatby using (uuid) ";
		                     	
	fetchOne(recentRegenQuery, new FetchCallback() {
    	onFetch(result) {
    		populateRecent();
      	}
  });
}

/* ************** Delete child entities ********************* */




// replacing reallyDeleteRecord so we have a deleted uuid to reference

String LAST_DELETED_UUID;

void reallyDeleteRecord(String tabgroup) {
  DeleteCallback callback = new DeleteCallback() {
    onDelete(uuid) {
      
      populateEntityListsOfArchEnt(tabgroup);
      executeOnEvent(tabgroup, "delete");
    }

    onError(message) {
      showToast(message);
    }
  };
  LAST_DELETED_UUID = getUuid(tabgroup);

  deleteChildren(LAST_DELETED_UUID);
  deleteArchEnt(getUuid(tabgroup), callback);
  cancelTabGroup(tabgroup, false);
  deleteFromRecent(LAST_DELETED_UUID);
}



// void setupCascadeDelete(){

         
//   for ( tabgroup : TAB_GROUPS_AS_LIST ){
//     if (! isNull(tabgroup)){
      
//       if (! NODATA_TAB_GROUPS.contains(tabgroup)){
//         if (! tabgroup.contains("point") && (! tabgroup.contains("Scar"))){
//           //If the tabgroup is a saving tabgroup
//           Log.i("deleteChildren", tabgroup);
//           addOnEvent(tabgroup, "delete", "deleteChildren()");}
//       }
//     }
//   }
// }
// setupCascadeDelete();
void deleteFromRecent(String last_deleted){
  
  if (! isNull(last_deleted)){
    String recentQuery  = "DELETE FROM recent " +                         
                         " WHERE uuid = {uuid} ";
    recentQuery     = dbReplaceFirst(recentQuery, "{uuid}", last_deleted);
    fetchOne(recentQuery);
  }
}
void deleteChildren(String last_deleted){
  currentUUID = last_deleted;
  if (isNull(currentUUID)){
    Log.e("deleteChildren", "UUID NOT FOUND");
    
  } else {
    Log.i("deleteChildren", "Starting delete children on "+ currentUUID);
    String childrenQuery  = "SELECT childuuid, relationshipid "+
                            "  FROM parentchild "+
                            " WHERE parentuuid = {uuid} "+
                            "   AND parentparticipatesverb = 'Parent Of' ";
    childrenQuery     = dbReplaceFirst(childrenQuery, "{uuid}", currentUUID);
    fetchAll(childrenQuery, new FetchCallback() {
      onFetch(result) {
        for (row : result){
          Log.w("deleteChildren", "Deleting child"+row);
          deleteArchEnt(row.get(0));
          deleteRel(row.get(1));
          deleteFromRecent(row.get(0));
        }
      }
      
      onError(message) {
        showToast(message);
      }
    });
  }
}

for (String ref : getRefsMatching("*/Find_This_in_The_Map"))
  addOnEvent(ref, "click", "findThisInTheMap()");

boolean findThisInTheMap() {
  String EasStr = getFieldValue(CURRENTLY_DISPLAYED_TAB+"/Easting");
  String norStr = getFieldValue(CURRENTLY_DISPLAYED_TAB+"/Northing");
  boolean isFindable = !isNull(EasStr) && !isNull(norStr);
  if (!isFindable) {
    String head = "";
    String body = "";
    head += "Cannot Find Point in Map";
    body += "The 'Northing' and 'Easting' fields must be filled in. Please ";
    body += "tap the 'Take From GPS' button to do so.";
    showWarning(head, body);
    return false;
  }
  double easDub = Double.parseDouble(EasStr);
  double norDub = Double.parseDouble(norStr);
  setMapFocusPoint(MAP_REF, easDub, norDub);
  return true;
}


/* Validates autonumbering when entering the control tab */

void validateAutonumbering(){
	startingIDs = getStartingIdRefs();
	try{
		for ( id : startingIDs ){
			Log.d("validateAutonumbering", " "+isNull(id));
	    	Log.d("validateAutonumbering", " "+Integer.parseInt(getFieldValue(id)));
			if (isNull(id) || Integer.parseInt(getFieldValue(id)) < 1){
				Log.e("getFieldValue(id)", getFieldValue(id));
				showWarning("Identifier Warning", "One or more of your identifiers is blank or not a positive number!");

			}

		}
	} catch (Exception e){
		showWarning("Identifier Warning", "One or more of your identifiers is problematic!");			
	}
}

addOnEvent("Control/Autonumbering", "leave", "validateAutonumbering()");
/****************************** Leave GPS EXTENSION **********************/
/* Detects if user leaves GPS tab without pushing take from gps          */
/*************************************************************************/

for (String ref : getRefsMatching("*/General/Find_This_in_The_Map"))
  addOnEvent(getTabRef(ref), "leave", "validateTabGps()");

void validateTabGps(){
	current_tab = getPreviouslyDisplayedTab();
	Log.d("validateTabGPS", current_tab);
	Log.d("validateTabGPS", "isNull(current_tab+/Latitude)"+ isNull(current_tab+"/Latitude"));

	if (!isValidField(current_tab+"/Latitude") || !isValidField(current_tab+"/Longitude")) {
		showWarning("Missing Location!", "Make sure you add location data to this entity!");
	}

} 


/******************************************************************************/
/*                                    INIT                                    */
/*                                                                            */
/* Stuff which needs to be done last.                                         */
/******************************************************************************/
bindOnEvents();
decAndExecIfModuleLoaded();
